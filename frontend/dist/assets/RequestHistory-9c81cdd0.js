import{_ as J,r as i,S as de,o as c,c as b,N as pe,J as z,w as l,d as t,f as s,t as m,R as F,q as v,v as L,x as _e,b as y,C as Y,e as g,E as j,B}from"./index-054e2682.js";import{b as ce,d as me}from"./api-testing-1acf99db.js";const ve={class:"history-table"},ye={__name:"HistoryTable",props:{data:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1}},emits:["view-detail","retry-request","selection-change","delete-item"],setup(R){const T=r=>({GET:"success",POST:"primary",PUT:"warning",DELETE:"danger",PATCH:"info"})[r]||"info",V=r=>r>=200&&r<300?"success":r>=300&&r<400?"warning":r>=400?"danger":"info",D=r=>F(r).format("MM-DD HH:mm");return(r,d)=>{const p=i("el-table-column"),w=i("el-tag"),k=i("el-button"),q=i("el-table"),o=de("loading");return c(),b("div",ve,[pe((c(),z(q,{data:R.data,style:{width:"100%"},onSelectionChange:d[0]||(d[0]=n=>r.$emit("selection-change",n))},{default:l(()=>[t(p,{type:"selection",width:"55",align:"center"}),t(p,{prop:"request.name",label:"请求名称","min-width":"200"}),t(p,{prop:"request.method",label:"方法",width:"80"},{default:l(n=>[t(w,{type:T(n.row.request.method),size:"small"},{default:l(()=>[s(m(n.row.request.method),1)]),_:2},1032,["type"])]),_:1}),t(p,{prop:"request_data.url",label:"URL","min-width":"300","show-overflow-tooltip":""}),t(p,{prop:"status_code",label:"状态码",width:"100"},{default:l(n=>[n.row.status_code?(c(),z(w,{key:0,type:V(n.row.status_code),size:"small"},{default:l(()=>[s(m(n.row.status_code),1)]),_:2},1032,["type"])):(c(),z(w,{key:1,type:"danger",size:"small"},{default:l(()=>d[1]||(d[1]=[s("错误",-1)])),_:1,__:[1]}))]),_:1}),t(p,{prop:"response_time",label:"响应时间",width:"100"},{default:l(n=>{var _;return[s(m(((_=n.row.response_time)==null?void 0:_.toFixed(0))||0)+"ms ",1)]}),_:1}),t(p,{prop:"environment.name",label:"环境",width:"120"},{default:l(n=>{var _;return[s(m(((_=n.row.environment)==null?void 0:_.name)||"无环境"),1)]}),_:1}),t(p,{prop:"executed_by.username",label:"执行者",width:"120"}),t(p,{prop:"executed_at",label:"执行时间",width:"160"},{default:l(n=>[s(m(D(n.row.executed_at)),1)]),_:1}),t(p,{label:"操作",width:"200",fixed:"right"},{default:l(n=>[t(k,{link:"",type:"primary",onClick:_=>r.$emit("view-detail",n.row),size:"small"},{default:l(()=>d[2]||(d[2]=[s(" 查看详情 ",-1)])),_:2,__:[2]},1032,["onClick"]),t(k,{link:"",type:"primary",onClick:_=>r.$emit("retry-request",n.row),size:"small"},{default:l(()=>d[3]||(d[3]=[s(" 重新发送 ",-1)])),_:2,__:[3]},1032,["onClick"]),t(k,{link:"",type:"danger",onClick:_=>r.$emit("delete-item",n.row),size:"small"},{default:l(()=>d[4]||(d[4]=[s(" 删除 ",-1)])),_:2,__:[4]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[o,R.loading]])])}}},A=J(ye,[["__scopeId","data-v-6dc974eb"]]);const fe={class:"request-history"},ge={class:"header"},be={class:"filters"},we={key:0,class:"history-detail"},he={class:"detail-section"},Te={key:0},qe={key:2},ke={key:3,class:"json-content"},Ce={key:0,class:"detail-section"},xe={class:"response-actions"},He={class:"json-content"},Ve={key:1,class:"error-section"},De={key:2,class:"empty-response"},Be={__name:"RequestHistory",setup(R){const T=v("HTTP"),V=v([]),D=v([]),r=v(!1),d=v(""),p=v(1),w=v(20),k=v(0),q=v(!1),o=v(null),n=v("request"),_=v([]);L(()=>T.value==="HTTP"?V.value:D.value);const E=L(()=>{var a;if(!((a=o.value)!=null&&a.response_data))return"";try{return o.value.response_data.json?JSON.stringify(o.value.response_data.json,null,2):o.value.response_data.body||""}catch{return o.value.response_data.body||""}}),G=a=>({GET:"success",POST:"primary",PUT:"warning",DELETE:"danger",PATCH:"info"})[a]||"info",W=a=>a?a>=200&&a<300?"success":a>=300&&a<400?"warning":a>=400?"danger":"info":"info",Q=a=>F(a).format("YYYY-MM-DD HH:mm:ss"),M=a=>!a||typeof a!="object"?[]:Object.keys(a).map(e=>({key:e,value:a[e]})),h=async()=>{r.value=!0;try{const a={page:p.value,page_size:w.value,request__request_type:T.value};d.value&&(a.search=d.value);const e=await Y.get("/api-testing/histories/",{params:a}),f=e.data.results||e.data;T.value==="HTTP"?V.value=f:D.value=f,k.value=e.data.count||f.length}catch(a){g.error("加载请求历史失败"),console.error(a)}finally{r.value=!1}},X=()=>{p.value=1,_.value=[],h()},Z=a=>{w.value=a,h()},ee=a=>{p.value=a,h()},U=a=>{o.value=a,n.value="request",q.value=!0},P=async a=>{var e;try{const f=await Y.post(`/api-testing/requests/${a.request.id}/execute/`,{environment_id:(e=a.environment)==null?void 0:e.id});g.success("请求重新发送成功"),q.value=!1,await h()}catch(f){g.error("请求重新发送失败"),console.error(f)}},te=async()=>{try{await j.confirm("确定要清空所有请求历史吗？此操作不可恢复。","确认清空",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),g.warning("清空功能暂未实现，请使用批量删除")}catch(a){a!=="cancel"&&console.error(a)}},O=a=>{_.value=a.map(e=>e.id)},N=a=>{j.confirm("确认删除该请求历史吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await me(a.id),g.success("删除成功"),h()}catch(e){console.error("删除失败:",e),g.error("删除失败")}})},ae=()=>{_.value.length!==0&&j.confirm(`确认删除选中的 ${_.value.length} 条记录吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await ce(_.value),g.success("批量删除成功"),_.value=[],h()}catch(a){console.error("批量删除失败:",a),g.error("批量删除失败")}})},le=()=>{var a,e;(e=(a=o.value)==null?void 0:a.response_data)!=null&&e.json},oe=()=>{E.value&&(navigator.clipboard.writeText(E.value),g.success("已复制到剪贴板"))};return _e(()=>{h()}),(a,e)=>{const f=i("el-input"),C=i("el-button"),S=i("el-tab-pane"),I=i("el-tabs"),ne=i("el-pagination"),x=i("el-descriptions-item"),K=i("el-tag"),se=i("el-descriptions"),H=i("el-table-column"),$=i("el-table"),re=i("el-alert"),ue=i("el-empty"),ie=i("el-dialog");return c(),b("div",fe,[y("div",ge,[e[11]||(e[11]=y("h3",null,"请求历史",-1)),y("div",be,[t(f,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=u=>d.value=u),placeholder:"搜索请求",style:{width:"200px"},clearable:"",onInput:h},null,8,["modelValue"]),t(C,{type:"danger",disabled:_.value.length===0,onClick:ae},{default:l(()=>e[9]||(e[9]=[s(" 批量删除 ",-1)])),_:1,__:[9]},8,["disabled"]),t(C,{onClick:te,type:"danger",plain:""},{default:l(()=>e[10]||(e[10]=[s(" 清空历史 ",-1)])),_:1,__:[10]})])]),t(I,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=u=>T.value=u),onTabChange:X},{default:l(()=>[t(S,{label:"HTTP请求",name:"HTTP"},{default:l(()=>[t(A,{data:V.value,loading:r.value,onViewDetail:U,onRetryRequest:P,onSelectionChange:O,onDeleteItem:N},null,8,["data","loading"])]),_:1}),t(S,{label:"WebSocket请求",name:"WEBSOCKET"},{default:l(()=>[t(A,{data:D.value,loading:r.value,onViewDetail:U,onRetryRequest:P,onSelectionChange:O,onDeleteItem:N},null,8,["data","loading"])]),_:1})]),_:1},8,["modelValue"]),t(ne,{"current-page":p.value,"onUpdate:currentPage":e[2]||(e[2]=u=>p.value=u),"page-size":w.value,"onUpdate:pageSize":e[3]||(e[3]=u=>w.value=u),"page-sizes":[10,20,50,100],total:k.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Z,onCurrentChange:ee,class:"pagination"},null,8,["current-page","page-size","total"]),t(ie,{modelValue:q.value,"onUpdate:modelValue":e[8]||(e[8]=u=>q.value=u),title:"请求详情",width:"80%",top:"5vh"},{footer:l(()=>[t(C,{onClick:e[6]||(e[6]=u=>q.value=!1)},{default:l(()=>e[19]||(e[19]=[s("关闭",-1)])),_:1,__:[19]}),t(C,{type:"primary",onClick:e[7]||(e[7]=u=>P(o.value))},{default:l(()=>e[20]||(e[20]=[s(" 重新发送 ",-1)])),_:1,__:[20]})]),default:l(()=>[o.value?(c(),b("div",we,[t(se,{title:"基本信息",column:2,border:""},{default:l(()=>[t(x,{label:"请求名称"},{default:l(()=>[s(m(o.value.request.name),1)]),_:1}),t(x,{label:"请求方法"},{default:l(()=>[t(K,{type:G(o.value.request.method)},{default:l(()=>[s(m(o.value.request.method),1)]),_:1},8,["type"])]),_:1}),t(x,{label:"状态码"},{default:l(()=>[t(K,{type:W(o.value.status_code)},{default:l(()=>[s(m(o.value.status_code||"无响应"),1)]),_:1},8,["type"])]),_:1}),t(x,{label:"响应时间"},{default:l(()=>{var u;return[s(m(((u=o.value.response_time)==null?void 0:u.toFixed(0))||0)+"ms ",1)]}),_:1}),t(x,{label:"执行时间"},{default:l(()=>[s(m(Q(o.value.executed_at)),1)]),_:1}),t(x,{label:"执行者"},{default:l(()=>[s(m(o.value.executed_by.username),1)]),_:1})]),_:1}),t(I,{modelValue:n.value,"onUpdate:modelValue":e[5]||(e[5]=u=>n.value=u),class:"detail-tabs"},{default:l(()=>[t(S,{label:"请求信息",name:"request"},{default:l(()=>[y("div",he,[e[12]||(e[12]=y("h4",null,"请求URL",-1)),t(f,{modelValue:o.value.request_data.url,"onUpdate:modelValue":e[4]||(e[4]=u=>o.value.request_data.url=u),readonly:""},null,8,["modelValue"]),e[13]||(e[13]=y("h4",null,"请求头",-1)),t($,{data:M(o.value.request_data.headers),style:{width:"100%"}},{default:l(()=>[t(H,{prop:"key",label:"Key",width:"200"}),t(H,{prop:"value",label:"Value"})]),_:1},8,["data"]),o.value.request_data.params&&Object.keys(o.value.request_data.params).length>0?(c(),b("h4",Te," 请求参数 ")):B("",!0),o.value.request_data.params&&Object.keys(o.value.request_data.params).length>0?(c(),z($,{key:1,data:M(o.value.request_data.params),style:{width:"100%"}},{default:l(()=>[t(H,{prop:"key",label:"Key",width:"200"}),t(H,{prop:"value",label:"Value"})]),_:1},8,["data"])):B("",!0),o.value.request_data.body?(c(),b("h4",qe,"请求体")):B("",!0),o.value.request_data.body?(c(),b("pre",ke,"                "+m(JSON.stringify(o.value.request_data.body,null,2))+`
              `,1)):B("",!0)])]),_:1}),t(S,{label:"响应信息",name:"response"},{default:l(()=>[o.value.response_data?(c(),b("div",Ce,[e[16]||(e[16]=y("h4",null,"响应头",-1)),t($,{data:M(o.value.response_data.headers),style:{width:"100%"}},{default:l(()=>[t(H,{prop:"key",label:"Key",width:"200"}),t(H,{prop:"value",label:"Value"})]),_:1},8,["data"]),e[17]||(e[17]=y("h4",null,"响应体",-1)),y("div",xe,[t(C,{size:"small",onClick:le},{default:l(()=>e[14]||(e[14]=[s("格式化",-1)])),_:1,__:[14]}),t(C,{size:"small",onClick:oe},{default:l(()=>e[15]||(e[15]=[s("复制",-1)])),_:1,__:[15]})]),y("pre",He,m(E.value),1)])):o.value.error_message?(c(),b("div",Ve,[e[18]||(e[18]=y("h4",null,"错误信息",-1)),t(re,{title:o.value.error_message,type:"error",closable:!1,"show-icon":""},null,8,["title"])])):(c(),b("div",De,[t(ue,{description:"无响应数据"})]))]),_:1})]),_:1},8,["modelValue"])])):B("",!0)]),_:1},8,["modelValue"])])}}},Re=J(Be,[["__scopeId","data-v-10b287ae"]]);export{Re as default};
