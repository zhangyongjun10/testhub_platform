import{_ as _e,u as me,q as u,V as P,x as ve,r as c,o as n,c as i,b as r,d as o,w as a,F as f,y as k,B as L,C as w,e as _,g as M,D as J,f as m,J as C,t as v,H as fe,R as ke}from"./index-054e2682.js";const ye={class:"page-container"},he={class:"page-header"},ge={class:"filter-bar"},we={class:"templates-grid"},je={class:"card-header"},Ve={class:"template-name"},be={class:"card-actions"},Ce={class:"template-content"},Te={class:"template-info"},Ue={class:"info-item"},Re={class:"info-value"},xe={class:"info-item"},$e={class:"info-value"},De={class:"info-item"},Fe={class:"info-value"},Be={class:"template-description"},qe={class:"template-checklist"},Ae={key:0},Ie={key:0,class:"more-items"},Le={key:1,class:"empty-checklist"},Me={class:"template-reviewers"},Ne={class:"reviewers-list"},Ye={key:0,class:"empty-reviewers"},ze={key:0,class:"empty-templates"},Ee={class:"checklist-editor"},He={__name:"ReviewTemplateList",setup(Pe){const S=me(),U=u([]),R=u([]),x=u([]),$=u(!1),y=u(!1),D=u(),F=u(!1),j=u(!1),B=u(null),V=P({project:""}),s=P({name:"",description:"",project:"",checklist:[""],default_reviewers:[]}),G={name:[{required:!0,message:"请输入模板名称",trigger:"blur"}],project:[{required:!0,message:"请选择项目",trigger:"change"}]},T=async()=>{$.value=!0;try{const l={};V.project&&(l.project=V.project);const e=await w.get("/reviews/review-templates/",{params:l});U.value=e.data.results||e.data||[]}catch{_.error("获取模板列表失败")}finally{$.value=!1}},K=async()=>{try{const l=await w.get("/projects/");R.value=l.data.results||l.data||[]}catch{_.error("获取项目列表失败")}},O=async()=>{try{const l=await w.get("/auth/users/");x.value=l.data.results||l.data||[]}catch(l){console.error("获取用户列表失败:",l),_.error("获取用户列表失败"),x.value=[]}},Q=()=>{j.value=!1,te(),y.value=!0},W=l=>{j.value=!0,B.value=l.id,s.name=l.name,s.description=l.description,Array.isArray(l.project)&&l.project.length>0?s.project=l.project[0].id:l.project&&l.project.id?s.project=l.project.id:s.project="",s.checklist=l.checklist.length?[...l.checklist]:[""],s.default_reviewers=l.default_reviewers.map(e=>e.id),y.value=!0},X=l=>{S.push({path:"/reviews/create",query:{template:l.id}})},Z=async()=>{if(D.value)try{await D.value.validate(),F.value=!0;const l={...s,checklist:s.checklist.filter(e=>e.trim()),project:s.project?[s.project]:[]};j.value?(await w.put(`/reviews/review-templates/${B.value}/`,l),_.success("模板更新成功")):(await w.post("/reviews/review-templates/",l),_.success("模板创建成功")),y.value=!1,T()}catch(l){console.error("保存模板失败:",l),_.error(j.value?"模板更新失败":"模板创建失败")}finally{F.value=!1}},ee=async l=>{try{await w.delete(`/reviews/review-templates/${l}/`),_.success("删除成功"),T()}catch{_.error("删除失败")}},te=()=>{s.name="",s.description="",s.project="",s.checklist=[""],s.default_reviewers=[],B.value=null},le=()=>{s.checklist.push("")},se=l=>{s.checklist.length>1&&s.checklist.splice(l,1)},oe=l=>{l&&(s.default_reviewers=[])},ae=l=>ke(l).format("YYYY-MM-DD HH:mm");return ve(()=>{T(),K(),O()}),(l,e)=>{const N=c("el-icon"),p=c("el-button"),q=c("el-option"),A=c("el-select"),h=c("el-form-item"),Y=c("el-form"),re=c("el-popconfirm"),ne=c("el-tag"),ie=c("el-card"),ce=c("el-empty"),I=c("el-input"),z=c("el-col"),de=c("el-row"),ue=c("el-dialog");return n(),i("div",ye,[r("div",he,[e[8]||(e[8]=r("h1",{class:"page-title"},"评审模板",-1)),r("div",null,[o(p,{type:"primary",onClick:Q},{default:a(()=>[o(N,null,{default:a(()=>[o(M(J))]),_:1}),e[7]||(e[7]=m(" 创建模板 ",-1))]),_:1,__:[7]})])]),r("div",ge,[o(Y,{inline:!0,model:V,class:"filter-form"},{default:a(()=>[o(h,{label:"项目"},{default:a(()=>[o(A,{modelValue:V.project,"onUpdate:modelValue":e[0]||(e[0]=t=>V.project=t),placeholder:"请选择项目",clearable:"",onChange:T},{default:a(()=>[(n(!0),i(f,null,k(R.value,t=>(n(),C(q,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),r("div",we,[(n(!0),i(f,null,k(U.value,t=>(n(),C(ie,{key:t.id,class:"template-card",shadow:"hover"},{header:a(()=>[r("div",je,[r("span",Ve,v(t.name),1),r("div",be,[o(p,{link:"",type:"primary",onClick:d=>X(t)},{default:a(()=>e[9]||(e[9]=[m("使用",-1)])),_:2,__:[9]},1032,["onClick"]),o(p,{link:"",type:"warning",onClick:d=>W(t)},{default:a(()=>e[10]||(e[10]=[m("编辑",-1)])),_:2,__:[10]},1032,["onClick"]),o(re,{title:"确定要删除这个模板吗？",onConfirm:d=>ee(t.id)},{reference:a(()=>[o(p,{link:"",type:"danger"},{default:a(()=>e[11]||(e[11]=[m("删除",-1)])),_:1,__:[11]})]),_:2},1032,["onConfirm"])])])]),default:a(()=>{var d,b,E,H;return[r("div",Ce,[r("div",Te,[r("div",Ue,[e[12]||(e[12]=r("span",{class:"info-label"},"项目:",-1)),r("span",Re,v(Array.isArray(t.project)?t.project.map(g=>g.name).join(", "):((d=t.project)==null?void 0:d.name)||"未设置"),1)]),r("div",xe,[e[13]||(e[13]=r("span",{class:"info-label"},"创建人:",-1)),r("span",$e,v((b=t.creator)==null?void 0:b.username),1)]),r("div",De,[e[14]||(e[14]=r("span",{class:"info-label"},"创建时间:",-1)),r("span",Fe,v(ae(t.created_at)),1)])]),r("div",Be,v(t.description||"暂无描述"),1),r("div",qe,[e[15]||(e[15]=r("div",{class:"checklist-title"},"检查清单:",-1)),(E=t.checklist)!=null&&E.length?(n(),i("ul",Ae,[(n(!0),i(f,null,k(t.checklist.slice(0,3),(g,pe)=>(n(),i("li",{key:pe},v(g),1))),128)),t.checklist.length>3?(n(),i("li",Ie," 还有 "+v(t.checklist.length-3)+" 项... ",1)):L("",!0)])):(n(),i("div",Le,"暂无检查清单"))]),r("div",Me,[e[16]||(e[16]=r("div",{class:"reviewers-title"},"默认评审人:",-1)),r("div",Ne,[(n(!0),i(f,null,k(t.default_reviewers,g=>(n(),C(ne,{key:g.id,size:"small",class:"reviewer-tag"},{default:a(()=>[m(v(g.username),1)]),_:2},1024))),128)),(H=t.default_reviewers)!=null&&H.length?L("",!0):(n(),i("span",Ye," 未设置默认评审人 "))])])])]}),_:2},1024))),128)),!U.value.length&&!$.value?(n(),i("div",ze,[o(ce,{description:"暂无评审模板"})])):L("",!0)]),o(ue,{modelValue:y.value,"onUpdate:modelValue":e[6]||(e[6]=t=>y.value=t),title:j.value?"编辑模板":"创建模板",width:"800px"},{footer:a(()=>[o(p,{onClick:e[5]||(e[5]=t=>y.value=!1)},{default:a(()=>e[18]||(e[18]=[m("取消",-1)])),_:1,__:[18]}),o(p,{type:"primary",onClick:Z,loading:F.value},{default:a(()=>e[19]||(e[19]=[m("保存",-1)])),_:1,__:[19]},8,["loading"])]),default:a(()=>[o(Y,{model:s,rules:G,ref_key:"templateFormRef",ref:D,"label-width":"120px"},{default:a(()=>[o(de,{gutter:24},{default:a(()=>[o(z,{span:12},{default:a(()=>[o(h,{label:"模板名称",prop:"name"},{default:a(()=>[o(I,{modelValue:s.name,"onUpdate:modelValue":e[1]||(e[1]=t=>s.name=t),placeholder:"请输入模板名称"},null,8,["modelValue"])]),_:1})]),_:1}),o(z,{span:12},{default:a(()=>[o(h,{label:"关联项目",prop:"project"},{default:a(()=>[o(A,{modelValue:s.project,"onUpdate:modelValue":e[2]||(e[2]=t=>s.project=t),placeholder:"请选择项目",onChange:oe},{default:a(()=>[(n(!0),i(f,null,k(R.value,t=>(n(),C(q,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(h,{label:"模板描述"},{default:a(()=>[o(I,{modelValue:s.description,"onUpdate:modelValue":e[3]||(e[3]=t=>s.description=t),type:"textarea",rows:3,placeholder:"请输入模板描述"},null,8,["modelValue"])]),_:1}),o(h,{label:"检查清单"},{default:a(()=>[r("div",Ee,[(n(!0),i(f,null,k(s.checklist,(t,d)=>(n(),i("div",{key:d,class:"checklist-item"},[o(I,{modelValue:s.checklist[d],"onUpdate:modelValue":b=>s.checklist[d]=b,placeholder:"请输入检查项"},null,8,["modelValue","onUpdate:modelValue"]),o(p,{type:"danger",size:"small",onClick:b=>se(d),icon:M(fe)},null,8,["onClick","icon"])]))),128)),o(p,{type:"primary",size:"small",onClick:le},{default:a(()=>[o(N,null,{default:a(()=>[o(M(J))]),_:1}),e[17]||(e[17]=m(" 添加检查项 ",-1))]),_:1,__:[17]})])]),_:1}),o(h,{label:"默认评审人"},{default:a(()=>[o(A,{modelValue:s.default_reviewers,"onUpdate:modelValue":e[4]||(e[4]=t=>s.default_reviewers=t),multiple:"",placeholder:"请选择默认评审人"},{default:a(()=>[(n(!0),i(f,null,k(x.value,t=>(n(),C(q,{key:t.id,label:t.username,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Se=_e(He,[["__scopeId","data-v-8e37df51"]]);export{Se as default};
