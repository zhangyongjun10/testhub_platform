import{_ as be,q as b,V as P,x as we,e as f,r as i,S as Ve,o as u,c as U,b as d,d as l,w as a,N as Te,J as p,g as X,D as ke,f as r,t as w,B as V,i as Ce,F as I,y as D,E as Ee}from"./index-054e2682.js";import{Q as Se,b as Ue,R as xe,D as Ne,s as Ae,S as Ie,T as De,U as je,V as ze,W as Oe,X as Re}from"./ui_automation-53e326f9.js";const qe={class:"scheduled-tasks"},Pe={class:"header"},Fe={class:"filters"},Le={class:"task-list"},Be={key:1},he={class:"pagination"},Me={class:"cron-help"},$e={__name:"ScheduledTasks",setup(We){const F=b([]),L=b([]),B=b([]),h=b([]),M=b([]),j=b(!1),z=b(!1),S=b(!1),C=b(null),T=P({task_type:"",trigger_type:"",status:""}),k=P({current:1,size:10,total:0}),o=P({name:"",description:"",project:"",task_type:"TEST_SUITE",trigger_type:"CRON",cron_expression:"0 0 * * *",interval_seconds:3600,execute_at:"",test_suite:"",test_cases:[],engine:"playwright",browser:"chrome",headless:!1,notify_on_success:!1,notify_on_failure:!1,notification_type:"",notify_emails:[]});we(()=>{y(),G(),H()});const y=async()=>{j.value=!0;try{const n={page:k.current,page_size:k.size,...T},e=await Se(n);F.value=e.data.results,k.total=e.data.count}catch{f.error("加载任务列表失败")}finally{j.value=!1}},G=async()=>{try{const n=await Ue();L.value=n.data.results}catch(n){console.error("加载项目列表失败:",n)}},H=async()=>{try{const n=await xe(),e=n.data.results||n.data;M.value=e.map(m=>({...m,display_name:m.first_name?`${m.first_name}（${m.email}）`:`${m.username}（${m.email}）`}))}catch(n){console.error("加载用户列表失败:",n)}},$=async n=>{if(n)try{const e=await Ne({project:n});B.value=e.data.results;const m=await Ae({project:n});h.value=m.data.results}catch(e){console.error("加载项目数据失败:",e)}},K=()=>{o.test_suite="",o.test_cases=[]},Y=()=>{C.value=null,W(),S.value=!0},W=()=>{Object.assign(o,{name:"",description:"",project:"",task_type:"TEST_SUITE",trigger_type:"CRON",cron_expression:"0 0 * * *",interval_seconds:3600,execute_at:"",test_suite:"",test_cases:[],engine:"playwright",browser:"chrome",headless:!1,notify_on_success:!1,notify_on_failure:!1,notification_type:"",notify_emails:[]})},Z=()=>{Object.assign(T,{task_type:"",trigger_type:"",status:""}),y()},ee=async()=>{var n,e,m,c;z.value=!0;try{const s={name:o.name,description:o.description,project:o.project,task_type:o.task_type,trigger_type:o.trigger_type,engine:o.engine,browser:o.browser,headless:o.headless,notify_on_success:o.notify_on_success,notify_on_failure:o.notify_on_failure};(o.notify_on_success||o.notify_on_failure)&&(o.notification_type&&(s.notification_type=o.notification_type),o.notify_emails&&o.notify_emails.length>0&&(s.notify_emails=o.notify_emails)),o.trigger_type==="CRON"?s.cron_expression=o.cron_expression:o.trigger_type==="INTERVAL"?s.interval_seconds=o.interval_seconds:o.trigger_type==="ONCE"&&(s.execute_at=o.execute_at),o.task_type==="TEST_SUITE"?s.test_suite=o.test_suite:o.task_type==="TEST_CASE"&&(s.test_cases=o.test_cases),C.value?(await Ie(C.value.id,s),f.success("更新任务成功")):(await De(s),f.success("创建任务成功")),S.value=!1,y()}catch(s){console.error("任务操作失败:",s),f.error(((e=(n=s.response)==null?void 0:n.data)==null?void 0:e.error)||((c=(m=s.response)==null?void 0:m.data)==null?void 0:c.detail)||(C.value?"更新任务失败":"创建任务失败"))}finally{z.value=!1}},te=async n=>{try{n.running=!0,await je(n.id),f.success("任务已开始执行"),setTimeout(()=>{y()},2e3)}catch{f.error("执行任务失败")}finally{n.running=!1}},J=n=>n?new Date(n).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-"):"-",le=n=>({邮箱通知:"",Webhook机器人:"primary",两者都发送:"warning"})[n]||"info",ae=(n,e)=>{switch(n){case"pause":ne(e);break;case"resume":se(e);break;case"edit":oe(e);break;case"delete":re(e);break}},oe=async n=>{C.value=n,Object.assign(o,{name:n.name,description:n.description,project:n.project,task_type:n.task_type,trigger_type:n.trigger_type,cron_expression:n.cron_expression,interval_seconds:n.interval_seconds,execute_at:n.execute_at,test_suite:n.test_suite||"",test_cases:n.test_cases||[],engine:n.engine||"playwright",browser:n.browser||"chrome",headless:n.headless||!1,notify_on_success:n.notify_on_success||!1,notify_on_failure:n.notify_on_failure||!1,notification_type:n.notification_type||"",notify_emails:n.notify_emails||[]}),n.project&&await $(n.project),S.value=!0},ne=async n=>{try{await ze(n.id),f.success("任务已暂停"),y()}catch(e){console.error("暂停任务失败:",e),f.error("暂停任务失败")}},se=async n=>{try{await Oe(n.id),f.success("任务已恢复"),y()}catch{f.error("恢复任务失败")}},re=async n=>{try{await Ee.confirm("确定要删除这个定时任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Re(n.id),f.success("删除任务成功"),y()}catch(e){e!=="cancel"&&f.error("删除任务失败")}};return(n,e)=>{const m=i("el-icon"),c=i("el-button"),s=i("el-option"),v=i("el-select"),N=i("el-col"),ie=i("el-row"),g=i("el-table-column"),x=i("el-tag"),A=i("el-dropdown-item"),ue=i("el-dropdown-menu"),de=i("el-dropdown"),_e=i("el-table"),pe=i("el-pagination"),O=i("el-input"),_=i("el-form-item"),E=i("el-radio"),R=i("el-radio-group"),me=i("el-tooltip"),fe=i("el-input-number"),ye=i("el-date-picker"),q=i("el-checkbox"),ce=i("el-form"),ge=i("el-dialog"),ve=Ve("loading");return u(),U("div",qe,[d("div",Pe,[e[25]||(e[25]=d("h3",null,"UI自动化定时任务",-1)),l(c,{type:"primary",onClick:Y},{default:a(()=>[l(m,null,{default:a(()=>[l(X(ke))]),_:1}),e[24]||(e[24]=r(" 新建定时任务 ",-1))]),_:1,__:[24]})]),d("div",Fe,[l(ie,{gutter:20},{default:a(()=>[l(N,{span:6},{default:a(()=>[l(v,{modelValue:T.task_type,"onUpdate:modelValue":e[0]||(e[0]=t=>T.task_type=t),placeholder:"任务类型",clearable:""},{default:a(()=>[l(s,{label:"测试套件执行",value:"TEST_SUITE"}),l(s,{label:"测试用例执行",value:"TEST_CASE"})]),_:1},8,["modelValue"])]),_:1}),l(N,{span:6},{default:a(()=>[l(v,{modelValue:T.trigger_type,"onUpdate:modelValue":e[1]||(e[1]=t=>T.trigger_type=t),placeholder:"触发器类型",clearable:""},{default:a(()=>[l(s,{label:"Cron表达式",value:"CRON"}),l(s,{label:"固定间隔",value:"INTERVAL"}),l(s,{label:"单次执行",value:"ONCE"})]),_:1},8,["modelValue"])]),_:1}),l(N,{span:6},{default:a(()=>[l(v,{modelValue:T.status,"onUpdate:modelValue":e[2]||(e[2]=t=>T.status=t),placeholder:"任务状态",clearable:""},{default:a(()=>[l(s,{label:"激活",value:"ACTIVE"}),l(s,{label:"暂停",value:"PAUSED"}),l(s,{label:"已完成",value:"COMPLETED"}),l(s,{label:"失败",value:"FAILED"})]),_:1},8,["modelValue"])]),_:1}),l(N,{span:6},{default:a(()=>[l(c,{onClick:Z},{default:a(()=>e[26]||(e[26]=[r("重置",-1)])),_:1,__:[26]}),l(c,{type:"primary",onClick:y},{default:a(()=>e[27]||(e[27]=[r("搜索",-1)])),_:1,__:[27]})]),_:1})]),_:1})]),d("div",Le,[Te((u(),p(_e,{data:F.value},{default:a(()=>[l(g,{prop:"name",label:"任务名称","min-width":"200"}),l(g,{prop:"task_type",label:"任务类型",width:"120"},{default:a(t=>[l(x,{type:t.row.task_type==="TEST_SUITE"?"success":"primary"},{default:a(()=>[r(w(t.row.task_type==="TEST_SUITE"?"测试套件":"测试用例"),1)]),_:2},1032,["type"])]),_:1}),l(g,{prop:"notification_type_display",label:"通知类型",width:"130"},{default:a(t=>[t.row.notification_type_display&&t.row.notification_type_display!=="-"?(u(),p(x,{key:0,type:le(t.row.notification_type_display),size:"small"},{default:a(()=>[r(w(t.row.notification_type_display),1)]),_:2},1032,["type"])):(u(),U("span",Be,"-"))]),_:1}),l(g,{prop:"trigger_type",label:"触发器类型",width:"120"},{default:a(t=>[l(x,null,{default:a(()=>[r(w(t.row.trigger_type==="CRON"?"Cron":t.row.trigger_type==="INTERVAL"?"间隔":"单次"),1)]),_:2},1024)]),_:1}),l(g,{prop:"status",label:"状态",width:"100"},{default:a(t=>[l(x,{type:t.row.status==="ACTIVE"?"success":t.row.status==="PAUSED"?"warning":"info"},{default:a(()=>[r(w(t.row.status==="ACTIVE"?"激活":t.row.status==="PAUSED"?"暂停":"完成"),1)]),_:2},1032,["type"])]),_:1}),l(g,{prop:"engine",label:"执行引擎",width:"120"},{default:a(t=>[l(x,{size:"small",type:"info"},{default:a(()=>[r(w(t.row.engine==="playwright"?"Playwright":"Selenium"),1)]),_:2},1024)]),_:1}),l(g,{prop:"browser",label:"浏览器",width:"100"},{default:a(t=>[r(w(t.row.browser||"chrome"),1)]),_:1}),l(g,{prop:"next_run_time",label:"下次执行时间",width:"180"},{default:a(t=>[r(w(J(t.row.next_run_time)),1)]),_:1}),l(g,{prop:"last_run_time",label:"上次执行时间",width:"180"},{default:a(t=>[r(w(J(t.row.last_run_time)),1)]),_:1}),l(g,{label:"操作",width:"200",fixed:"right"},{default:a(t=>[l(c,{size:"small",onClick:Q=>te(t.row),loading:t.row.running},{default:a(()=>e[28]||(e[28]=[r(" 立即执行 ",-1)])),_:2,__:[28]},1032,["onClick","loading"]),l(de,{onCommand:Q=>ae(Q,t.row)},{dropdown:a(()=>[l(ue,null,{default:a(()=>[l(A,{command:"edit"},{default:a(()=>e[30]||(e[30]=[r("编辑",-1)])),_:1,__:[30]}),t.row.status==="ACTIVE"?(u(),p(A,{key:0,command:"pause"},{default:a(()=>e[31]||(e[31]=[r("暂停",-1)])),_:1,__:[31]})):V("",!0),t.row.status==="PAUSED"?(u(),p(A,{key:1,command:"resume"},{default:a(()=>e[32]||(e[32]=[r("激活",-1)])),_:1,__:[32]})):V("",!0),l(A,{command:"delete",divided:""},{default:a(()=>e[33]||(e[33]=[r("删除",-1)])),_:1,__:[33]})]),_:2},1024)]),default:a(()=>[l(c,{size:"small"},{default:a(()=>[e[29]||(e[29]=r(" 更多",-1)),l(m,null,{default:a(()=>[l(X(Ce))]),_:1})]),_:1,__:[29]})]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[ve,j.value]])]),d("div",he,[l(pe,{"current-page":k.current,"onUpdate:currentPage":e[3]||(e[3]=t=>k.current=t),"page-size":k.size,"onUpdate:pageSize":e[4]||(e[4]=t=>k.size=t),total:k.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:y,onCurrentChange:y},null,8,["current-page","page-size","total"])]),l(ge,{modelValue:S.value,"onUpdate:modelValue":e[23]||(e[23]=t=>S.value=t),title:C.value?"编辑定时任务":"新建定时任务",width:"800px",onClose:W},{footer:a(()=>[l(c,{onClick:e[22]||(e[22]=t=>S.value=!1)},{default:a(()=>e[47]||(e[47]=[r("取消",-1)])),_:1,__:[47]}),l(c,{type:"primary",onClick:ee,loading:z.value},{default:a(()=>[r(w(C.value?"更新":"创建"),1)]),_:1},8,["loading"])]),default:a(()=>[l(ce,{model:o,"label-width":"120px"},{default:a(()=>[l(_,{label:"任务名称",required:""},{default:a(()=>[l(O,{modelValue:o.name,"onUpdate:modelValue":e[5]||(e[5]=t=>o.name=t),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),l(_,{label:"任务描述"},{default:a(()=>[l(O,{modelValue:o.description,"onUpdate:modelValue":e[6]||(e[6]=t=>o.description=t),type:"textarea",placeholder:"请输入任务描述"},null,8,["modelValue"])]),_:1}),l(_,{label:"关联项目",required:""},{default:a(()=>[l(v,{modelValue:o.project,"onUpdate:modelValue":e[7]||(e[7]=t=>o.project=t),placeholder:"请选择项目",onChange:$},{default:a(()=>[(u(!0),U(I,null,D(L.value,t=>(u(),p(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"任务类型",required:""},{default:a(()=>[l(R,{modelValue:o.task_type,"onUpdate:modelValue":e[8]||(e[8]=t=>o.task_type=t),onChange:K},{default:a(()=>[l(E,{value:"TEST_SUITE"},{default:a(()=>e[34]||(e[34]=[r("测试套件执行",-1)])),_:1,__:[34]}),l(E,{value:"TEST_CASE"},{default:a(()=>e[35]||(e[35]=[r("测试用例执行",-1)])),_:1,__:[35]})]),_:1},8,["modelValue"])]),_:1}),o.task_type==="TEST_SUITE"?(u(),p(_,{key:0,label:"测试套件",required:""},{default:a(()=>[l(v,{modelValue:o.test_suite,"onUpdate:modelValue":e[9]||(e[9]=t=>o.test_suite=t),placeholder:"请选择测试套件"},{default:a(()=>[(u(!0),U(I,null,D(B.value,t=>(u(),p(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):V("",!0),o.task_type==="TEST_CASE"?(u(),p(_,{key:1,label:"测试用例",required:""},{default:a(()=>[l(v,{modelValue:o.test_cases,"onUpdate:modelValue":e[10]||(e[10]=t=>o.test_cases=t),multiple:"",filterable:"",placeholder:"请选择测试用例"},{default:a(()=>[(u(!0),U(I,null,D(h.value,t=>(u(),p(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):V("",!0),l(_,{label:"触发器类型",required:""},{default:a(()=>[l(R,{modelValue:o.trigger_type,"onUpdate:modelValue":e[11]||(e[11]=t=>o.trigger_type=t)},{default:a(()=>[l(E,{value:"CRON"},{default:a(()=>e[36]||(e[36]=[r("Cron表达式",-1)])),_:1,__:[36]}),l(E,{value:"INTERVAL"},{default:a(()=>e[37]||(e[37]=[r("固定间隔",-1)])),_:1,__:[37]}),l(E,{value:"ONCE"},{default:a(()=>e[38]||(e[38]=[r("单次执行",-1)])),_:1,__:[38]})]),_:1},8,["modelValue"])]),_:1}),o.trigger_type==="CRON"?(u(),p(_,{key:2,label:"Cron表达式",required:""},{default:a(()=>[l(O,{modelValue:o.cron_expression,"onUpdate:modelValue":e[12]||(e[12]=t=>o.cron_expression=t),placeholder:"0 0 * * *"},null,8,["modelValue"]),d("div",Me,[l(me,{"raw-content":"",placement:"top"},{content:a(()=>e[39]||(e[39]=[d("div",{style:{"line-height":"1.6","text-align":"left"}},[d("div",null,"Cron表达式格式: 分 时 日 月 周"),d("div",null,"• 分: 0-59"),d("div",null,"• 时: 0-23"),d("div",null,"• 日: 1-31"),d("div",null,"• 月: 1-12 或 JAN-DEC"),d("div",null,"• 周: 0-6 或 SUN-SAT (0=周日)"),d("div",{style:{"margin-top":"8px"}},"常用示例:"),d("div",null,"• 每天0点: 0 0 * * *"),d("div",null,"• 每小时: 0 * * * *"),d("div",null,"• 每周一9点: 0 9 * * 1"),d("div",null,"• 每月1号0点: 0 0 1 * *")],-1)])),default:a(()=>[e[40]||(e[40]=d("span",{style:{cursor:"pointer",color:"#409EFF"}},"Cron帮助信息",-1))]),_:1,__:[40]})])]),_:1})):V("",!0),o.trigger_type==="INTERVAL"?(u(),p(_,{key:3,label:"间隔时间",required:""},{default:a(()=>[l(fe,{modelValue:o.interval_seconds,"onUpdate:modelValue":e[13]||(e[13]=t=>o.interval_seconds=t),min:60,step:60},null,8,["modelValue"]),e[41]||(e[41]=d("span",{class:"unit"},"秒",-1))]),_:1,__:[41]})):V("",!0),o.trigger_type==="ONCE"?(u(),p(_,{key:4,label:"执行时间",required:""},{default:a(()=>[l(ye,{modelValue:o.execute_at,"onUpdate:modelValue":e[14]||(e[14]=t=>o.execute_at=t),type:"datetime",placeholder:"选择执行时间"},null,8,["modelValue"])]),_:1})):V("",!0),l(_,{label:"执行引擎",required:""},{default:a(()=>[l(R,{modelValue:o.engine,"onUpdate:modelValue":e[15]||(e[15]=t=>o.engine=t)},{default:a(()=>[l(E,{value:"playwright"},{default:a(()=>e[42]||(e[42]=[r("Playwright",-1)])),_:1,__:[42]}),l(E,{value:"selenium"},{default:a(()=>e[43]||(e[43]=[r("Selenium",-1)])),_:1,__:[43]})]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"浏览器类型",required:""},{default:a(()=>[l(v,{modelValue:o.browser,"onUpdate:modelValue":e[16]||(e[16]=t=>o.browser=t),placeholder:"请选择浏览器"},{default:a(()=>[l(s,{label:"Chrome",value:"chrome"}),l(s,{label:"Firefox",value:"firefox"}),l(s,{label:"Edge",value:"edge"})]),_:1},8,["modelValue"])]),_:1}),l(_,{label:"运行模式"},{default:a(()=>[l(q,{modelValue:o.headless,"onUpdate:modelValue":e[17]||(e[17]=t=>o.headless=t)},{default:a(()=>e[44]||(e[44]=[r("无头模式（后台运行）",-1)])),_:1,__:[44]},8,["modelValue"])]),_:1}),l(_,{label:"通知设置"},{default:a(()=>[l(q,{modelValue:o.notify_on_success,"onUpdate:modelValue":e[18]||(e[18]=t=>o.notify_on_success=t)},{default:a(()=>e[45]||(e[45]=[r("执行成功时通知",-1)])),_:1,__:[45]},8,["modelValue"]),l(q,{modelValue:o.notify_on_failure,"onUpdate:modelValue":e[19]||(e[19]=t=>o.notify_on_failure=t)},{default:a(()=>e[46]||(e[46]=[r("执行失败时通知",-1)])),_:1,__:[46]},8,["modelValue"])]),_:1}),o.notify_on_success||o.notify_on_failure?(u(),p(_,{key:5,label:"通知类型"},{default:a(()=>[l(v,{modelValue:o.notification_type,"onUpdate:modelValue":e[20]||(e[20]=t=>o.notification_type=t),placeholder:"请选择通知类型"},{default:a(()=>[l(s,{label:"邮箱通知",value:"email"}),l(s,{label:"Webhook机器人",value:"webhook"}),l(s,{label:"两者都发送",value:"both"})]),_:1},8,["modelValue"])]),_:1})):V("",!0),(o.notify_on_success||o.notify_on_failure)&&(o.notification_type==="email"||o.notification_type==="both")?(u(),p(_,{key:6,label:"通知邮箱"},{default:a(()=>[l(v,{modelValue:o.notify_emails,"onUpdate:modelValue":e[21]||(e[21]=t=>o.notify_emails=t),multiple:"",filterable:"",placeholder:"请选择通知邮箱"},{default:a(()=>[(u(!0),U(I,null,D(M.value,t=>(u(),p(s,{key:t.id,label:t.display_name,value:t.email},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):V("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Xe=be($e,[["__scopeId","data-v-077577ce"]]);export{Xe as default};
