import{_ as ee,Q as te,q as g,x as se,r,o as v,c as h,b as a,t as c,J as ae,w as l,B as S,d as t,F as oe,y as le,$ as V,e as _,g as f,a0 as ne,f as y,a1 as ce,a2 as ie,a3 as re,a4 as de,a5 as ue,Y as _e,H as pe,a6 as ve,E as fe}from"./index-054e2682.js";const ge={class:"execution-detail"},he={class:"page-header-card"},me={class:"header-content"},ye={class:"title-section"},we={class:"page-title"},be={class:"project-info"},xe={key:0},ke={key:1,class:"no-data"},Ce={key:0},Ve={class:"run-header"},Se={class:"run-title-section"},ze={class:"run-title"},$e={class:"stats-cards"},Be={class:"stat-card total"},De={class:"stat-content"},Te={class:"stat-value"},Ee={class:"stat-card passed"},Me={class:"stat-content"},Ue={class:"stat-value"},je={class:"stat-card failed"},Ne={class:"stat-content"},Pe={class:"stat-value"},Re={class:"stat-card blocked"},He={class:"stat-content"},qe={class:"stat-value"},Fe={class:"stat-card untested"},Ie={class:"stat-content"},Le={class:"stat-value"},Je={class:"progress-section"},Qe={class:"progress-text"},Ye={key:0,class:"batch-actions"},Ae={key:1,class:"pagination-container"},Ge={__name:"ExecutionDetailView",setup(Ke){const M=te(),d=g({}),z=g(!1),D=g([]),p=g([]),w=g(1),b=g(10),$=g(!1),x=g(null),B=async()=>{try{const e=M.params.id,s=await V.get(`/api/executions/plans/${e}/`);d.value=s.data}catch{_.error("获取测试计划失败")}},U=async e=>{try{await V.patch(`/api/executions/run_cases/${e.id}/update_status/`,{status:e.status,comments:e.comments||""}),await B(),_.success("状态更新成功")}catch{_.error("状态更新失败")}},j=async e=>{try{await V.patch(`/api/executions/run_cases/${e.id}/update_status/`,{status:e.status,comments:e.comments||""}),_.success("详细信息更新成功")}catch{_.error("详细信息更新失败")}},N=async e=>{try{const s=await V.get(`/api/executions/run_cases/${e.id}/history/`);D.value=s.data,z.value=!0}catch{_.error("获取历史记录失败")}},P=e=>{p.value=e},R=async()=>{if(p.value.length===0){_.warning("请先选择要删除的用例");return}try{await fe.confirm(`确定要删除选中的 ${p.value.length} 个用例吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),$.value=!0;let e=0,s=0;for(const i of p.value)try{await V.delete(`/api/executions/run_cases/${i.id}/`),e++}catch(k){console.error(`删除用例 ${i.id} 失败:`,k),s++}e>0?_.success(`成功删除 ${e} 个用例${s>0?`，${s} 个失败`:""}`):_.error("删除失败"),p.value=[],await B()}catch(e){e!=="cancel"&&(console.error("批量删除失败:",e),_.error("批量删除失败"))}finally{$.value=!1}},H=e=>{if(!e)return[];const s=(w.value-1)*b.value,i=s+b.value;return e.slice(s,i)},q=e=>(w.value-1)*b.value+e+1,F=()=>{p.value=[],x.value&&x.value.clearSelection()},I=()=>{w.value=1,p.value=[],x.value&&x.value.clearSelection()},L=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",J=e=>e<30?"#f56c6c":e<70?"#e6a23c":"#67c23a",Q=e=>e.progress===100?"success":e.failed>0?"danger":e.blocked>0?"warning":"info",Y=e=>e.progress===100?"已完成":e.untested===e.total?"未开始":"进行中",A=e=>({untested:"info",passed:"success",failed:"danger",blocked:"warning",retest:"primary"})[e]||"info",G=e=>({untested:"未测试",passed:"通过",failed:"失败",blocked:"阻塞",retest:"重测"})[e]||e;return se(()=>{B()}),(e,s)=>{const i=r("el-icon"),k=r("el-tag"),K=r("el-progress"),T=r("el-button"),u=r("el-table-column"),C=r("el-option"),O=r("el-select"),W=r("el-input"),E=r("el-table"),X=r("el-pagination"),Z=r("el-dialog");return v(),h("div",ge,[a("div",he,[a("div",me,[a("div",ye,[a("h1",we,c(d.value.name),1),d.value.version?(v(),ae(k,{key:0,type:"primary",size:"large",class:"version-tag"},{default:l(()=>[t(i,null,{default:l(()=>[t(f(ne))]),_:1}),y(" "+c(d.value.version),1)]),_:1})):S("",!0)]),a("div",be,[t(i,{class:"info-icon"},{default:l(()=>[t(f(ce))]),_:1}),d.value.projects&&d.value.projects.length>0?(v(),h("span",xe,c(d.value.projects.join(", ")),1)):(v(),h("span",ke,"未关联项目"))])])]),d.value.test_runs&&d.value.test_runs.length>0?(v(),h("div",Ce,[(v(!0),h(oe,null,le(d.value.test_runs,o=>(v(),h("div",{key:o.id,class:"test-run-card"},[a("div",Ve,[a("div",Se,[a("h2",ze,c(o.name),1),t(k,{type:Q(o.progress),size:"large",class:"run-status-tag"},{default:l(()=>[y(c(Y(o.progress)),1)]),_:2},1032,["type"])]),a("div",$e,[a("div",Be,[t(i,{class:"stat-icon"},{default:l(()=>[t(f(ie))]),_:1}),a("div",De,[a("div",Te,c(o.progress.total),1),s[3]||(s[3]=a("div",{class:"stat-label"},"总计",-1))])]),a("div",Ee,[t(i,{class:"stat-icon"},{default:l(()=>[t(f(re))]),_:1}),a("div",Me,[a("div",Ue,c(o.progress.passed),1),s[4]||(s[4]=a("div",{class:"stat-label"},"通过",-1))])]),a("div",je,[t(i,{class:"stat-icon"},{default:l(()=>[t(f(de))]),_:1}),a("div",Ne,[a("div",Pe,c(o.progress.failed),1),s[5]||(s[5]=a("div",{class:"stat-label"},"失败",-1))])]),a("div",Re,[t(i,{class:"stat-icon"},{default:l(()=>[t(f(ue))]),_:1}),a("div",He,[a("div",qe,c(o.progress.blocked),1),s[6]||(s[6]=a("div",{class:"stat-label"},"阻塞",-1))])]),a("div",Fe,[t(i,{class:"stat-icon"},{default:l(()=>[t(f(_e))]),_:1}),a("div",Ie,[a("div",Le,c(o.progress.untested),1),s[7]||(s[7]=a("div",{class:"stat-label"},"未测",-1))])])])]),a("div",Je,[t(K,{percentage:o.progress.progress,"stroke-width":12,color:J(o.progress.progress),"show-text":!0},{default:l(({percentage:n})=>[a("span",Qe,c(n)+"%",1)]),_:2},1032,["percentage","color"])]),p.value.length>0?(v(),h("div",Ye,[t(T,{type:"danger",icon:f(pe),onClick:R,disabled:$.value},{default:l(()=>[y(" 批量删除 ("+c(p.value.length)+") ",1)]),_:1},8,["icon","disabled"])])):S("",!0),t(E,{ref_for:!0,ref_key:"tableRef",ref:x,data:H(o.run_cases),style:{width:"100%"},class:"execution-table",onSelectionChange:P,"row-key":n=>n.id},{default:l(()=>[t(u,{type:"selection",width:"55","reserve-selection":!0}),t(u,{type:"index",label:"序号",width:"80",index:q}),t(u,{prop:"testcase",label:"测试用例","min-width":"250"}),t(u,{label:"执行状态",width:"150"},{default:l(n=>[t(O,{modelValue:n.row.status,"onUpdate:modelValue":m=>n.row.status=m,onChange:m=>U(n.row),size:"small"},{default:l(()=>[t(C,{label:"未测试",value:"untested"}),t(C,{label:"通过",value:"passed"}),t(C,{label:"失败",value:"failed"}),t(C,{label:"阻塞",value:"blocked"}),t(C,{label:"重测",value:"retest"})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(u,{label:"备注","min-width":"250"},{default:l(n=>[t(W,{modelValue:n.row.comments,"onUpdate:modelValue":m=>n.row.comments=m,placeholder:"请输入备注",type:"textarea",rows:2,size:"small",onBlur:m=>j(n.row)},null,8,["modelValue","onUpdate:modelValue","onBlur"])]),_:1}),t(u,{label:"操作",width:"120",fixed:"right"},{default:l(n=>[t(T,{size:"small",type:"primary",icon:f(ve),onClick:m=>N(n.row)},{default:l(()=>s[8]||(s[8]=[y(" 历史 ",-1)])),_:2,__:[8]},1032,["icon","onClick"])]),_:1})]),_:2},1032,["data","row-key"]),o.run_cases&&o.run_cases.length>0?(v(),h("div",Ae,[t(X,{"current-page":w.value,"onUpdate:currentPage":s[0]||(s[0]=n=>w.value=n),"page-size":b.value,"onUpdate:pageSize":s[1]||(s[1]=n=>b.value=n),"page-sizes":[10,20,50,100],total:o.run_cases.length,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:F,onSizeChange:I},null,8,["current-page","page-size","total"])])):S("",!0)]))),128))])):S("",!0),t(Z,{title:"执行历史记录",modelValue:z.value,"onUpdate:modelValue":s[2]||(s[2]=o=>z.value=o),width:"80%"},{default:l(()=>[t(E,{data:D.value,style:{width:"100%"}},{default:l(()=>[t(u,{prop:"status",label:"状态",width:"100"},{default:l(o=>[t(k,{type:A(o.row.status)},{default:l(()=>[y(c(G(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(u,{prop:"comments",label:"备注","show-overflow-tooltip":""}),t(u,{prop:"executed_by.username",label:"执行者",width:"120"}),t(u,{prop:"executed_at",label:"执行时间",width:"180"},{default:l(o=>[y(c(L(o.row.executed_at)),1)]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}}},We=ee(Ge,[["__scopeId","data-v-4b796ba8"]]);export{We as default};
