import{_ as xe,Q as Me,u as $e,a as je,q as F,V as K,v as j,x as Te,r as m,o as u,c as g,b as n,d as s,w as t,J as h,B as w,C as N,e as T,f as i,t as d,G as Z,F as S,y as A,g as I,W as De,X as Re,Y as Ue,R as Se}from"./index-054e2682.js";const Ae={class:"page-container"},ze={class:"page-header"},qe={key:0,class:"content-container"},Be={class:"progress-content"},Ee={class:"progress-stats"},Ye={class:"stat-item"},Fe={class:"stat-number"},Ne={class:"stat-item"},Ie={class:"stat-number"},Oe={class:"stat-item"},Pe={class:"stat-number"},He={key:0,class:"checklist-summary"},Ge={class:"checklist-tooltip"},Je={class:"checklist-stats"},Le={key:1,class:"no-checklist"},Qe={class:"card-header"},We={class:"card-header-with-action"},Xe={class:"comments-list"},Ke={class:"comment-header"},Ze={class:"comment-author"},et={class:"author-name"},tt={class:"comment-time"},st={class:"comment-content"},lt={key:0,class:"comment-testcase"},at={key:0,class:"empty-comments"},ot={class:"checklist-container"},nt={class:"checklist-header"},it={class:"checklist-title"},rt={class:"checklist-actions"},dt={class:"checklist-items"},ut={class:"item-content"},ct={class:"item-text"},pt={class:"item-controls"},_t={__name:"ReviewDetail",setup(mt){const z=Me(),q=$e(),O=je(),o=F(null),D=F(!1),M=F(!1),f=K({status:"approved",comment:"",checklist_results:{}}),p=K({comment_type:"general",testcase:"",content:""}),P=j(()=>{var l,e;return((e=(l=o.value)==null?void 0:l.assignments)==null?void 0:e.filter(r=>r.status!=="pending").length)||0}),ee=j(()=>{var l,e;return((e=(l=o.value)==null?void 0:l.assignments)==null?void 0:e.filter(r=>r.status==="pending").length)||0}),H=j(()=>{var e,r;const l=((r=(e=o.value)==null?void 0:e.assignments)==null?void 0:r.length)||0;return l===0?0:Math.round(P.value/l*100)}),te=j(()=>{const l=H.value;return l===100?"#67c23a":l>=50?"#e6a23c":"#f56c6c"}),se=j(()=>{var l,e,r,c;return((e=(l=o.value)==null?void 0:l.creator)==null?void 0:e.id)===((r=O.user)==null?void 0:r.id)&&["pending","in_progress"].includes((c=o.value)==null?void 0:c.status)}),le=j(()=>{var l,e;return(e=(l=o.value)==null?void 0:l.assignments)==null?void 0:e.some(r=>{var c;return r.reviewer.id===((c=O.user)==null?void 0:c.id)&&r.status==="pending"})}),B=async()=>{try{const l=await N.get(`/reviews/reviews/${z.params.id}/`);o.value=l.data}catch{T.error("获取评审详情失败"),q.push("/ai-generation/reviews")}},ae=()=>{q.push(`/ai-generation/reviews/${z.params.id}/edit`)},oe=()=>{var l,e,r;f.status="approved",f.comment="",f.checklist_results={},(r=(e=(l=o.value)==null?void 0:l.template)==null?void 0:e.checklist)!=null&&r.length&&o.value.template.checklist.forEach((c,k)=>{f.checklist_results[k]=null}),D.value=!0},ne=async()=>{try{await N.post(`/reviews/reviews/${z.params.id}/submit_review/`,f),T.success("评审提交成功"),D.value=!1,B()}catch{T.error("评审提交失败")}},ie=()=>{p.comment_type="general",p.testcase="",p.content="",M.value=!0},re=l=>{p.comment_type="testcase",p.testcase=l.id,p.content="",M.value=!0},de=async()=>{if(!p.content){T.warning("请输入意见内容");return}try{const l={review:o.value.id,comment_type:p.comment_type,content:p.content};p.comment_type==="testcase"&&p.testcase&&(l.testcase=p.testcase),await N.post("/reviews/review-comments/",l),T.success("意见添加成功"),M.value=!1,B()}catch(l){console.error("意见添加失败:",l),T.error("意见添加失败")}},ue=l=>{q.push(`/ai-generation/testcases/${l}`)},ce=l=>({pending:"warning",in_progress:"primary",approved:"success",rejected:"danger",cancelled:"info"})[l]||"info",pe=l=>({pending:"待评审",in_progress:"评审中",approved:"已通过",rejected:"已拒绝",cancelled:"已取消"})[l]||l,_e=l=>({pending:"warning",approved:"success",rejected:"danger",abstained:"info"})[l]||"info",me=l=>({pending:"待评审",approved:"已通过",rejected:"已拒绝",abstained:"弃权"})[l]||l,G=l=>({low:"低",medium:"中",high:"高",critical:"紧急",urgent:"紧急"})[l]||l,ve=l=>({functional:"功能测试",integration:"集成测试",api:"API测试",ui:"UI测试",performance:"性能测试",security:"安全测试"})[l]||"-",fe=l=>({general:"primary",testcase:"success",step:"warning"})[l]||"info",ge=l=>({general:"整体意见",testcase:"用例意见",step:"步骤意见"})[l]||"-",R=l=>Se(l).format("YYYY-MM-DD HH:mm"),J=l=>{var e,r,c;(c=(r=(e=o.value)==null?void 0:e.template)==null?void 0:r.checklist)!=null&&c.length&&o.value.template.checklist.forEach((k,V)=>{f.checklist_results[V]=l})},ye=(l,e)=>{if(!l||!e)return"0/0";const r=e.length,c=Object.values(l).filter(V=>V===!0).length,k=Object.values(l).filter(V=>V===!1).length;return`通过: ${c}, 不通过: ${k}, 总计: ${r}`};return Te(()=>{B()}),(l,e)=>{const r=m("el-button"),c=m("el-descriptions-item"),k=m("el-tag"),V=m("el-descriptions"),U=m("el-card"),ke=m("el-progress"),y=m("el-table-column"),E=m("el-icon"),be=m("el-tooltip"),L=m("el-table"),he=m("el-avatar"),C=m("el-radio-button"),Y=m("el-radio-group"),$=m("el-form-item"),Q=m("el-input"),W=m("el-form"),X=m("el-dialog"),we=m("el-option"),Ve=m("el-select");return u(),g("div",Ae,[n("div",ze,[e[15]||(e[15]=n("h1",{class:"page-title"},"评审详情",-1)),n("div",null,[s(r,{onClick:e[0]||(e[0]=a=>l.$router.back())},{default:t(()=>e[12]||(e[12]=[i("返回",-1)])),_:1,__:[12]}),se.value?(u(),h(r,{key:0,type:"warning",onClick:ae},{default:t(()=>e[13]||(e[13]=[i("编辑",-1)])),_:1,__:[13]})):w("",!0),le.value?(u(),h(r,{key:1,type:"success",onClick:oe},{default:t(()=>e[14]||(e[14]=[i("提交评审",-1)])),_:1,__:[14]})):w("",!0)])]),o.value?(u(),g("div",qe,[s(U,{class:"info-card"},{header:t(()=>e[16]||(e[16]=[n("span",{class:"card-header"},"基本信息",-1)])),default:t(()=>[s(V,{column:2,border:""},{default:t(()=>[s(c,{label:"评审标题",span:2},{default:t(()=>[i(d(o.value.title),1)]),_:1}),s(c,{label:"关联项目"},{default:t(()=>{var a;return[i(d(Array.isArray(o.value.projects)?o.value.projects.map(_=>_.name).join(", "):((a=o.value.projects)==null?void 0:a.name)||"未设置"),1)]}),_:1}),s(c,{label:"创建人"},{default:t(()=>{var a;return[i(d((a=o.value.creator)==null?void 0:a.username),1)]}),_:1}),s(c,{label:"使用模板"},{default:t(()=>{var a;return[i(d(((a=o.value.template)==null?void 0:a.name)||"未使用模板"),1)]}),_:1}),s(c,{label:"评审状态"},{default:t(()=>[s(k,{type:ce(o.value.status)},{default:t(()=>[i(d(pe(o.value.status)),1)]),_:1},8,["type"])]),_:1}),s(c,{label:"优先级"},{default:t(()=>[s(k,{class:Z(`priority-tag ${o.value.priority}`)},{default:t(()=>[i(d(G(o.value.priority)),1)]),_:1},8,["class"])]),_:1}),s(c,{label:"截止时间"},{default:t(()=>[i(d(o.value.deadline?R(o.value.deadline):"无"),1)]),_:1}),s(c,{label:"创建时间"},{default:t(()=>[i(d(R(o.value.created_at)),1)]),_:1}),s(c,{label:"评审描述",span:2},{default:t(()=>[i(d(o.value.description||"无"),1)]),_:1})]),_:1})]),_:1}),s(U,{class:"progress-card"},{header:t(()=>e[17]||(e[17]=[n("span",{class:"card-header"},"评审进度",-1)])),default:t(()=>{var a;return[n("div",Be,[n("div",Ee,[n("div",Ye,[n("div",Fe,d(((a=o.value.assignments)==null?void 0:a.length)||0),1),e[18]||(e[18]=n("div",{class:"stat-label"},"评审人员",-1))]),n("div",Ne,[n("div",Ie,d(P.value),1),e[19]||(e[19]=n("div",{class:"stat-label"},"已完成",-1))]),n("div",Oe,[n("div",Pe,d(ee.value),1),e[20]||(e[20]=n("div",{class:"stat-label"},"待评审",-1))])]),s(ke,{percentage:H.value,color:te.value,"stroke-width":8,class:"main-progress"},null,8,["percentage","color"])])]}),_:1}),s(U,{class:"reviewers-card"},{header:t(()=>e[21]||(e[21]=[n("span",{class:"card-header"},"评审人员",-1)])),default:t(()=>[s(L,{data:o.value.assignments,stripe:""},{default:t(()=>{var a,_;return[s(y,{prop:"reviewer.username",label:"评审人",width:"150"}),s(y,{label:"评审状态",width:"120"},{default:t(({row:v})=>[s(k,{type:_e(v.status)},{default:t(()=>[i(d(me(v.status)),1)]),_:2},1032,["type"])]),_:1}),s(y,{prop:"comment",label:"评审意见","min-width":"200","show-overflow-tooltip":""}),(_=(a=o.value.template)==null?void 0:a.checklist)!=null&&_.length?(u(),h(y,{key:0,label:"检查清单",width:"150"},{default:t(({row:v})=>[v.checklist_results&&Object.keys(v.checklist_results).length>0?(u(),g("div",He,[s(be,{effect:"dark",placement:"top"},{content:t(()=>[n("div",Ge,[(u(!0),g(S,null,A(o.value.template.checklist,(b,x)=>(u(),g("div",{key:x,class:"checklist-item"},[v.checklist_results[x]===!0?(u(),h(E,{key:0,class:"pass-icon"},{default:t(()=>[s(I(De))]),_:1})):v.checklist_results[x]===!1?(u(),h(E,{key:1,class:"fail-icon"},{default:t(()=>[s(I(Re))]),_:1})):(u(),h(E,{key:2,class:"pending-icon"},{default:t(()=>[s(I(Ue))]),_:1})),n("span",null,d(b),1)]))),128))])]),default:t(()=>[n("span",Je,d(ye(v.checklist_results,o.value.template.checklist)),1)]),_:2},1024)])):(u(),g("span",Le,"未填写"))]),_:1})):w("",!0),s(y,{prop:"assigned_at",label:"分配时间",width:"160"},{default:t(({row:v})=>[i(d(R(v.assigned_at)),1)]),_:1}),s(y,{prop:"reviewed_at",label:"评审时间",width:"160"},{default:t(({row:v})=>[i(d(v.reviewed_at?R(v.reviewed_at):"待评审"),1)]),_:1})]}),_:1},8,["data"])]),_:1}),s(U,{class:"testcases-card"},{header:t(()=>{var a;return[n("span",Qe,"评审用例 ("+d(((a=o.value.testcases)==null?void 0:a.length)||0)+")",1)]}),default:t(()=>[s(L,{data:o.value.testcases,stripe:""},{default:t(()=>[s(y,{prop:"title",label:"用例标题","min-width":"200","show-overflow-tooltip":""}),s(y,{label:"测试类型",width:"120"},{default:t(({row:a})=>[i(d(ve(a.test_type)),1)]),_:1}),s(y,{label:"优先级",width:"100"},{default:t(({row:a})=>[s(k,{class:Z(`priority-tag ${a.priority}`)},{default:t(()=>[i(d(G(a.priority)),1)]),_:2},1032,["class"])]),_:1}),s(y,{prop:"author.username",label:"作者",width:"120"}),s(y,{label:"操作",width:"120"},{default:t(({row:a})=>[s(r,{link:"",type:"primary",onClick:_=>ue(a.id)},{default:t(()=>e[22]||(e[22]=[i("查看",-1)])),_:2,__:[22]},1032,["onClick"]),s(r,{link:"",type:"success",onClick:_=>re(a)},{default:t(()=>e[23]||(e[23]=[i("评论",-1)])),_:2,__:[23]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),s(U,{class:"comments-card"},{header:t(()=>[n("div",We,[e[25]||(e[25]=n("span",{class:"card-header"},"评审意见",-1)),s(r,{type:"primary",size:"small",onClick:ie},{default:t(()=>e[24]||(e[24]=[i("添加意见",-1)])),_:1,__:[24]})])]),default:t(()=>{var a;return[n("div",Xe,[(u(!0),g(S,null,A(o.value.comments,_=>(u(),g("div",{key:_.id,class:"comment-item"},[n("div",Ke,[n("div",Ze,[s(he,{size:32,src:_.author.avatar},null,8,["src"]),n("span",et,d(_.author.username),1),s(k,{size:"small",type:fe(_.comment_type)},{default:t(()=>[i(d(ge(_.comment_type)),1)]),_:2},1032,["type"])]),n("div",tt,d(R(_.created_at)),1)]),n("div",st,d(_.content),1),_.testcase?(u(),g("div",lt," 相关用例: "+d(_.testcase.title),1)):w("",!0)]))),128)),(a=o.value.comments)!=null&&a.length?w("",!0):(u(),g("div",at," 暂无评审意见 "))])]}),_:1})])):w("",!0),s(X,{modelValue:D.value,"onUpdate:modelValue":e[6]||(e[6]=a=>D.value=a),title:"提交评审",width:"800px"},{footer:t(()=>[s(r,{onClick:e[5]||(e[5]=a=>D.value=!1)},{default:t(()=>e[33]||(e[33]=[i("取消",-1)])),_:1,__:[33]}),s(r,{type:"primary",onClick:ne},{default:t(()=>e[34]||(e[34]=[i("提交",-1)])),_:1,__:[34]})]),default:t(()=>[s(W,{model:f,"label-width":"100px"},{default:t(()=>{var a,_,v;return[s($,{label:"评审结果",required:""},{default:t(()=>[s(Y,{modelValue:f.status,"onUpdate:modelValue":e[1]||(e[1]=b=>f.status=b)},{default:t(()=>[s(C,{label:"approved"},{default:t(()=>e[26]||(e[26]=[i("通过",-1)])),_:1,__:[26]}),s(C,{label:"rejected"},{default:t(()=>e[27]||(e[27]=[i("拒绝",-1)])),_:1,__:[27]}),s(C,{label:"abstained"},{default:t(()=>e[28]||(e[28]=[i("弃权",-1)])),_:1,__:[28]})]),_:1},8,["modelValue"])]),_:1}),(v=(_=(a=o.value)==null?void 0:a.template)==null?void 0:_.checklist)!=null&&v.length?(u(),h($,{key:0,label:"检查清单",class:"checklist-form-item"},{default:t(()=>[n("div",ot,[n("div",nt,[n("span",it,d(o.value.template.name)+" - 检查清单",1),n("div",rt,[s(r,{size:"small",onClick:e[2]||(e[2]=b=>J(!0))},{default:t(()=>e[29]||(e[29]=[i("全部通过",-1)])),_:1,__:[29]}),s(r,{size:"small",onClick:e[3]||(e[3]=b=>J(!1))},{default:t(()=>e[30]||(e[30]=[i("全部不通过",-1)])),_:1,__:[30]})])]),n("div",dt,[(u(!0),g(S,null,A(o.value.template.checklist,(b,x)=>(u(),g("div",{key:x,class:"checklist-item"},[n("div",ut,[n("span",ct,d(b),1)]),n("div",pt,[s(Y,{modelValue:f.checklist_results[x],"onUpdate:modelValue":Ce=>f.checklist_results[x]=Ce},{default:t(()=>[s(C,{label:!0},{default:t(()=>e[31]||(e[31]=[i("通过",-1)])),_:1,__:[31]}),s(C,{label:!1},{default:t(()=>e[32]||(e[32]=[i("不通过",-1)])),_:1,__:[32]})]),_:2},1032,["modelValue","onUpdate:modelValue"])])]))),128))])])]),_:1})):w("",!0),s($,{label:"评审意见"},{default:t(()=>[s(Q,{modelValue:f.comment,"onUpdate:modelValue":e[4]||(e[4]=b=>f.comment=b),type:"textarea",rows:4,placeholder:"请输入评审意见"},null,8,["modelValue"])]),_:1})]}),_:1},8,["model"])]),_:1},8,["modelValue"]),s(X,{modelValue:M.value,"onUpdate:modelValue":e[11]||(e[11]=a=>M.value=a),title:"添加评审意见",width:"600px"},{footer:t(()=>[s(r,{onClick:e[10]||(e[10]=a=>M.value=!1)},{default:t(()=>e[37]||(e[37]=[i("取消",-1)])),_:1,__:[37]}),s(r,{type:"primary",onClick:de},{default:t(()=>e[38]||(e[38]=[i("提交",-1)])),_:1,__:[38]})]),default:t(()=>[s(W,{model:p,"label-width":"100px"},{default:t(()=>[s($,{label:"意见类型",required:""},{default:t(()=>[s(Y,{modelValue:p.comment_type,"onUpdate:modelValue":e[7]||(e[7]=a=>p.comment_type=a)},{default:t(()=>[s(C,{label:"general"},{default:t(()=>e[35]||(e[35]=[i("整体意见",-1)])),_:1,__:[35]}),s(C,{label:"testcase"},{default:t(()=>e[36]||(e[36]=[i("用例意见",-1)])),_:1,__:[36]})]),_:1},8,["modelValue"])]),_:1}),p.comment_type==="testcase"?(u(),h($,{key:0,label:"相关用例"},{default:t(()=>[s(Ve,{modelValue:p.testcase,"onUpdate:modelValue":e[8]||(e[8]=a=>p.testcase=a),placeholder:"请选择用例"},{default:t(()=>[(u(!0),g(S,null,A(o.value.testcases,a=>(u(),h(we,{key:a.id,label:a.title,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):w("",!0),s($,{label:"意见内容",required:""},{default:t(()=>[s(Q,{modelValue:p.content,"onUpdate:modelValue":e[9]||(e[9]=a=>p.content=a),type:"textarea",rows:4,placeholder:"请输入意见内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ft=xe(_t,[["__scopeId","data-v-7fe72933"]]);export{ft as default};
