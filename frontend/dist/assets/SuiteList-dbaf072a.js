import{_ as Ee,q as _,V as H,v as $e,x as Fe,r as p,S as Re,o as E,c as te,b as u,d as t,w as l,N as je,J as ae,e as d,F as Be,y as Ne,g as y,D as qe,f,U as le,t as S,ae as Ae,aq as He,H as se,A as Je,cK as Ke,cL as Ge,cM as Oe,E as Qe}from"./index-054e2682.js";import{b as We,D as Xe,s as Ye,E as Ze,F as et,G as oe,H as tt,I as at,J as lt,K as st}from"./ui_automation-53e326f9.js";const ot={class:"page-container"},nt={class:"page-header"},rt={class:"card-container"},it={class:"filter-bar"},ut={style:{color:"#67c23a","font-weight":"bold"}},dt={style:{color:"#f56c6c","font-weight":"bold"}},ct={class:"pagination-container"},pt={class:"test-case-selector"},_t={class:"selector-panel"},ft={class:"panel-header"},mt={class:"panel-content"},vt={class:"selector-panel"},gt={class:"panel-header"},wt={class:"panel-content"},yt={class:"dialog-footer"},ht={class:"dialog-footer"},bt={__name:"SuiteList",setup(Ct){const P=_([]),h=_(""),T=_([]),$=_(!1),F=_(""),U=_(0),b=H({currentPage:1,pageSize:20}),V=_(!1),z=_(!1),M=_(!1),D=_(null),R=_(!1),j=_(!1),v=H({name:"",description:""}),ne={name:[{required:!0,message:"请输入套件名称",trigger:"blur"}]},B=_([]),r=_([]),k=_(""),g=H({engine:"playwright",browser:"chrome",headless:!1}),N=_(null),re=$e(()=>k.value?B.value.filter(a=>a.name.toLowerCase().includes(k.value.toLowerCase())||a.description&&a.description.toLowerCase().includes(k.value.toLowerCase())):B.value),ie=async()=>{try{const a=await We({page_size:100});P.value=a.data.results||a.data}catch(a){console.error("获取项目列表失败:",a),d.error("获取项目列表失败")}},C=async()=>{if(!h.value){T.value=[],U.value=0;return}$.value=!0;try{const a=await Xe({project:h.value,page:b.currentPage,page_size:b.pageSize,search:F.value});a.data.results?(T.value=a.data.results,U.value=a.data.count||0):(T.value=a.data,U.value=a.data.length)}catch(a){console.error("获取测试套件列表失败:",a),d.error("获取测试套件列表失败")}finally{$.value=!1}},J=async()=>{if(h.value)try{const a=await Ye({project:h.value,page_size:1e3});B.value=a.data.results||a.data}catch(a){console.error("获取测试用例列表失败:",a),d.error("获取测试用例列表失败")}},ue=async()=>{b.currentPage=1,await C()},de=async()=>{b.currentPage=1,await C()},ce=async()=>{b.currentPage=1,await C()},pe=async()=>{await C()},_e=async()=>{if(!v.name){d.warning("请输入套件名称");return}if(!h.value){d.warning("请先选择项目");return}R.value=!0;try{const a={project:h.value,name:v.name,description:v.description};let e;if(M.value?(await Ze(D.value,a),e=D.value,d.success("套件更新成功")):(e=(await et(a)).data.id,d.success("套件创建成功")),r.value.length>0){if(M.value){const o=await oe(e);for(const i of o.data)await tt(e,i.test_case.id)}for(let o=0;o<r.value.length;o++)await at(e,{test_case_id:r.value[o].id,order:o})}V.value=!1,await C(),q()}catch(a){console.error("保存测试套件失败:",a),d.error("保存测试套件失败")}finally{R.value=!1}},K=async a=>{try{const e=T.value.find(i=>i.id===a);if(!e)return;D.value=a,M.value=!0,v.name=e.name,v.description=e.description;const o=await oe(a);r.value=o.data.map(i=>i.test_case).sort((i,n)=>i.order-n.order),await J(),V.value=!0}catch(e){console.error("加载套件详情失败:",e),d.error("加载套件详情失败")}},fe=async a=>{try{await Qe.confirm("确定要删除该测试套件吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await lt(a),d.success("删除成功"),await C()}catch(e){e!=="cancel"&&(console.error("删除测试套件失败:",e),d.error("删除测试套件失败"))}},me=a=>{if(!a.test_case_count||a.test_case_count===0){d.warning("该测试套件未包含任何测试用例，无法执行");return}N.value=a,z.value=!0},ve=async()=>{var a,e;j.value=!0;try{const o={use_ai:!1,engine:g.engine,browser:g.browser,headless:g.headless},i=await st(N.value.id,o);d.success("测试套件开始执行"),z.value=!1,await C(),ge(N.value.id)}catch(o){console.error("执行测试套件失败:",o);const i=((e=(a=o.response)==null?void 0:a.data)==null?void 0:e.error)||"执行测试套件失败";d.error(i)}finally{j.value=!1}},ge=a=>{let e=0;const o=120,i=setInterval(async()=>{e++;try{await C();const n=T.value.find(m=>m.id===a);n&&n.execution_status!=="running"&&(clearInterval(i),n.execution_status==="passed"?d.success(`测试套件执行完成：全部通过 (${n.passed_count}/${n.passed_count+n.failed_count})`):n.execution_status==="failed"&&d.warning(`测试套件执行完成：部分失败 (通过: ${n.passed_count}, 失败: ${n.failed_count})`)),e>=o&&(clearInterval(i),d.info("执行时间较长，请稍后刷新查看结果"))}catch(n){console.error("轮询套件状态失败:",n),clearInterval(i)}},3e3)},we=a=>{G(a)},ye=({row:a})=>r.value.some(e=>e.id===a.id)?"selected-row":"",G=a=>{if(r.value.some(e=>e.id===a.id)){d.warning("该用例已添加");return}r.value.push({...a})},he=a=>{r.value.splice(a,1)},be=a=>{if(a>0){const e=r.value[a];r.value[a]=r.value[a-1],r.value[a-1]=e}},Ce=a=>{if(a<r.value.length-1){const e=r.value[a];r.value[a]=r.value[a+1],r.value[a+1]=e}},q=()=>{v.name="",v.description="",r.value=[],k.value="",M.value=!1,D.value=null},Se=()=>{V.value=!1,q()},O=(a,e,o)=>o?new Date(o).toLocaleString():"",Te=a=>({not_run:"info",passed:"success",failed:"danger",running:"warning"})[a]||"info",Ve=a=>({not_run:"未执行",passed:"通过",failed:"失败",running:"执行中"})[a]||"未知",Q=a=>({high:"danger",medium:"warning",low:"info"})[a]||"info",W=a=>({high:"高",medium:"中",low:"低"})[a]||"未知",ke=a=>({draft:"info",ready:"primary",running:"warning",passed:"success",failed:"danger"})[a]||"info",xe=a=>({draft:"草稿",ready:"就绪",running:"执行中",passed:"通过",failed:"失败"})[a]||"未知";Fe(async()=>{await ie(),P.value.length>0&&(h.value=P.value[0].id,await C())});const ze=async()=>{q(),await J(),V.value=!0};return(a,e)=>{const o=p("el-option"),i=p("el-select"),n=p("el-icon"),m=p("el-button"),I=p("el-input"),Me=p("el-col"),Pe=p("el-row"),c=p("el-table-column"),Ue=p("el-link"),L=p("el-tag"),A=p("el-table"),De=p("el-pagination"),x=p("el-form-item"),X=p("el-form"),Y=p("el-dialog"),Z=p("el-radio"),Ie=p("el-radio-group"),Le=Re("loading");return E(),te("div",ot,[u("div",nt,[e[14]||(e[14]=u("h1",{class:"page-title"},"测试套件管理",-1)),t(i,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),placeholder:"选择项目",style:{width:"200px","margin-right":"15px"},onChange:ue},{default:l(()=>[(E(!0),te(Be,null,Ne(P.value,s=>(E(),ae(o,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),t(m,{type:"primary",onClick:ze},{default:l(()=>[t(n,null,{default:l(()=>[t(y(qe))]),_:1}),e[13]||(e[13]=f(" 新增套件 ",-1))]),_:1,__:[13]})]),u("div",rt,[u("div",it,[t(Pe,{gutter:20},{default:l(()=>[t(Me,{span:6},{default:l(()=>[t(I,{modelValue:F.value,"onUpdate:modelValue":e[1]||(e[1]=s=>F.value=s),placeholder:"搜索套件名称或描述",clearable:"",onInput:de},{prefix:l(()=>[t(n,null,{default:l(()=>[t(y(le))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),je((E(),ae(A,{data:T.value,style:{width:"100%"}},{default:l(()=>[t(c,{type:"selection",width:"55"}),t(c,{prop:"name",label:"套件名称","min-width":"200"},{default:l(({row:s})=>[t(Ue,{onClick:w=>K(s.id),type:"primary"},{default:l(()=>[f(S(s.name),1)]),_:2},1032,["onClick"])]),_:1}),t(c,{prop:"description",label:"描述","min-width":"200","show-overflow-tooltip":""}),t(c,{label:"包含用例数",width:"120"},{default:l(({row:s})=>[f(S(s.test_case_count||0),1)]),_:1}),t(c,{label:"执行状态",width:"100"},{default:l(({row:s})=>[t(L,{type:Te(s.execution_status)},{default:l(()=>[f(S(Ve(s.execution_status)),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"通过数",width:"90"},{default:l(({row:s})=>[u("span",ut,S(s.passed_count||0),1)]),_:1}),t(c,{label:"失败数",width:"90"},{default:l(({row:s})=>[u("span",dt,S(s.failed_count||0),1)]),_:1}),t(c,{prop:"created_at",label:"创建时间",width:"180",formatter:O}),t(c,{prop:"updated_at",label:"更新时间",width:"180",formatter:O}),t(c,{label:"操作",width:"240",fixed:"right"},{default:l(({row:s})=>[t(m,{size:"small",type:"primary",onClick:w=>K(s.id)},{default:l(()=>[t(n,null,{default:l(()=>[t(y(Ae))]),_:1}),e[15]||(e[15]=f(" 编辑 ",-1))]),_:2,__:[15]},1032,["onClick"]),t(m,{size:"small",type:"success",onClick:w=>me(s)},{default:l(()=>[t(n,null,{default:l(()=>[t(y(He))]),_:1}),e[16]||(e[16]=f(" 运行 ",-1))]),_:2,__:[16]},1032,["onClick"]),t(m,{size:"small",type:"danger",onClick:w=>fe(s.id)},{default:l(()=>[t(n,null,{default:l(()=>[t(y(se))]),_:1}),e[17]||(e[17]=f(" 删除 ",-1))]),_:2,__:[17]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Le,$.value]]),u("div",ct,[t(De,{"current-page":b.currentPage,"onUpdate:currentPage":e[2]||(e[2]=s=>b.currentPage=s),"page-size":b.pageSize,"onUpdate:pageSize":e[3]||(e[3]=s=>b.pageSize=s),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:U.value,onSizeChange:ce,onCurrentChange:pe},null,8,["current-page","page-size","total"])])]),t(Y,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=s=>V.value=s),title:M.value?"编辑测试套件":"新增测试套件",width:"900px","close-on-click-modal":!1},{footer:l(()=>[u("span",yt,[t(m,{onClick:Se},{default:l(()=>e[19]||(e[19]=[f("取消",-1)])),_:1,__:[19]}),t(m,{type:"primary",onClick:_e,loading:R.value},{default:l(()=>e[20]||(e[20]=[f("确定",-1)])),_:1,__:[20]},8,["loading"])])]),default:l(()=>[t(X,{ref:"createFormRef",model:v,rules:ne,"label-width":"100px"},{default:l(()=>[t(x,{label:"套件名称",prop:"name"},{default:l(()=>[t(I,{modelValue:v.name,"onUpdate:modelValue":e[4]||(e[4]=s=>v.name=s),placeholder:"请输入套件名称"},null,8,["modelValue"])]),_:1}),t(x,{label:"描述",prop:"description"},{default:l(()=>[t(I,{modelValue:v.description,"onUpdate:modelValue":e[5]||(e[5]=s=>v.description=s),type:"textarea",placeholder:"请输入套件描述"},null,8,["modelValue"])]),_:1}),t(x,{label:"测试用例"},{default:l(()=>[u("div",pt,[u("div",_t,[u("div",ft,[e[18]||(e[18]=u("h4",null,"可用用例",-1)),t(I,{modelValue:k.value,"onUpdate:modelValue":e[6]||(e[6]=s=>k.value=s),placeholder:"搜索用例",size:"small",clearable:"",style:{width:"200px"}},{prefix:l(()=>[t(n,null,{default:l(()=>[t(y(le))]),_:1})]),_:1},8,["modelValue"])]),u("div",mt,[t(A,{data:re.value,height:"300",onRowClick:we,"row-class-name":ye},{default:l(()=>[t(c,{prop:"name",label:"用例名称","min-width":"150","show-overflow-tooltip":""}),t(c,{prop:"priority",label:"优先级",width:"80"},{default:l(({row:s})=>[t(L,{size:"small",type:Q(s.priority)},{default:l(()=>[f(S(W(s.priority)),1)]),_:2},1032,["type"])]),_:1}),t(c,{prop:"status",label:"状态",width:"80"},{default:l(({row:s})=>[t(L,{size:"small",type:ke(s.status)},{default:l(()=>[f(S(xe(s.status)),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"操作",width:"80"},{default:l(({row:s})=>[t(m,{size:"small",text:"",onClick:Je(w=>G(s),["stop"])},{default:l(()=>[t(n,null,{default:l(()=>[t(y(Ke))]),_:1})]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])])]),u("div",vt,[u("div",gt,[u("h4",null,"已选用例 ("+S(r.value.length)+")",1)]),u("div",wt,[t(A,{data:r.value,height:"300"},{default:l(()=>[t(c,{prop:"name",label:"用例名称","min-width":"150","show-overflow-tooltip":""}),t(c,{prop:"priority",label:"优先级",width:"80"},{default:l(({row:s})=>[t(L,{size:"small",type:Q(s.priority)},{default:l(()=>[f(S(W(s.priority)),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"操作",width:"120"},{default:l(({row:s,$index:w})=>[t(m,{size:"small",text:"",onClick:ee=>be(w),disabled:w===0},{default:l(()=>[t(n,null,{default:l(()=>[t(y(Ge))]),_:1})]),_:2},1032,["onClick","disabled"]),t(m,{size:"small",text:"",onClick:ee=>Ce(w),disabled:w===r.value.length-1},{default:l(()=>[t(n,null,{default:l(()=>[t(y(Oe))]),_:1})]),_:2},1032,["onClick","disabled"]),t(m,{size:"small",text:"",type:"danger",onClick:ee=>he(w)},{default:l(()=>[t(n,null,{default:l(()=>[t(y(se))]),_:1})]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])])])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),t(Y,{modelValue:z.value,"onUpdate:modelValue":e[12]||(e[12]=s=>z.value=s),title:"执行测试套件",width:"600px"},{footer:l(()=>[u("span",ht,[t(m,{onClick:e[11]||(e[11]=s=>z.value=!1)},{default:l(()=>e[23]||(e[23]=[f("取消",-1)])),_:1,__:[23]}),t(m,{type:"primary",onClick:ve,loading:j.value},{default:l(()=>e[24]||(e[24]=[f(" 开始执行 ",-1)])),_:1,__:[24]},8,["loading"])])]),default:l(()=>[t(X,{model:g,"label-width":"120px"},{default:l(()=>[t(x,{label:"测试引擎"},{default:l(()=>[t(i,{modelValue:g.engine,"onUpdate:modelValue":e[8]||(e[8]=s=>g.engine=s),placeholder:"请选择测试引擎"},{default:l(()=>[t(o,{label:"Playwright",value:"playwright"}),t(o,{label:"Selenium",value:"selenium"})]),_:1},8,["modelValue"])]),_:1}),t(x,{label:"浏览器"},{default:l(()=>[t(i,{modelValue:g.browser,"onUpdate:modelValue":e[9]||(e[9]=s=>g.browser=s),placeholder:"请选择浏览器"},{default:l(()=>[t(o,{label:"Chrome",value:"chrome"}),t(o,{label:"Firefox",value:"firefox"}),t(o,{label:"Safari",value:"safari"}),t(o,{label:"Edge",value:"edge"})]),_:1},8,["modelValue"])]),_:1}),t(x,{label:"执行模式"},{default:l(()=>[t(Ie,{modelValue:g.headless,"onUpdate:modelValue":e[10]||(e[10]=s=>g.headless=s)},{default:l(()=>[t(Z,{label:!1},{default:l(()=>e[21]||(e[21]=[f("有头模式",-1)])),_:1,__:[21]}),t(Z,{label:!0},{default:l(()=>e[22]||(e[22]=[f("无头模式",-1)])),_:1,__:[22]})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Vt=Ee(bt,[["__scopeId","data-v-5c6fd0f5"]]);export{Vt as default};
