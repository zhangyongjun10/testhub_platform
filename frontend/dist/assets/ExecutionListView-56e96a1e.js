import{_ as Pe,u as Ue,q as p,V as Z,Z as $e,x as Ee,r as m,S as Fe,o as c,c as g,b as h,J as y,w as s,g as le,B as De,d as a,N as Se,C as w,e as f,E as te,f as _,t as C,H as ze,D as Re,F as k,y as P}from"./index-054e2682.js";const Be={class:"execution-list"},Le={class:"header"},Oe={class:"header-actions"},Te={class:"filter-bar"},Ne={key:0},qe={key:1},Me={class:"pagination"},Ae={style:{float:"left"}},He={style:{float:"right",color:"#8492a6","font-size":"13px"}},Ie={class:"dialog-footer"},Je={class:"dialog-footer"},Ze={__name:"ExecutionListView",setup(Ge){const ae=Ue(),O=p(!1),T=p(!1),N=p(!1),q=p([]),F=p([]),B=p([]);p([]);const j=p([]),D=p(!1),M=p([]),U=p([]),A=p(!1),x=p(1),S=p(20),G=p(0),E=Z({project:null,is_active:null}),z=p(!1),R=p(!1),H=p(),I=p(),K=p(null),o=Z({name:"",description:"",projects:[],version:null,testcases:[],assignees:[]}),u=Z({id:null,name:"",description:"",projects:[],version:null,assignees:[],is_active:!0}),Q={name:[{required:!0,message:"请输入计划名称",trigger:"blur"}],projects:[{required:!0,message:"请选择项目",trigger:"change"}],testcases:[{required:!0,message:"请选择至少一个测试用例",trigger:"change",validator:(t,l,n)=>{!o.projects||o.projects.length===0?n(new Error("请先选择项目")):!l||l.length===0?n(new Error("请选择至少一个测试用例")):n()}}]},b=async()=>{O.value=!0;try{const t={page:x.value,page_size:S.value,...E};Object.keys(t).forEach(n=>{(t[n]===null||t[n]==="")&&delete t[n]});const l=await w.get("/executions/plans/",{params:t});q.value=l.data.results||l.data||[],G.value=l.data.count||q.value.length}catch{f.error("获取测试计划失败")}finally{O.value=!1}},se=async()=>{try{const[t,l,n]=await Promise.all([w.get("/projects/"),w.get("/versions/"),w.get("/users/users/")]);F.value=(t.data.results||t.data||[]).filter(v=>v!=null),B.value=(l.data.results||l.data||[]).filter(v=>v!=null),M.value=(n.data.results||n.data||[]).filter(v=>v!=null)}catch(t){console.error("获取基础数据失败:",t)}},W=async t=>{var l,n,v,i;if(!t||t.length===0){j.value=[];return}D.value=!0;try{const r=new URLSearchParams;t.forEach($=>r.append("project_ids",$)),console.log("API URL:",`/executions/plans/testcases_by_projects/?${r.toString()}`);const d=await w.get(`/executions/plans/testcases_by_projects/?${r.toString()}`);console.log("API Response:",d.data),j.value=d.data.results||[],console.log("Filtered testcases:",j.value)}catch(r){console.error("Load testcases error:",r),((l=r.response)==null?void 0:l.status)===400?f.warning(r.response.data.detail||"请先选择项目"):((n=r.response)==null?void 0:n.status)===401?f.error("请先登录"):f.error("获取测试用例失败: "+(((i=(v=r.response)==null?void 0:v.data)==null?void 0:i.detail)||r.message)),j.value=[]}finally{D.value=!1}},ne=t=>{if(t&&(!o.projects||o.projects.length===0))return f.warning("请先选择项目"),!1},oe=t=>{o.testcases=[],t&&t.length>0?W(t):j.value=[]},re=async()=>{try{await H.value.validate(),T.value=!0,await w.post("/executions/plans/",o),f.success("测试计划创建成功"),z.value=!1,Y(),b()}catch(t){t.name!=="ValidateError"&&f.error("创建测试计划失败")}finally{T.value=!1}},X=t=>{ae.push(`/ai-generation/executions/${t}`)},ie=async t=>{var l,n;try{const i=(await w.get(`/executions/plans/${t.id}/`)).data;K.value=i,Object.assign(u,{id:i.id,name:i.name,description:i.description||"",projects:((l=i.projects)==null?void 0:l.map(r=>{const d=F.value.find($=>$.name===r);return d?d.id:r}))||[],version:i.version?(n=B.value.find(r=>r.name===i.version))==null?void 0:n.id:null,assignees:i.assignees||[],is_active:i.is_active}),R.value=!0}catch{f.error("获取测试计划详情失败")}},ue=async()=>{try{await I.value.validate(),N.value=!0;const t={name:u.name,description:u.description,projects:u.projects,version:u.version,assignees:u.assignees,is_active:u.is_active};await w.put(`/executions/plans/${u.id}/`,t),f.success("测试计划更新成功"),R.value=!1,de(),b()}catch(t){t.name!=="ValidateError"&&f.error("更新测试计划失败")}finally{N.value=!1}},de=()=>{var t;Object.assign(u,{id:null,name:"",description:"",projects:[],version:null,assignees:[],is_active:!0}),K.value=null,(t=I.value)==null||t.resetFields()},ce=async t=>{try{const l=t.is_active?"关闭":"激活";await te.confirm(`确定要${l}这个测试计划吗？`,"确认操作",{type:"warning"}),await w.patch(`/executions/plans/${t.id}/`,{is_active:!t.is_active}),f.success(`${l}成功`),b()}catch(l){l!=="cancel"&&f.error("操作失败")}},pe=()=>{Y(),z.value=!0},Y=()=>{var t;Object.assign(o,{name:"",description:"",projects:[],version:null,testcases:[],assignees:[]}),j.value=[],D.value=!1,(t=H.value)==null||t.resetFields()},ve=()=>{x.value=1,b()},fe=()=>{Object.assign(E,{project:null,is_active:null}),x.value=1,b()},me=t=>{S.value=t,x.value=1,b()},_e=t=>{x.value=t,b()},ge=t=>t?new Date(t).toLocaleString():"-",ye=t=>{U.value=t},we=t=>(x.value-1)*S.value+t+1,be=async()=>{if(U.value.length===0){f.warning("请先选择要删除的测试计划");return}try{await te.confirm(`确定要删除选中的 ${U.value.length} 个测试计划吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),A.value=!0;let t=0,l=0;for(const n of U.value)try{await w.delete(`/executions/plans/${n.id}/`),t++}catch(v){console.error(`删除测试计划 ${n.id} 失败:`,v),l++}t>0?f.success(`成功删除 ${t} 个测试计划${l>0?`，${l} 个失败`:""}`):f.error("删除失败"),U.value=[],b()}catch(t){t!=="cancel"&&(console.error("批量删除失败:",t),f.error("批量删除失败"))}finally{A.value=!1}};return $e(()=>o.projects,(t,l)=>{o.testcases=[],t&&t.length>0?W(t):j.value=[]},{deep:!0}),Ee(()=>{b(),se()}),(t,l)=>{const n=m("el-button"),v=m("el-icon"),i=m("el-option"),r=m("el-select"),d=m("el-form-item"),$=m("el-form"),V=m("el-table-column"),Ve=m("el-link"),he=m("el-tag"),je=m("el-table"),xe=m("el-pagination"),L=m("el-input"),ee=m("el-dialog"),Ce=m("el-switch"),ke=Fe("loading");return c(),g("div",Be,[h("div",Le,[l[21]||(l[21]=h("h1",null,"测试计划",-1)),h("div",Oe,[U.value.length>0?(c(),y(n,{key:0,type:"danger",icon:le(ze),onClick:be,disabled:A.value},{default:s(()=>[_(" 批量删除 ("+C(U.value.length)+") ",1)]),_:1},8,["icon","disabled"])):De("",!0),a(n,{type:"primary",onClick:pe},{default:s(()=>[a(v,null,{default:s(()=>[a(le(Re))]),_:1}),l[20]||(l[20]=_(" 新建测试计划 ",-1))]),_:1,__:[20]})])]),h("div",Te,[a($,{inline:!0},{default:s(()=>[a(d,{label:"项目"},{default:s(()=>[a(r,{modelValue:E.project,"onUpdate:modelValue":l[0]||(l[0]=e=>E.project=e),placeholder:"选择项目",clearable:"",style:{width:"200px"}},{default:s(()=>[(c(!0),g(k,null,P(F.value,e=>(c(),y(i,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"状态"},{default:s(()=>[a(r,{modelValue:E.is_active,"onUpdate:modelValue":l[1]||(l[1]=e=>E.is_active=e),placeholder:"选择状态",clearable:"",style:{width:"120px"}},{default:s(()=>[a(i,{label:"激活",value:!0}),a(i,{label:"已关闭",value:!1})]),_:1},8,["modelValue"])]),_:1}),a(d,null,{default:s(()=>[a(n,{type:"primary",onClick:ve},{default:s(()=>l[22]||(l[22]=[_("查询",-1)])),_:1,__:[22]}),a(n,{onClick:fe},{default:s(()=>l[23]||(l[23]=[_("重置",-1)])),_:1,__:[23]})]),_:1})]),_:1})]),Se((c(),y(je,{data:q.value,style:{width:"100%"},onSelectionChange:ye},{default:s(()=>[a(V,{type:"selection",width:"55"}),a(V,{type:"index",label:"序号",width:"80",index:we}),a(V,{prop:"name",label:"计划名称","min-width":"200"},{default:s(e=>[a(Ve,{type:"primary",onClick:J=>X(e.row.id)},{default:s(()=>[_(C(e.row.name),1)]),_:2},1032,["onClick"])]),_:1}),a(V,{prop:"projects",label:"项目",width:"200"},{default:s(e=>[e.row.projects&&e.row.projects.length>0?(c(),g("span",Ne,C(e.row.projects.join(", ")),1)):(c(),g("span",qe,"-"))]),_:1}),a(V,{prop:"version",label:"版本",width:"120"}),a(V,{prop:"creator.username",label:"创建者",width:"120"}),a(V,{label:"状态",width:"100"},{default:s(e=>[a(he,{type:e.row.is_active?"success":"info"},{default:s(()=>[_(C(e.row.is_active?"激活":"已关闭"),1)]),_:2},1032,["type"])]),_:1}),a(V,{prop:"created_at",label:"创建时间",width:"180"},{default:s(e=>[_(C(ge(e.row.created_at)),1)]),_:1}),a(V,{label:"操作",width:"200",fixed:"right"},{default:s(e=>[a(n,{size:"small",type:"primary",onClick:J=>X(e.row.id)},{default:s(()=>l[24]||(l[24]=[_(" 查看执行 ",-1)])),_:2,__:[24]},1032,["onClick"]),a(n,{size:"small",type:"warning",onClick:J=>ie(e.row)},{default:s(()=>l[25]||(l[25]=[_(" 编辑 ",-1)])),_:2,__:[25]},1032,["onClick"]),a(n,{size:"small",type:e.row.is_active?"danger":"success",onClick:J=>ce(e.row)},{default:s(()=>[_(C(e.row.is_active?"关闭":"激活"),1)]),_:2},1032,["type","onClick"])]),_:1})]),_:1},8,["data"])),[[ke,O.value]]),h("div",Me,[a(xe,{"current-page":x.value,"onUpdate:currentPage":l[2]||(l[2]=e=>x.value=e),"page-size":S.value,"onUpdate:pageSize":l[3]||(l[3]=e=>S.value=e),"page-sizes":[10,20,50,100],small:!1,total:G.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:me,onCurrentChange:_e},null,8,["current-page","page-size","total"])]),a(ee,{title:"新建测试计划",modelValue:z.value,"onUpdate:modelValue":l[11]||(l[11]=e=>z.value=e),width:"600px"},{footer:s(()=>[h("span",Ie,[a(n,{onClick:l[10]||(l[10]=e=>z.value=!1)},{default:s(()=>l[26]||(l[26]=[_("取消",-1)])),_:1,__:[26]}),a(n,{type:"primary",onClick:re,loading:T.value},{default:s(()=>l[27]||(l[27]=[_("创建",-1)])),_:1,__:[27]},8,["loading"])])]),default:s(()=>[a($,{model:o,rules:Q,ref_key:"planFormRef",ref:H,"label-width":"100px"},{default:s(()=>[a(d,{label:"计划名称",prop:"name"},{default:s(()=>[a(L,{modelValue:o.name,"onUpdate:modelValue":l[4]||(l[4]=e=>o.name=e),placeholder:"请输入计划名称"},null,8,["modelValue"])]),_:1}),a(d,{label:"计划描述"},{default:s(()=>[a(L,{modelValue:o.description,"onUpdate:modelValue":l[5]||(l[5]=e=>o.description=e),type:"textarea",rows:3,placeholder:"请输入计划描述"},null,8,["modelValue"])]),_:1}),a(d,{label:"关联项目",prop:"projects"},{default:s(()=>[a(r,{modelValue:o.projects,"onUpdate:modelValue":l[6]||(l[6]=e=>o.projects=e),multiple:"",placeholder:"请选择项目",style:{width:"100%"},onChange:oe},{default:s(()=>[(c(!0),g(k,null,P(F.value,e=>(c(),y(i,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"关联版本"},{default:s(()=>[a(r,{modelValue:o.version,"onUpdate:modelValue":l[7]||(l[7]=e=>o.version=e),placeholder:"请选择版本",style:{width:"100%"}},{default:s(()=>[(c(!0),g(k,null,P(B.value,e=>(c(),y(i,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"测试用例",prop:"testcases"},{default:s(()=>[a(r,{modelValue:o.testcases,"onUpdate:modelValue":l[8]||(l[8]=e=>o.testcases=e),multiple:"",placeholder:D.value?"加载中...":!o.projects||o.projects.length===0?"请先选择项目":"请选择用例",style:{width:"100%"},disabled:!o.projects||o.projects.length===0,loading:D.value,onVisibleChange:ne},{default:s(()=>[(c(!0),g(k,null,P(j.value,e=>(c(),y(i,{key:e.id,label:e.title,value:e.id},{default:s(()=>[h("span",Ae,C(e.title),1),h("span",He,C(e.project__name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","disabled","loading"])]),_:1}),a(d,{label:"指派给"},{default:s(()=>[a(r,{modelValue:o.assignees,"onUpdate:modelValue":l[9]||(l[9]=e=>o.assignees=e),multiple:"",placeholder:"请选择执行人员",style:{width:"100%"}},{default:s(()=>[(c(!0),g(k,null,P(M.value,e=>(c(),y(i,{key:e.id,label:e.username,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(ee,{title:"编辑测试计划",modelValue:R.value,"onUpdate:modelValue":l[19]||(l[19]=e=>R.value=e),width:"600px"},{footer:s(()=>[h("span",Je,[a(n,{onClick:l[18]||(l[18]=e=>R.value=!1)},{default:s(()=>l[28]||(l[28]=[_("取消",-1)])),_:1,__:[28]}),a(n,{type:"primary",onClick:ue,loading:N.value},{default:s(()=>l[29]||(l[29]=[_("保存",-1)])),_:1,__:[29]},8,["loading"])])]),default:s(()=>[a($,{model:u,rules:Q,ref_key:"editPlanFormRef",ref:I,"label-width":"100px"},{default:s(()=>[a(d,{label:"计划名称",prop:"name"},{default:s(()=>[a(L,{modelValue:u.name,"onUpdate:modelValue":l[12]||(l[12]=e=>u.name=e),placeholder:"请输入计划名称"},null,8,["modelValue"])]),_:1}),a(d,{label:"计划描述"},{default:s(()=>[a(L,{modelValue:u.description,"onUpdate:modelValue":l[13]||(l[13]=e=>u.description=e),type:"textarea",rows:3,placeholder:"请输入计划描述"},null,8,["modelValue"])]),_:1}),a(d,{label:"关联项目",prop:"projects"},{default:s(()=>[a(r,{modelValue:u.projects,"onUpdate:modelValue":l[14]||(l[14]=e=>u.projects=e),multiple:"",placeholder:"请选择项目",style:{width:"100%"}},{default:s(()=>[(c(!0),g(k,null,P(F.value,e=>(c(),y(i,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"关联版本"},{default:s(()=>[a(r,{modelValue:u.version,"onUpdate:modelValue":l[15]||(l[15]=e=>u.version=e),placeholder:"请选择版本",style:{width:"100%"}},{default:s(()=>[(c(!0),g(k,null,P(B.value,e=>(c(),y(i,{key:e.id,label:e.name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"指派给"},{default:s(()=>[a(r,{modelValue:u.assignees,"onUpdate:modelValue":l[16]||(l[16]=e=>u.assignees=e),multiple:"",placeholder:"请选择执行人员",style:{width:"100%"}},{default:s(()=>[(c(!0),g(k,null,P(M.value,e=>(c(),y(i,{key:e.id,label:e.username,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(d,{label:"状态"},{default:s(()=>[a(Ce,{modelValue:u.is_active,"onUpdate:modelValue":l[17]||(l[17]=e=>u.is_active=e),"active-text":"激活","inactive-text":"已关闭"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Qe=Pe(Ze,[["__scopeId","data-v-25fe1b22"]]);export{Qe as default};
