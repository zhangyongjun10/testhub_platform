import{_ as ie,q as f,v as se,Z as le,r as _,o as r,J as z,w as i,b as e,d as a,f as p,c,g as U,L as re,af as ae,T as de,t as u,B as h,F as j,y as W,M as ue,e as S,V as ce,x as pe,a7 as ve,S as _e,N as me,E as fe,H as ge}from"./index-054e2682.js";import{a5 as ye,a6 as be,a7 as oe,a8 as he}from"./ui_automation-53e326f9.js";import{i as ne}from"./index-6433f102.js";const we={key:0,class:"report-loading"},ke={key:1,class:"report-container"},xe={class:"report-type-tabs"},Ce={key:0,class:"report-content"},Re={class:"report-section"},Ie={class:"overview-cards"},Se={class:"overview-card"},$e={class:"overview-card"},ze={class:"card-value"},De={class:"overview-card"},Ve={class:"card-value"},Ae={class:"overview-card"},Ee={class:"card-value"},Pe={key:0,class:"report-section"},Te={class:"statistics-container"},Fe={class:"chart-wrapper"},Ue={class:"stats-table"},Be={class:"stats-table-content"},Me={class:"stat-value"},Le={class:"success-row"},Ne={class:"stat-value"},Ge={class:"info-row"},Oe={class:"stat-value"},je={class:"danger-row"},We={class:"stat-value"},qe={class:"warning-row"},He={class:"stat-value"},Je={class:"report-section"},Ze={class:"timeline-container"},Ke={class:"timeline-task-content"},Qe={class:"task-description"},Xe={key:1,class:"report-content"},Ye={class:"report-section"},et={class:"steps-list"},tt={class:"step-header"},st={class:"step-number"},lt={class:"step-content"},at={class:"step-action"},ot={key:0,class:"step-element"},nt={key:1,class:"step-thinking"},it={key:0,class:"report-section"},rt={class:"errors-list"},dt={key:2,class:"report-content"},ut={key:0,class:"report-section"},ct={class:"performance-metrics"},pt={class:"metric-card"},vt={class:"metric-value"},_t={class:"metric-card"},mt={class:"metric-value"},ft={class:"metric-card"},gt={class:"metric-value"},yt={key:1,class:"report-section"},bt={key:2,class:"report-section"},ht={key:3,class:"report-section"},wt={class:"recommendations-list"},kt={key:2,class:"report-error"},xt={class:"dialog-footer"},Ct={key:0,class:"gif-container"},Rt=["src"],It={__name:"AIExecutionReport",props:{modelValue:{type:Boolean,default:!1},recordId:{type:[Number,String],default:null}},emits:["update:modelValue"],setup(ee,{emit:D}){const k=ee,F=D,m=f(!1),R=f(!1),s=f(null),b=f("summary"),C=f(!1),V=f(null),A=f(null);let w=null,x=null;const P=se(()=>({summary:"执行摘要",detailed:"详细步骤",performance:"性能分析"})[b.value]||"执行摘要"),q=se(()=>{if(s.value&&s.value.gif_path){const o=s.value.gif_path;return o.startsWith("media/")?`/${o}`:`/media/${o}`}return""});le(()=>k.modelValue,o=>{m.value=o,o&&k.recordId&&(b.value="summary",B("summary"))}),le(m,o=>{F("update:modelValue",o),o||(w&&(w.dispose(),w=null),x&&(x.dispose(),x=null))});const B=async(o="summary")=>{if(k.recordId){R.value=!0;try{const t=await ye(k.recordId,{report_type:o});console.log("API Response:",t.data),t.data.success?(s.value=t.data.data,console.log("Report Data:",s.value),await ue(),setTimeout(()=>{o==="summary"?J():o==="performance"&&Z()},100)):S.error(t.data.error||"获取报告失败")}catch(t){console.error("加载报告失败:",t),S.error("加载报告失败")}finally{R.value=!1}}},H=o=>{b.value=o,B(o)},J=()=>{if(!V.value||!s.value)return;if(!s.value.statistics){console.warn("统计数据不存在");return}w&&w.dispose(),w=ne(V.value);const o=s.value.statistics,t={tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},legend:{orient:"vertical",right:10,top:"center"},series:[{type:"pie",radius:["40%","70%"],center:["35%","50%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:16,fontWeight:"bold"}},labelLine:{show:!1},data:[{value:o.completed||0,name:"已完成",itemStyle:{color:"#67C23A"}},{value:o.pending||0,name:"待执行",itemStyle:{color:"#909399"}},{value:o.failed||0,name:"失败",itemStyle:{color:"#F56C6C"}},{value:o.skipped||0,name:"跳过",itemStyle:{color:"#E6A23C"}}].filter(n=>n.value>0)}]};w.setOption(t)},Z=()=>{if(!A.value||!s.value)return;if(!s.value.action_distribution){console.warn("操作分布数据不存在");return}x&&x.dispose(),x=ne(A.value);const o=s.value.action_distribution,t=[{name:"点击",value:o.click||0},{name:"输入",value:o.input||0},{name:"滚动",value:o.scroll||0},{name:"等待",value:o.wait||0},{name:"切换标签",value:o.switch_tab||0},{name:"导航",value:o.navigate||0},{name:"新标签",value:o.open_tab||0},{name:"任务完成",value:o.done||0},{name:"其他",value:o.other||0}].filter(l=>l.value>0),n={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},xAxis:{type:"category",data:t.map(l=>l.name)},yAxis:{type:"value"},series:[{type:"bar",data:t.map(l=>l.value),itemStyle:{color:"#409EFF"}}]};x.setOption(n)},M=o=>({completed:"success",pending:"info",failed:"danger",skipped:"warning"})[o]||"info",L=o=>({completed:"success",pending:"info",failed:"danger",skipped:"warning"})[o]||"info",N=o=>({completed:"success",pending:"info",failed:"danger"})[o]||"info",K=async()=>{var o,t;if(!k.recordId){S.error("无法导出报告：缺少记录ID");return}try{S.info("正在生成PDF报告，请稍候...");const n=await be(k.recordId,{report_type:b.value}),l=new Blob([n.data],{type:"application/pdf"}),I=window.URL.createObjectURL(l),g=document.createElement("a");g.href=I;const y=n.headers["content-disposition"];let $="AI_Report.pdf";if(y){const E=y.match(/filename="(.+)"/);E&&E[1]&&($=decodeURIComponent(E[1]))}g.download=$,document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(I),S.success("PDF报告导出成功！")}catch(n){console.error("导出报告失败:",n),S.error(((t=(o=n.response)==null?void 0:o.data)==null?void 0:t.error)||"导出报告失败，请稍后重试")}},G=()=>{m.value=!1};return(o,t)=>{const n=_("el-icon"),l=_("el-radio-button"),I=_("el-radio-group"),g=_("el-button"),y=_("el-tag"),$=_("el-card"),E=_("el-timeline-item"),Q=_("el-timeline"),O=_("el-alert"),T=_("el-table-column"),v=_("el-table"),X=_("el-empty"),te=_("el-dialog");return r(),z(te,{modelValue:m.value,"onUpdate:modelValue":t[3]||(t[3]=d=>m.value=d),title:`AI测试执行报告 - ${P.value}`,width:"1000px","close-on-click-modal":!1,onClose:G},{footer:i(()=>[e("span",xt,[a(g,{onClick:G},{default:i(()=>t[35]||(t[35]=[p("关闭",-1)])),_:1,__:[35]})])]),default:i(()=>[R.value?(r(),c("div",we,[a(n,{class:"is-loading"},{default:i(()=>[a(U(re))]),_:1}),t[4]||(t[4]=e("span",null,"正在生成报告...",-1))])):s.value?(r(),c("div",ke,[e("div",xe,[a(I,{modelValue:b.value,"onUpdate:modelValue":t[0]||(t[0]=d=>b.value=d),onChange:H},{default:i(()=>[a(l,{value:"summary"},{default:i(()=>t[5]||(t[5]=[p("执行摘要",-1)])),_:1,__:[5]}),a(l,{value:"detailed"},{default:i(()=>t[6]||(t[6]=[p("详细步骤",-1)])),_:1,__:[6]}),a(l,{value:"performance"},{default:i(()=>t[7]||(t[7]=[p("性能分析",-1)])),_:1,__:[7]})]),_:1},8,["modelValue"]),s.value.gif_path?(r(),z(g,{key:0,type:"primary",size:"small",onClick:t[1]||(t[1]=d=>C.value=!0)},{default:i(()=>[a(n,null,{default:i(()=>[a(U(ae))]),_:1}),t[8]||(t[8]=p(" 查看GIF回放 ",-1))]),_:1,__:[8]})):(r(),z(g,{key:1,type:"info",size:"small",disabled:""},{default:i(()=>[a(n,null,{default:i(()=>[a(U(ae))]),_:1}),t[9]||(t[9]=p(" GIF未生成 ",-1))]),_:1,__:[9]})),a(g,{type:"success",size:"small",onClick:K},{default:i(()=>[a(n,null,{default:i(()=>[a(U(de))]),_:1}),t[10]||(t[10]=p(" 导出报告 ",-1))]),_:1,__:[10]})]),b.value==="summary"?(r(),c("div",Ce,[e("div",Re,[t[15]||(t[15]=e("h3",{class:"section-title"},"执行概览",-1)),e("div",Ie,[e("div",Se,[t[11]||(t[11]=e("div",{class:"card-label"},"执行状态",-1)),a(y,{type:s.value.overview.status_color,size:"large"},{default:i(()=>[p(u(s.value.overview.status),1)]),_:1},8,["type"])]),e("div",$e,[t[12]||(t[12]=e("div",{class:"card-label"},"执行时长",-1)),e("div",ze,u(s.value.overview.duration_formatted),1)]),e("div",De,[t[13]||(t[13]=e("div",{class:"card-label"},"任务完成率",-1)),e("div",Ve,u(s.value.overview.completion_rate)+"%",1)]),e("div",Ae,[t[14]||(t[14]=e("div",{class:"card-label"},"执行步骤",-1)),e("div",Ee,u(s.value.overview.total_steps)+" 步",1)])])]),s.value.statistics?(r(),c("div",Pe,[t[21]||(t[21]=e("h3",{class:"section-title"},"任务统计",-1)),e("div",Te,[e("div",Fe,[e("div",{ref_key:"pieChartRef",ref:V,class:"chart",style:{height:"200px"}},null,512)]),e("div",Ue,[e("table",Be,[e("tbody",null,[e("tr",null,[t[16]||(t[16]=e("td",null,"总任务数",-1)),e("td",Me,u(s.value.statistics.total),1)]),e("tr",Le,[t[17]||(t[17]=e("td",null,"已完成",-1)),e("td",Ne,u(s.value.statistics.completed),1)]),e("tr",Ge,[t[18]||(t[18]=e("td",null,"待执行",-1)),e("td",Oe,u(s.value.statistics.pending),1)]),e("tr",je,[t[19]||(t[19]=e("td",null,"失败",-1)),e("td",We,u(s.value.statistics.failed),1)]),e("tr",qe,[t[20]||(t[20]=e("td",null,"跳过",-1)),e("td",He,u(s.value.statistics.skipped),1)])])])])])])):h("",!0),e("div",Je,[t[22]||(t[22]=e("h3",{class:"section-title"},"任务执行时间线",-1)),e("div",Ze,[a(Q,null,{default:i(()=>[(r(!0),c(j,null,W(s.value.timeline,d=>(r(),z(E,{key:d.id,timestamp:`任务 ${d.id}`,placement:"top",type:M(d.status)},{default:i(()=>[a($,null,{default:i(()=>[e("div",Ke,[e("div",Qe,u(d.description),1),a(y,{type:L(d.status),size:"small"},{default:i(()=>[p(u(d.status_display),1)]),_:2},1032,["type"])])]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1})])])])):b.value==="detailed"?(r(),c("div",Xe,[e("div",Ye,[t[26]||(t[26]=e("h3",{class:"section-title"},"执行步骤详情",-1)),e("div",et,[(r(!0),c(j,null,W(s.value.detailed_steps,d=>(r(),z($,{key:d.step_number,class:"step-card"},{default:i(()=>[e("div",tt,[e("span",st,"步骤 "+u(d.step_number),1),a(y,{type:N(d.status),size:"small"},{default:i(()=>[p(u(d.status),1)]),_:2},1032,["type"])]),e("div",lt,[e("div",at,[t[23]||(t[23]=e("strong",null,"操作:",-1)),p(" "+u(d.action||"-"),1)]),d.element?(r(),c("div",ot,[t[24]||(t[24]=e("strong",null,"元素:",-1)),p(" "+u(d.element),1)])):h("",!0),d.thinking?(r(),c("div",nt,[t[25]||(t[25]=e("strong",null,"思考:",-1)),p(" "+u(d.thinking),1)])):h("",!0)])]),_:2},1024))),128))])]),s.value.errors&&s.value.errors.length>0?(r(),c("div",it,[t[27]||(t[27]=e("h3",{class:"section-title"},"错误信息",-1)),e("div",rt,[(r(!0),c(j,null,W(s.value.errors,(d,Y)=>(r(),z(O,{key:Y,type:d.type==="error"?"error":"warning",title:d.message,closable:!1,"show-icon":""},null,8,["type","title"]))),128))])])):h("",!0)])):b.value==="performance"?(r(),c("div",dt,[s.value.metrics?(r(),c("div",ut,[t[31]||(t[31]=e("h3",{class:"section-title"},"性能指标",-1)),e("div",ct,[e("div",pt,[t[28]||(t[28]=e("div",{class:"metric-label"},"平均步骤耗时",-1)),e("div",vt,u(s.value.metrics.avg_step_duration)+" 秒",1)]),e("div",_t,[t[29]||(t[29]=e("div",{class:"metric-label"},"最长步骤耗时",-1)),e("div",mt,u(s.value.metrics.max_step_duration)+" 秒",1)]),e("div",ft,[t[30]||(t[30]=e("div",{class:"metric-label"},"最短步骤耗时",-1)),e("div",gt,u(s.value.metrics.min_step_duration)+" 秒",1)])])])):h("",!0),s.value.action_distribution?(r(),c("div",yt,[t[32]||(t[32]=e("h3",{class:"section-title"},"操作类型分布",-1)),e("div",{ref_key:"barChartRef",ref:A,class:"chart",style:{height:"250px"}},null,512)])):h("",!0),s.value.bottlenecks&&s.value.bottlenecks.length>0?(r(),c("div",bt,[t[33]||(t[33]=e("h3",{class:"section-title"},"性能瓶颈",-1)),a(v,{data:s.value.bottlenecks,stripe:""},{default:i(()=>[a(T,{prop:"step_number",label:"步骤",width:"80"}),a(T,{prop:"action",label:"操作","min-width":"200"}),a(T,{prop:"duration",label:"耗时(秒)",width:"100"}),a(T,{prop:"slower_than_avg_by",label:"慢于平均",width:"100"},{default:i(({row:d})=>[p(u(d.slower_than_avg_by)+"% ",1)]),_:1})]),_:1},8,["data"])])):h("",!0),s.value.recommendations&&s.value.recommendations.length>0?(r(),c("div",ht,[t[34]||(t[34]=e("h3",{class:"section-title"},"优化建议",-1)),e("div",wt,[(r(!0),c(j,null,W(s.value.recommendations,(d,Y)=>(r(),z(O,{key:Y,type:"info",title:d,closable:!1,"show-icon":""},null,8,["title"]))),128))])])):h("",!0)])):h("",!0)])):(r(),c("div",kt,[a(X,{description:"暂无报告数据"})])),a(te,{modelValue:C.value,"onUpdate:modelValue":t[2]||(t[2]=d=>C.value=d),title:"GIF回放",width:"800px","append-to-body":""},{default:i(()=>[s.value&&s.value.gif_path?(r(),c("div",Ct,[e("img",{src:q.value,alt:"Execution GIF",class:"gif-image"},null,8,Rt)])):h("",!0)]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])}}},St=ie(It,[["__scopeId","data-v-2861d9f1"]]);const $t={class:"page-container"},zt={class:"page-header"},Dt={class:"header-actions"},Vt={class:"card-container"},At={class:"pagination-container"},Et={key:0,class:"record-detail"},Pt={class:"detail-item"},Tt={class:"value"},Ft={class:"detail-item"},Ut={class:"detail-item"},Bt={class:"detail-item"},Mt={key:0,class:"detail-item mt-15"},Lt={key:1,class:"task-description-container"},Nt={class:"task-description-content"},Gt={class:"log-container"},Ot={class:"dialog-footer"},jt={__name:"AIExecutionRecords",setup(ee){const D=f([]),k=f(!1),F=f(0),m=ce({currentPage:1,pageSize:20}),R=f(!1),s=f(null);let b=null;const C=f([]),V=f(!1),A=f(null),w=f(!1),x=f(null),P=async()=>{k.value=!0;try{const n=await oe({page:m.currentPage,page_size:m.pageSize});D.value=n.data.results||[],F.value=n.data.count||0,A.value&&A.value.clearSelection()}catch(n){console.error("获取执行记录失败:",n),S.error("获取执行记录失败")}finally{k.value=!1}},q=()=>{m.currentPage=1,P()},B=()=>{P()},H=n=>{s.value=n,R.value=!0},J=n=>{x.value=n.id,w.value=!0},Z=()=>{s.value&&(x.value=s.value.id,w.value=!0)},M=n=>({pending:"info",running:"warning",passed:"success",failed:"danger"})[n]||"info",L=n=>({pending:"等待中",running:"执行中",passed:"成功",failed:"失败"})[n]||n,N=(n,l,I)=>I?new Date(I).toLocaleString():"",K=n=>(m.currentPage-1)*m.pageSize+n+1,G=n=>{C.value=n},o=async()=>{if(C.value.length!==0)try{await fe.confirm(`确定要删除选中的 ${C.value.length} 条记录吗？此操作不可恢复。`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"警告"}),V.value=!0;const n=C.value.map(l=>l.id);await he(n),S.success("删除成功"),D.value.length===n.length&&m.currentPage>1&&m.currentPage--,P()}catch(n){n!=="cancel"&&(console.error("批量删除失败:",n),S.error("批量删除失败"))}finally{V.value=!1}},t=()=>{b=setInterval(()=>{if(m.currentPage===1&&!R.value&&!k.value){if(!D.value.some(l=>l.status==="running"||l.status==="pending"))return;oe({page:1,page_size:m.pageSize}).then(l=>{C.value.length===0&&(D.value=l.data.results||[],F.value=l.data.count||0)}).catch(console.error)}},5e3)};return pe(()=>{P(),t()}),ve(()=>{b&&clearInterval(b)}),(n,l)=>{const I=_("el-icon"),g=_("el-button"),y=_("el-table-column"),$=_("el-tag"),E=_("el-table"),Q=_("el-pagination"),O=_("el-dialog"),T=_e("loading");return r(),c("div",$t,[e("div",zt,[l[6]||(l[6]=e("h1",{class:"page-title"},"AI 测试报告",-1)),e("div",Dt,[a(g,{type:"danger",disabled:C.value.length===0,onClick:o,loading:V.value},{default:i(()=>[a(I,null,{default:i(()=>[a(U(ge))]),_:1}),l[5]||(l[5]=p(" 批量删除 ",-1))]),_:1,__:[5]},8,["disabled","loading"])])]),e("div",Vt,[me((r(),z(E,{data:D.value,style:{width:"100%"},onSelectionChange:G,ref_key:"tableRef",ref:A},{default:i(()=>[a(y,{type:"selection",width:"55"}),a(y,{label:"序号",width:"80"},{default:i(({$index:v})=>[p(u(K(v)),1)]),_:1}),a(y,{prop:"case_name",label:"用例名称","min-width":"200","show-overflow-tooltip":""}),a(y,{prop:"status",label:"状态",width:"120"},{default:i(({row:v})=>[a($,{type:M(v.status)},{default:i(()=>[p(u(L(v.status)),1)]),_:2},1032,["type"])]),_:1}),a(y,{prop:"duration",label:"耗时(秒)",width:"120"},{default:i(({row:v})=>[p(u(v.duration?v.duration.toFixed(2):"-"),1)]),_:1}),a(y,{prop:"start_time",label:"开始时间",width:"180",formatter:N}),a(y,{prop:"executed_by.username",label:"执行人",width:"120"}),a(y,{label:"操作",width:"200",fixed:"right"},{default:i(({row:v})=>[a(g,{size:"small",onClick:X=>H(v)},{default:i(()=>l[7]||(l[7]=[p(" 查看详情 ",-1)])),_:2,__:[7]},1032,["onClick"]),a(g,{size:"small",type:"success",onClick:X=>J(v)},{default:i(()=>l[8]||(l[8]=[p(" 查看报告 ",-1)])),_:2,__:[8]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[T,k.value]]),e("div",At,[a(Q,{"current-page":m.currentPage,"onUpdate:currentPage":l[0]||(l[0]=v=>m.currentPage=v),"page-size":m.pageSize,"onUpdate:pageSize":l[1]||(l[1]=v=>m.pageSize=v),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:F.value,onSizeChange:q,onCurrentChange:B},null,8,["current-page","page-size","total"])])]),a(O,{modelValue:R.value,"onUpdate:modelValue":l[3]||(l[3]=v=>R.value=v),title:"执行详情",width:"800px"},{footer:i(()=>[e("div",Ot,[a(g,{type:"success",onClick:Z},{default:i(()=>l[15]||(l[15]=[p("查看报告",-1)])),_:1,__:[15]}),a(g,{onClick:l[2]||(l[2]=v=>R.value=!1)},{default:i(()=>l[16]||(l[16]=[p("关闭",-1)])),_:1,__:[16]})])]),default:i(()=>[s.value?(r(),c("div",Et,[e("div",Pt,[l[9]||(l[9]=e("span",{class:"label"},"用例名称:",-1)),e("span",Tt,u(s.value.case_name),1)]),e("div",Ft,[l[10]||(l[10]=e("span",{class:"label"},"状态:",-1)),a($,{type:M(s.value.status)},{default:i(()=>[p(u(L(s.value.status)),1)]),_:1},8,["type"])]),e("div",Ut,[l[11]||(l[11]=e("span",{class:"label"},"开始时间:",-1)),e("span",null,u(N(null,null,s.value.start_time)),1)]),e("div",Bt,[l[12]||(l[12]=e("span",{class:"label"},"耗时:",-1)),e("span",null,u(s.value.duration?s.value.duration.toFixed(2)+" 秒":"未知"),1)]),s.value.task_description?(r(),c("div",Mt,l[13]||(l[13]=[e("span",{class:"label"},"任务描述:",-1)]))):h("",!0),s.value.task_description?(r(),c("div",Lt,[e("div",Nt,u(s.value.task_description),1)])):h("",!0),l[14]||(l[14]=e("div",{class:"detail-item mt-15"},[e("span",{class:"label"},"执行日志:")],-1)),e("div",Gt,[e("pre",null,u(s.value.logs),1)])])):h("",!0)]),_:1},8,["modelValue"]),a(St,{modelValue:w.value,"onUpdate:modelValue":l[4]||(l[4]=v=>w.value=v),"record-id":x.value},null,8,["modelValue","record-id"])])}}},Jt=ie(jt,[["__scopeId","data-v-27ca3ee7"]]);export{Jt as default};
