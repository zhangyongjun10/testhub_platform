import{_ as pe,Q as me,u as ve,v as J,q as m,V as fe,x as _e,r as d,o as v,c as C,b as w,t as E,d as l,w as o,C as y,e as h,f as b,F as D,y as P,J as Y,g as L,U as O,B as ge,G as we}from"./index-054e2682.js";const he={class:"page-container"},ye={class:"page-header"},be={class:"page-title"},Ve={class:"form-container"},Ce={class:"testcase-selector"},Te={class:"search-bar"},je={class:"selected-testcases"},ke={key:0,class:"empty-tip"},xe={class:"testcase-selector-content"},Ue={__name:"ReviewForm",setup(Re){const q=me(),F=ve(),I=J(()=>!!q.params.id),$=m(),B=m(!1),T=m(!1),H=m(""),U=m(""),N=m([]),R=m([]),V=m([]),j=m([]),f=m([]),z=m([]),s=fe({title:"",description:"",projects:[],priority:"medium",deadline:"",testcases:[],reviewers:[],template:""}),Q={title:[{required:!0,message:"请输入评审标题",trigger:"blur"}],projects:[{required:!0,message:"请选择项目",trigger:"change"}],testcases:[{required:!0,message:"请选择要评审的用例",trigger:"change"}],reviewers:[{required:!0,message:"请选择评审人员",trigger:"change"}]},K=J(()=>U.value?j.value.filter(t=>t.title.toLowerCase().includes(U.value.toLowerCase())):j.value),W=async()=>{try{const t=await y.get("/projects/");N.value=t.data.results||t.data}catch{h.error("获取项目列表失败")}},X=async()=>{try{const t=await y.get("/auth/users/");R.value=t.data.results||t.data||[],console.log("All users:",R.value)}catch(t){console.error("获取用户列表失败:",t),h.error("获取用户列表失败"),R.value=[]}},A=async t=>{try{if(!t||t.length===0){j.value=[];return}const e=t.map(i=>y.get("/testcases/",{params:{project:i}})),r=await Promise.all(e),u=[];r.forEach(i=>{const n=i.data.results||i.data||[];u.push(...n)});const c=u.filter((i,n,p)=>n===p.findIndex(g=>g.id===i.id));j.value=c}catch(e){console.error("获取用例列表失败:",e)}},G=async t=>{try{if(!t||t.length===0){V.value=[];return}const e=t.map(i=>y.get("/reviews/review-templates/",{params:{project:i}})),r=await Promise.all(e),u=[];r.forEach(i=>{const n=i.data.results||i.data||[];u.push(...n)});const c=u.filter((i,n,p)=>n===p.findIndex(g=>g.id===i.id));V.value=c}catch(e){console.error("获取模板列表失败:",e)}},Z=t=>{t&&t.length>0?(A(t),G(t)):(j.value=[],V.value=[]),s.reviewers=[],s.testcases=[],f.value=[]},ee=()=>{if(!s.projects||s.projects.length===0){h.warning("请先选择项目");return}T.value=!0},te=t=>{z.value=t},le=()=>{f.value=[...z.value],s.testcases=f.value.map(t=>t.id),T.value=!1},ae=t=>{f.value=f.value.filter(e=>e.id!==t),s.testcases=f.value.map(e=>e.id)},se=()=>{},oe=async t=>{if(t)try{const e=V.value.find(r=>r.id===t);e&&(s.reviewers=e.default_reviewers.map(r=>r.id))}catch(e){console.error("应用模板失败:",e)}},re=async()=>{var t;if($.value)try{await $.value.validate(),B.value=!0;const e={...s,testcases:s.testcases,reviewers:s.reviewers,template:s.template||null};I.value?(await y.put(`/reviews/reviews/${q.params.id}/`,e),h.success("评审更新成功")):(await y.post("/reviews/reviews/",e),h.success("评审创建成功")),F.push("/ai-generation/reviews")}catch(e){if((t=e.response)!=null&&t.data){const r=Object.values(e.response.data).flat();h.error(r[0]||"保存失败")}else h.error("保存失败")}finally{B.value=!1}},ne=t=>({low:"低",medium:"中",high:"高",critical:"紧急"})[t]||t,ie=(t,e)=>{if(!e||e.length===0)return null;const r=t.projects.map(n=>n.id).sort(),u=t.assignments.map(n=>n.reviewer.id).sort();let c=null,i=0;for(const n of e){let p=0;const g=(n.project||[]).map(_=>_.id).sort(),M=r.filter(_=>g.includes(_));M.length>0&&(p+=M.length*2);const S=(n.default_reviewers||[]).map(_=>_.id).sort(),k=u.filter(_=>S.includes(_));k.length>0&&(p+=k.length),p>i&&(i=p,c=n)}return i>0?c:null},ue=async t=>{try{const r=(await y.get(`/reviews/reviews/${t}/`)).data;if(s.title=r.title,s.description=r.description,s.projects=r.projects.map(u=>u.id),s.priority=r.priority,s.deadline=r.deadline,s.reviewers=r.assignments.map(u=>u.reviewer.id),f.value=r.testcases,s.testcases=r.testcases.map(u=>u.id),s.projects.length>0){await A(s.projects),await G(s.projects);const u=ie(r,V.value);u&&(s.template=u.id)}}catch(e){console.error("获取评审数据失败:",e),h.error("获取评审数据失败"),F.push("/ai-generation/reviews")}};return _e(()=>{W(),X(),I.value&&ue(q.params.id)}),(t,e)=>{const r=d("el-button"),u=d("el-input"),c=d("el-form-item"),i=d("el-col"),n=d("el-option"),p=d("el-select"),g=d("el-row"),M=d("el-date-picker"),S=d("el-icon"),k=d("el-tag"),_=d("el-form"),x=d("el-table-column"),ce=d("el-table"),de=d("el-dialog");return v(),C("div",he,[w("div",ye,[w("h1",be,E(I.value?"编辑评审":"创建评审"),1),w("div",null,[l(r,{onClick:e[0]||(e[0]=a=>t.$router.back())},{default:o(()=>e[12]||(e[12]=[b("返回",-1)])),_:1,__:[12]}),l(r,{type:"primary",onClick:re,loading:B.value},{default:o(()=>e[13]||(e[13]=[b("保存",-1)])),_:1,__:[13]},8,["loading"])])]),w("div",Ve,[l(_,{model:s,rules:Q,ref_key:"formRef",ref:$,"label-width":"120px"},{default:o(()=>[l(g,{gutter:24},{default:o(()=>[l(i,{span:12},{default:o(()=>[l(c,{label:"评审标题",prop:"title"},{default:o(()=>[l(u,{modelValue:s.title,"onUpdate:modelValue":e[1]||(e[1]=a=>s.title=a),placeholder:"请输入评审标题"},null,8,["modelValue"])]),_:1})]),_:1}),l(i,{span:12},{default:o(()=>[l(c,{label:"关联项目",prop:"projects"},{default:o(()=>[l(p,{modelValue:s.projects,"onUpdate:modelValue":e[2]||(e[2]=a=>s.projects=a),multiple:"",placeholder:"请选择项目",onChange:Z},{default:o(()=>[(v(!0),C(D,null,P(N.value,a=>(v(),Y(n,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(g,{gutter:24},{default:o(()=>[l(i,{span:12},{default:o(()=>[l(c,{label:"优先级",prop:"priority"},{default:o(()=>[l(p,{modelValue:s.priority,"onUpdate:modelValue":e[3]||(e[3]=a=>s.priority=a),placeholder:"请选择优先级"},{default:o(()=>[l(n,{label:"低",value:"low"}),l(n,{label:"中",value:"medium"}),l(n,{label:"高",value:"high"}),l(n,{label:"紧急",value:"urgent"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(i,{span:12},{default:o(()=>[l(c,{label:"截止日期"},{default:o(()=>[l(M,{modelValue:s.deadline,"onUpdate:modelValue":e[4]||(e[4]=a=>s.deadline=a),type:"datetime",placeholder:"请选择截止日期",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(c,{label:"评审描述"},{default:o(()=>[l(u,{modelValue:s.description,"onUpdate:modelValue":e[5]||(e[5]=a=>s.description=a),type:"textarea",rows:4,placeholder:"请输入评审描述"},null,8,["modelValue"])]),_:1}),l(c,{label:"选择用例",prop:"testcases"},{default:o(()=>[w("div",Ce,[w("div",Te,[l(u,{modelValue:H.value,"onUpdate:modelValue":e[6]||(e[6]=a=>H.value=a),placeholder:"搜索用例",onInput:t.searchTestcases,clearable:""},{prefix:o(()=>[l(S,null,{default:o(()=>[l(L(O))]),_:1})]),_:1},8,["modelValue","onInput"]),l(r,{type:"primary",onClick:ee},{default:o(()=>e[14]||(e[14]=[b("选择用例",-1)])),_:1,__:[14]})]),w("div",je,[(v(!0),C(D,null,P(f.value,a=>(v(),Y(k,{key:a.id,closable:"",onClose:Me=>ae(a.id),class:"testcase-tag"},{default:o(()=>[b(E(a.title),1)]),_:2},1032,["onClose"]))),128)),f.value.length===0?(v(),C("div",ke," 请选择要评审的测试用例 ")):ge("",!0)])])]),_:1}),l(c,{label:"评审人员",prop:"reviewers"},{default:o(()=>[l(p,{modelValue:s.reviewers,"onUpdate:modelValue":e[7]||(e[7]=a=>s.reviewers=a),multiple:"",placeholder:"请选择评审人员",onChange:se},{default:o(()=>[(v(!0),C(D,null,P(R.value,a=>(v(),Y(n,{key:a.id,label:a.username,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"评审模板"},{default:o(()=>[l(p,{modelValue:s.template,"onUpdate:modelValue":e[8]||(e[8]=a=>s.template=a),placeholder:"可选择评审模板",onChange:oe},{default:o(()=>[(v(!0),C(D,null,P(V.value,a=>(v(),Y(n,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),l(de,{modelValue:T.value,"onUpdate:modelValue":e[11]||(e[11]=a=>T.value=a),title:"选择测试用例",width:"800px"},{footer:o(()=>[l(r,{onClick:e[10]||(e[10]=a=>T.value=!1)},{default:o(()=>e[15]||(e[15]=[b("取消",-1)])),_:1,__:[15]}),l(r,{type:"primary",onClick:le},{default:o(()=>e[16]||(e[16]=[b("确定",-1)])),_:1,__:[16]})]),default:o(()=>[w("div",xe,[l(u,{modelValue:U.value,"onUpdate:modelValue":e[9]||(e[9]=a=>U.value=a),placeholder:"搜索用例",onInput:t.searchTestcasesInDialog,clearable:""},{prefix:o(()=>[l(S,null,{default:o(()=>[l(L(O))]),_:1})]),_:1},8,["modelValue","onInput"]),l(ce,{data:K.value,onSelectionChange:te,"max-height":"400",class:"testcase-table"},{default:o(()=>[l(x,{type:"selection",width:"55"}),l(x,{prop:"title",label:"用例标题","min-width":"200","show-overflow-tooltip":""}),l(x,{prop:"test_type",label:"测试类型",width:"120"}),l(x,{prop:"priority",label:"优先级",width:"100"},{default:o(({row:a})=>[l(k,{class:we(`priority-tag ${a.priority}`)},{default:o(()=>[b(E(ne(a.priority)),1)]),_:2},1032,["class"])]),_:1}),l(x,{prop:"author.username",label:"作者",width:"120"})]),_:1},8,["data"])])]),_:1},8,["modelValue"])])}}},De=pe(Ue,[["__scopeId","data-v-7fc66a20"]]);export{De as default};
