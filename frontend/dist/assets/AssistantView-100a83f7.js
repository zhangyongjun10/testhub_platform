import{_ as ne,u as ae,a as ie,q as C,v as H,x as le,r as h,o as c,c as m,b as t,d as n,w as l,g as r,F as R,y as U,z as F,A as I,t as T,B as P,E as re,e as x,C as S,f as B,D as de,G as O,p as ce,H as ue,h as _e,i as ve,n as q,I as G,J,K as pe,L as me,M as fe}from"./index-054e2682.js";const ge={class:"assistant-layout"},he={class:"sidebar"},we={class:"new-chat-btn-wrapper"},ye={class:"history-list"},Ce={class:"session-scroll-area"},ke=["onClick"],xe={class:"session-title-wrapper"},Se=["title"],be={class:"user-profile"},Me={class:"user-info"},De={class:"username"},Ve={class:"main-content"},$e={key:0,class:"welcome-screen"},ze={class:"welcome-content"},Te={class:"logo-area"},Be={class:"logo-circle"},Ne={class:"center-input-wrapper"},Ae={class:"input-actions"},Ie={class:"suggestion-chips"},Ke={key:1,class:"chat-screen"},Le={class:"chat-header"},Ee={class:"chat-title"},He={key:0,class:"chat-time"},Re={class:"avatar"},Ue={class:"message-bubble"},Fe=["innerHTML"],Pe={key:0,class:"message-status"},Oe={class:"chat-footer"},qe={class:"input-box"},Ge={__name:"AssistantView",setup(Je){const K=ae(),L=ie(),v=C([]),a=C(null),d=C([]),u=C(""),k=C(!1),b=C(null),j=s=>{s==="logout"?Q():s==="home"&&K.push("/home")},Q=()=>{re.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{L.logout(),K.push("/login"),x.success("已退出登录")}).catch(()=>{})},W=H(()=>[...v.value].sort((s,e)=>new Date(e.updated_at)-new Date(s.updated_at))),X=H(()=>!a.value||!a.value.id&&d.value.length===0),Y=s=>{if(!s)return"";const e=new Date(s),i=new Date;return e.toDateString()===i.toDateString()?e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):e.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})},Z=s=>s?s.replace(/\n/g,"<br>").replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>").replace(/`([^`]+)`/g,"<code>$1</code>"):"",N=()=>{fe(()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)})},A=()=>{a.value={title:"新会话"},d.value=[],u.value=""},ee=async s=>{var e;if(((e=a.value)==null?void 0:e.id)!==s.id)try{a.value={...s};const i=await S.get(`/assistant/sessions/${s.id}/messages/`);d.value=i.data,N()}catch(i){console.error("加载消息失败:",i),x.error("加载消息失败")}},se=async s=>{var e;try{await S.delete(`/assistant/sessions/${s}/`),v.value=v.value.filter(i=>i.id!==s),((e=a.value)==null?void 0:e.id)===s&&A(),x.success("会话已删除")}catch(i){console.error("删除会话失败:",i),x.error("删除会话失败")}},M=s=>{u.value=s,D()},E=s=>{!s.shiftKey&&!k.value&&D()},D=async()=>{var p,V,w;const s=u.value.trim();if(!s||k.value)return;u.value="",k.value=!0;const e={role:"user",content:s,created_at:new Date().toISOString()};d.value.push(e);const i={role:"assistant",content:"",isPending:!0};d.value.push(i),N();try{let _=(p=a.value)==null?void 0:p.id,$=!1;if(_)_=a.value.session_id;else{$=!0;const f=`session_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,g=s.length>10?s.substring(0,10)+"...":s,o=await S.post("/assistant/sessions/",{session_id:f,title:g});a.value=o.data,_=a.value.session_id,v.value.unshift(a.value)}const y=await S.post("/assistant/chat/send_message/",{session_id:_,message:s},{timeout:6e4});if(d.value.pop(),d.value.pop(),d.value.push(y.data.user_message),d.value.push(y.data.assistant_message),y.data.conversation_id&&a.value&&(a.value.conversation_id=y.data.conversation_id),!$){const f=v.value.findIndex(g=>g.id===a.value.id);if(f!==-1){v.value[f]={...a.value,updated_at:new Date().toISOString()};const g=v.value.splice(f,1)[0];v.value.unshift(g)}}}catch(_){console.error("发送失败:",_),d.value.pop(),x.error(((w=(V=_.response)==null?void 0:V.data)==null?void 0:w.error)||"发送失败，请重试")}finally{k.value=!1,N()}},te=async()=>{try{const s=await S.get("/assistant/sessions/");v.value=s.data.results||s.data||[]}catch(s){console.error("加载历史失败:",s)}};return le(()=>{te(),A()}),(s,e)=>{var g;const i=h("el-button"),p=h("el-icon"),V=h("el-popconfirm"),w=h("el-avatar"),_=h("el-dropdown-item"),$=h("el-dropdown-menu"),y=h("el-dropdown"),f=h("el-input");return c(),m("div",ge,[t("div",he,[t("div",we,[n(i,{type:"primary",class:"new-chat-btn",onClick:A,icon:r(de)},{default:l(()=>e[7]||(e[7]=[B(" 新会话 ",-1)])),_:1,__:[7]},8,["icon"])]),t("div",ye,[e[8]||(e[8]=t("div",{class:"history-label"},"历史会话",-1)),t("div",Ce,[(c(!0),m(R,null,U(W.value,o=>{var z;return c(),m("div",{key:o.id,class:O(["session-item",{active:((z=a.value)==null?void 0:z.id)===o.id}]),onClick:oe=>ee(o)},[t("div",xe,[n(p,{class:"chat-icon"},{default:l(()=>[n(r(ce))]),_:1}),t("span",{class:"session-title",title:o.title},T(o.title||"新会话"),9,Se)]),t("div",{class:"session-actions",onClick:e[0]||(e[0]=I(()=>{},["stop"]))},[n(V,{title:"确定删除此会话吗？",onConfirm:oe=>se(o.id)},{reference:l(()=>[n(p,{class:"delete-icon"},{default:l(()=>[n(r(ue))]),_:1})]),_:2},1032,["onConfirm"])])],10,ke)}),128))])]),t("div",be,[n(y,{trigger:"click",onCommand:j},{dropdown:l(()=>[n($,null,{default:l(()=>[n(_,{command:"home"},{default:l(()=>e[9]||(e[9]=[B("返回首页",-1)])),_:1,__:[9]}),n(_,{command:"logout",divided:""},{default:l(()=>e[10]||(e[10]=[B("退出登录",-1)])),_:1,__:[10]})]),_:1})]),default:l(()=>{var o;return[t("div",Me,[n(w,{size:32,icon:r(_e)},null,8,["icon"]),t("span",De,T(((o=r(L).user)==null?void 0:o.username)||"用户"),1),n(p,{class:"el-icon--right"},{default:l(()=>[n(r(ve))]),_:1})])]}),_:1})])]),t("div",Ve,[X.value?(c(),m("div",$e,[t("div",ze,[t("div",Te,[t("div",Be,[n(p,null,{default:l(()=>[n(r(q))]),_:1})]),e[11]||(e[11]=t("h1",null,"AI 评测师",-1)),e[12]||(e[12]=t("p",null,"我是您的专业测试助手，有什么可以帮您？",-1))]),t("div",Ne,[n(f,{modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=o=>u.value=o),type:"textarea",rows:3,placeholder:"输入您的问题，按回车发送...",class:"center-input",resize:"none",onKeydown:F(I(E,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),t("div",Ae,[n(i,{type:"primary",circle:"",icon:r(G),disabled:!u.value.trim(),onClick:D},null,8,["icon","disabled"])])]),t("div",Ie,[t("div",{class:"chip",onClick:e[2]||(e[2]=o=>M("如何设计登录接口的测试用例？"))},"接口测试用例"),t("div",{class:"chip",onClick:e[3]||(e[3]=o=>M("帮我生成一份性能测试计划模板"))},"性能测试计划"),t("div",{class:"chip",onClick:e[4]||(e[4]=o=>M("解释一下边界值分析法"))},"测试理论"),t("div",{class:"chip",onClick:e[5]||(e[5]=o=>M("Python Selenium 元素定位失败怎么办？"))},"自动化调试")])])])):(c(),m("div",Ke,[t("div",Le,[t("span",Ee,T(((g=a.value)==null?void 0:g.title)||"新会话"),1),a.value?(c(),m("span",He,T(Y(a.value.updated_at)),1)):P("",!0)]),t("div",{class:"messages-container",ref_key:"messagesContainer",ref:b},[(c(!0),m(R,null,U(d.value,(o,z)=>(c(),m("div",{key:o.id||z,class:O(["message-row",o.role])},[t("div",Re,[o.role==="user"?(c(),J(w,{key:0,size:36,icon:r(pe),class:"user-avatar"},null,8,["icon"])):(c(),J(w,{key:1,size:36,icon:r(q),class:"ai-avatar"},null,8,["icon"]))]),t("div",Ue,[t("div",{class:"message-content",innerHTML:Z(o.content)},null,8,Fe),o.isPending?(c(),m("div",Pe,[n(p,{class:"is-loading"},{default:l(()=>[n(r(me))]),_:1}),e[13]||(e[13]=B(" 思考中... ",-1))])):P("",!0)])],2))),128)),e[14]||(e[14]=t("div",{style:{height:"20px"}},null,-1))],512),t("div",Oe,[t("div",qe,[n(f,{modelValue:u.value,"onUpdate:modelValue":e[6]||(e[6]=o=>u.value=o),type:"textarea",rows:1,autosize:{minRows:1,maxRows:5},placeholder:"输入消息...",resize:"none",onKeydown:F(I(E,["exact","prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),n(i,{type:"primary",class:"send-btn",disabled:!u.value.trim()||k.value,onClick:D},{default:l(()=>[n(p,null,{default:l(()=>[n(r(G))]),_:1})]),_:1},8,["disabled"])]),e[15]||(e[15]=t("div",{class:"footer-tip"},"内容由 AI 生成，请仔细甄别",-1))])]))])])}}},Qe=ne(Ge,[["__scopeId","data-v-50e8edc3"]]);export{Qe as default};
