import{_ as I,U as K,q as z,V as U,v as O,x as W,r as i,S as j,o as y,c as L,b as d,d as t,w as a,N as J,J as x,e as q,z as A,f as p,t as _,B as E,F as G,y as H}from"./index-054e2682.js";import{Y as Q}from"./ui_automation-53e326f9.js";const X={name:"NotificationLogs",components:{Search:K},setup(){const D=z(!1),s=z([]),V=z(!1),e=z(null),g=U({taskName:"",dateRange:[],status:""}),u=U({currentPage:1,pageSize:10,total:0}),m=U({prop:"created_at",order:"descending"}),h=async()=>{D.value=!0;try{const o={page:u.currentPage,page_size:u.pageSize,ordering:m.order==="ascending"?m.prop:`-${m.prop}`};g.taskName&&(o.search=g.taskName),g.dateRange&&g.dateRange.length===2&&(o.start_date=g.dateRange[0],o.end_date=g.dateRange[1]),g.status&&(o.status=g.status);const l=await Q(o);s.value=l.data.results||[],u.total=l.data.count||0}catch(o){console.error("获取通知日志失败:",o),q.error("获取通知日志失败")}finally{D.value=!1}},T=()=>{u.currentPage=1,h()},r=()=>{g.taskName="",g.dateRange=[],g.status="",u.currentPage=1,h()},R=o=>{u.pageSize=o,u.currentPage=1,h()},v=o=>{u.currentPage=o,h()},F=({prop:o,order:l})=>{m.prop=o,m.order=l||"descending",h()},C=o=>{e.value=o,V.value=!0},N=o=>{e.value=null,o()},b=o=>o?new Date(o).toLocaleString("zh-CN"):"-",k=o=>({发送成功:"success",success:"success",发送失败:"danger",failed:"danger",待发送:"info",pending:"info",发送中:"warning",sending:"warning",已取消:"info",cancelled:"info"})[o]||"info",P=o=>({邮箱通知:"",Webhook机器人:"primary",两种都发送:"warning"})[o]||"info",M=O(()=>{if(!e.value||!e.value.notification_content)return null;const o=e.value.notification_content;try{const l=JSON.parse(o),w=[];let c="";if(l.msgtype==="markdown"&&l.markdown?l.markdown.text?c=l.markdown.text:l.markdown.content&&(c=l.markdown.content):l.msg_type==="interactive"&&l.card&&l.card.elements&&l.card.elements[0]&&l.card.elements[0].text&&(c=l.card.elements[0].text.content),c)return c.split(`
`).filter(n=>n.trim()).forEach(n=>{if(n.includes("**")||n.trim()==="")return;const f=n.indexOf(":");if(f>0){const Y=n.substring(0,f).trim(),B=n.substring(f+1).trim();Y&&B&&w.push({label:Y,value:B})}}),w.length>0?w:null}catch{console.log("尝试解析为纯文本格式")}try{const l=[];return o.split(`
`).filter(c=>c.trim()).forEach(c=>{if(!c.trim())return;const S=c.indexOf(":");if(S>0){const n=c.substring(0,S).trim(),f=c.substring(S+1).trim();n&&f&&!f.includes("'results':")&&!f.includes('"results":')&&l.push({label:n,value:f})}}),l.length>0?l:null}catch(l){return console.error("解析通知内容失败:",l),null}});return W(()=>{h()}),{loading:D,logsData:s,detailDialogVisible:V,selectedLog:e,searchForm:g,pagination:u,sortParams:m,parsedNotificationContent:M,handleSearch:T,handleReset:r,handleSizeChange:R,handleCurrentChange:v,handleSortChange:F,viewDetail:C,handleDetailDialogClose:N,formatDate:b,getStatusTagType:k,getNotificationTypeTagType:P}}},Z={class:"notification-logs-container"},$={class:"page-actions"},ee={class:"logs-table-container"},te={class:"pagination-container"},ae={class:"webhook-info"},ne={class:"notification-content"},oe={key:0,class:"notification-content-parsed"},le={class:"content-label"},se={class:"content-value"},ie={key:1,class:"notification-content-raw"},re={class:"error-message"},ce={class:"dialog-footer"};function de(D,s,V,e,g,u){const m=i("Search"),h=i("el-icon"),T=i("el-input"),r=i("el-col"),R=i("el-date-picker"),v=i("el-option"),F=i("el-select"),C=i("el-button"),N=i("el-row"),b=i("el-table-column"),k=i("el-tag"),P=i("el-table"),M=i("el-pagination"),o=i("el-form-item"),l=i("el-alert"),w=i("el-form"),c=i("el-dialog"),S=j("loading");return y(),L("div",Z,[d("div",$,[t(N,{gutter:20,class:"filter-row"},{default:a(()=>[t(r,{span:6},{default:a(()=>[t(T,{modelValue:e.searchForm.taskName,"onUpdate:modelValue":s[0]||(s[0]=n=>e.searchForm.taskName=n),placeholder:"搜索任务名称",clearable:"",onClear:e.handleSearch,onKeyup:A(e.handleSearch,["enter"])},{prefix:a(()=>[t(h,null,{default:a(()=>[t(m)]),_:1})]),_:1},8,["modelValue","onClear","onKeyup"])]),_:1}),t(r,{span:6},{default:a(()=>[t(R,{modelValue:e.searchForm.dateRange,"onUpdate:modelValue":s[1]||(s[1]=n=>e.searchForm.dateRange=n),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",onChange:e.handleSearch},null,8,["modelValue","onChange"])]),_:1}),t(r,{span:6},{default:a(()=>[t(F,{modelValue:e.searchForm.status,"onUpdate:modelValue":s[2]||(s[2]=n=>e.searchForm.status=n),placeholder:"通知状态",clearable:"",onChange:e.handleSearch},{default:a(()=>[t(v,{label:"全部状态",value:""}),t(v,{label:"成功",value:"SUCCESS"}),t(v,{label:"失败",value:"FAILED"}),t(v,{label:"重试中",value:"RETRYING"})]),_:1},8,["modelValue","onChange"])]),_:1}),t(r,{span:6},{default:a(()=>[t(C,{type:"primary",onClick:e.handleSearch},{default:a(()=>[t(h,null,{default:a(()=>[t(m)]),_:1}),s[7]||(s[7]=p(" 搜索 ",-1))]),_:1,__:[7]},8,["onClick"]),t(C,{onClick:e.handleReset},{default:a(()=>s[8]||(s[8]=[p(" 重置 ",-1)])),_:1,__:[8]},8,["onClick"])]),_:1})]),_:1})]),d("div",ee,[J((y(),x(P,{data:e.logsData,"element-loading-text":"加载中...",stripe:"",style:{width:"100%"},onSortChange:e.handleSortChange},{default:a(()=>[t(b,{prop:"task_name",label:"任务名称","min-width":"150",sortable:"custom"}),t(b,{prop:"task_type_display",label:"任务类型","min-width":"100"},{default:a(({row:n})=>[t(k,{type:"info",size:"small"},{default:a(()=>[p(_(n.task_type_display),1)]),_:2},1024)]),_:1}),t(b,{prop:"actual_notification_type_display",label:"通知类型","min-width":"120"},{default:a(({row:n})=>[t(k,{type:e.getNotificationTypeTagType(n.actual_notification_type_display),size:"small"},{default:a(()=>[p(_(n.actual_notification_type_display),1)]),_:2},1032,["type"])]),_:1}),t(b,{prop:"created_at",label:"通知时间","min-width":"180",sortable:"custom"},{default:a(({row:n})=>[p(_(e.formatDate(n.created_at)),1)]),_:1}),t(b,{prop:"status_display",label:"状态","min-width":"100",sortable:"custom"},{default:a(({row:n})=>[t(k,{type:e.getStatusTagType(n.status_display),size:"small"},{default:a(()=>[p(_(n.status_display),1)]),_:2},1032,["type"])]),_:1}),t(b,{label:"操作",fixed:"right",width:"120"},{default:a(({row:n})=>[t(C,{type:"primary",link:"",size:"small",onClick:f=>e.viewDetail(n)},{default:a(()=>s[9]||(s[9]=[p(" 查看详情 ",-1)])),_:2,__:[9]},1032,["onClick"])]),_:1})]),_:1},8,["data","onSortChange"])),[[S,e.loading]]),d("div",te,[t(M,{"current-page":e.pagination.currentPage,"onUpdate:currentPage":s[3]||(s[3]=n=>e.pagination.currentPage=n),"page-size":e.pagination.pageSize,"onUpdate:pageSize":s[4]||(s[4]=n=>e.pagination.pageSize=n),"page-sizes":[10,20,50,100],total:e.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:e.handleSizeChange,onCurrentChange:e.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),t(c,{modelValue:e.detailDialogVisible,"onUpdate:modelValue":s[6]||(s[6]=n=>e.detailDialogVisible=n),title:"通知详情",width:"600px","before-close":e.handleDetailDialogClose},{footer:a(()=>[d("span",ce,[t(C,{onClick:s[5]||(s[5]=n=>e.detailDialogVisible=!1)},{default:a(()=>s[10]||(s[10]=[p("关闭",-1)])),_:1,__:[10]})])]),default:a(()=>[e.selectedLog?(y(),x(w,{key:0,"label-position":"top",class:"notification-detail-form"},{default:a(()=>[t(N,{gutter:20},{default:a(()=>[t(r,{span:12},{default:a(()=>[t(o,{label:"任务名称"},{default:a(()=>[d("span",null,_(e.selectedLog.task_name),1)]),_:1})]),_:1}),t(r,{span:12},{default:a(()=>[t(o,{label:"任务类型"},{default:a(()=>[d("span",null,_(e.selectedLog.task_type_display),1)]),_:1})]),_:1}),t(r,{span:12},{default:a(()=>[t(o,{label:"通知类型"},{default:a(()=>[t(k,{type:e.getNotificationTypeTagType(e.selectedLog.actual_notification_type_display)},{default:a(()=>[p(_(e.selectedLog.actual_notification_type_display),1)]),_:1},8,["type"])]),_:1})]),_:1}),t(r,{span:12},{default:a(()=>[t(o,{label:"状态"},{default:a(()=>[t(k,{type:e.getStatusTagType(e.selectedLog.status_display)},{default:a(()=>[p(_(e.selectedLog.status_display),1)]),_:1},8,["type"])]),_:1})]),_:1}),t(r,{span:12},{default:a(()=>[t(o,{label:"通知时间"},{default:a(()=>[d("span",null,_(e.formatDate(e.selectedLog.created_at)),1)]),_:1})]),_:1}),t(r,{span:12},{default:a(()=>[t(o,{label:"发送时间"},{default:a(()=>[d("span",null,_(e.selectedLog.sent_at?e.formatDate(e.selectedLog.sent_at):"-"),1)]),_:1})]),_:1}),e.selectedLog.webhook_bot_info&&(e.selectedLog.webhook_bot_info.bot_type||e.selectedLog.webhook_bot_info.type)?(y(),x(r,{key:0,span:24},{default:a(()=>[t(o,{label:"Webhook机器人"},{default:a(()=>[d("div",ae,[t(k,{class:"webhook-tag",size:"small",type:"info"},{default:a(()=>[p(_(e.selectedLog.webhook_bot_info.name||e.selectedLog.webhook_bot_info.bot_name||"Webhook机器人"),1)]),_:1})])]),_:1})]),_:1})):E("",!0),t(r,{span:24},{default:a(()=>[t(o,{label:"通知内容"},{default:a(()=>[d("div",ne,[e.parsedNotificationContent?(y(),L("div",oe,[(y(!0),L(G,null,H(e.parsedNotificationContent,(n,f)=>(y(),L("div",{class:"content-item",key:f},[d("span",le,_(n.label)+":",1),d("span",se,_(n.value),1)]))),128))])):(y(),L("div",ie,[d("pre",null,_(e.selectedLog.notification_content||"-"),1)]))])]),_:1})]),_:1}),e.selectedLog.error_message?(y(),x(r,{key:1,span:24},{default:a(()=>[t(o,{label:"错误信息"},{default:a(()=>[d("div",re,[t(l,{title:e.selectedLog.error_message,type:"error","show-icon":"",closable:!1},null,8,["title"])])]),_:1})]),_:1})):E("",!0)]),_:1})]),_:1})):E("",!0)]),_:1},8,["modelValue","before-close"])])}const fe=I(X,[["render",de],["__scopeId","data-v-3c96373a"]]);export{fe as default};
