import{_ as We,q as f,V as Ye,v as He,x as Je,r as p,S as Qe,o as y,c as b,b as n,d as l,w as a,t as m,N as Xe,J as E,R as Ze,C as h,e as u,M as et,g as k,D as ue,f as r,F as U,y as F,ao as de,G as ce,ap as tt,af as lt,ae as st,ac as at,a2 as ot,B as pe,E as _e}from"./index-054e2682.js";const nt={class:"automation-testing"},rt={class:"header"},it={class:"content-layout"},ut={class:"sidebar"},dt={class:"project-selector"},ct={class:"suite-list"},pt={class:"list-header"},_t=["onClick"],mt={class:"suite-info"},vt={class:"suite-name"},ft={class:"suite-meta"},wt={class:"main-content"},yt={key:0,class:"empty-state"},gt={key:1,class:"suite-detail"},ht={class:"suite-header"},bt={class:"suite-title"},kt={class:"suite-actions"},qt={class:"suite-description"},Ct={class:"suite-meta"},xt={class:"meta-text"},Et={class:"meta-text"},Tt={class:"requests-section"},Vt={class:"section-header"},St={class:"executions-section"},jt={class:"section-header"},$t={style:{color:"#67c23a"}},Rt={style:{color:"#f56c6c"}},Dt={class:"add-request-content"},Nt={class:"request-selector"},At={class:"request-tree-node"},Lt={key:0,class:"execution-detail"},Pt={class:"execution-summary"},Mt={class:"execution-results"},Bt={__name:"AutomationTesting",setup(Ut){const T=f([]),g=f(null),D=f([]),d=f(null),Q=f([]),z=f([]),X=f([]),I=f(!1),O=f(!1),x=f(!1),V=f(!1),S=f(!1),C=f(null),G=f(!1),K=f(!1),q=f(null),N=f(),A=f(),w=Ye({name:"",description:"",project:null,environment:null}),me={name:[{required:!0,message:"请输入套件名称",trigger:"blur"}],project:[{required:!0,message:"请选择项目",trigger:"change"}]},ve={children:"children",label:"name"},Z=He(()=>T.value.filter(t=>t.project_type!=="WEBSOCKET")),ee=t=>({GET:"success",POST:"primary",PUT:"warning",DELETE:"danger",PATCH:"info"})[t]||"info",fe=t=>({PENDING:"info",RUNNING:"warning",COMPLETED:"success",FAILED:"danger",CANCELLED:"info"})[t]||"info",we=t=>({PENDING:"待执行",RUNNING:"执行中",COMPLETED:"已完成",FAILED:"执行失败",CANCELLED:"已取消"})[t]||t,te=t=>Ze(t).format("YYYY-MM-DD HH:mm:ss"),ye=t=>{if(!t.results||!Array.isArray(t.results)||t.results.length===0)return"-";const o=t.results.reduce((i,v)=>i+(v.response_time||0),0)/t.results.length;return o<1e3?`${Math.round(o)}ms`:`${(o/1e3).toFixed(1)}s`},ge=t=>t.total_requests===0?0:(t.passed_requests/t.total_requests*100).toFixed(1),he=t=>{if(!t)return"无环境";const e=z.value.find(o=>o.id===t);return e?e.name:"无环境"},be=async()=>{try{const t=await h.get("/api-testing/projects/");T.value=t.data.results||t.data;const e=T.value.filter(o=>o.project_type!=="WEBSOCKET");e.length>0&&!g.value?(g.value=e[0].id,await se()):e.length===0&&(g.value=null)}catch{u.error("加载项目失败")}},j=async()=>{if(g.value)try{const t=await h.get("/api-testing/test-suites/",{params:{project:g.value}});D.value=t.data.results||t.data}catch{u.error("加载测试套件失败")}},ke=async()=>{try{const t=await h.get("/api-testing/environments/",{}),e=t.data.results||t.data;z.value=e.filter(o=>o.scope==="GLOBAL"||o.scope==="LOCAL"&&(!g.value||o.project===g.value))}catch{u.error("加载环境失败")}},le=async()=>{if(g.value)try{const t=await h.get("/api-testing/collections/",{params:{project:g.value}}),e=t.data.results||t.data,o=await h.get("/api-testing/requests/"),i=o.data.results||o.data;X.value=qe(e,i)}catch{u.error("加载请求树失败")}},qe=(t,e)=>{const o={},i=[];return t.forEach(v=>{o[v.id]={...v,type:"collection",children:[]}}),t.forEach(v=>{v.parent&&o[v.parent]?o[v.parent].children.push(o[v.id]):i.push(o[v.id])}),e.forEach(v=>{o[v.collection]&&o[v.collection].children.push({...v,type:"request",id:`request_${v.id}`})}),i},W=async()=>{if(d.value){O.value=!0;try{const t=await h.get("/api-testing/test-executions/",{params:{test_suite:d.value.id}});Q.value=t.data.results||t.data}catch{u.error("加载执行历史失败")}finally{O.value=!1}}},se=async()=>{const t=T.value.find(e=>e.id===g.value);if(t&&t.project_type==="WEBSOCKET"){u.warning("WebSocket项目不支持测试套件功能");const e=T.value.filter(o=>o.project_type!=="WEBSOCKET");e.length>0?g.value=e[0].id:g.value=null;return}d.value=null,await Promise.all([j(),ke(),le()])},Ce=t=>{d.value=t,W()},xe=async({action:t,suite:e})=>{switch(t){case"run":await ae(e);break;case"edit":oe(e);break;case"duplicate":await Ee(e);break;case"delete":await Te(e);break}},ae=async t=>{I.value=!0;try{const e=await h.post(`/api-testing/test-suites/${t.id}/execute/`);q.value=e.data,S.value=!0,await W(),u.success("测试套件执行完成")}catch{u.error("执行测试套件失败")}finally{I.value=!1}},oe=t=>{C.value=t,w.name=t.name,w.description=t.description,w.project=t.project,w.environment=t.environment||null,x.value=!0},Ee=async t=>{try{const e={name:`${t.name} - 副本`,description:t.description,project:t.project,environment:t.environment||null};await h.post("/api-testing/test-suites/",e),u.success("复制成功"),await j()}catch{u.error("复制失败")}},Te=async t=>{var e;try{await _e.confirm(`确定要删除测试套件 "${t.name}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await h.delete(`/api-testing/test-suites/${t.id}/`),u.success("删除成功"),((e=d.value)==null?void 0:e.id)===t.id&&(d.value=null),await j()}catch(o){o!=="cancel"&&u.error("删除失败")}},Ve=async()=>{if(!(!N.value||!await N.value.validate().catch(()=>!1))){G.value=!0;try{C.value?(await h.put(`/api-testing/test-suites/${C.value.id}/`,w),u.success("更新成功")):(await h.post("/api-testing/test-suites/",w),u.success("创建成功")),x.value=!1,await j()}catch{u.error(C.value?"更新失败":"创建失败")}finally{G.value=!1}}},Se=()=>{var t;C.value=null,Object.assign(w,{name:"",description:"",project:g.value,environment:null}),(t=N.value)==null||t.resetFields()},je=async()=>{await le(),V.value=!0,et(()=>{setTimeout(()=>{var t;if(A.value&&d.value){const e=((t=d.value.suite_requests)==null?void 0:t.map(o=>`request_${o.request.id}`))||[];A.value.setCheckedKeys(e,!1),console.log("设置已关联接口ID:",e)}},200)})},$e=()=>{},Re=async()=>{const e=A.value.getCheckedNodes().filter(o=>o.type==="request").map(o=>o.id.replace("request_",""));if(e.length===0){u.warning("请选择至少一个请求");return}K.value=!0;try{await h.post(`/api-testing/test-suites/${d.value.id}/add-requests/`,{request_ids:e}),u.success("添加成功"),V.value=!1,await ne()}catch{u.error("添加失败")}finally{K.value=!1}},De=async t=>{try{await h.put(`/api-testing/test-suite-requests/${t.id}/`,{enabled:t.enabled})}catch{u.error("更新失败"),t.enabled=!t.enabled}},Ne=t=>{u.info("断言编辑功能开发中")},Ae=async t=>{try{await _e.confirm("确定要移除这个请求吗？","确认移除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await h.delete(`/api-testing/test-suite-requests/${t.id}/`),u.success("移除成功"),await ne()}catch(e){e!=="cancel"&&u.error("移除失败")}},ne=async()=>{if(d.value)try{const e=(await h.get(`/api-testing/test-suites/${d.value.id}/`)).data;d.value={...e};const o=D.value.findIndex(i=>i.id===e.id);o!==-1&&(D.value[o]={...e})}catch{u.error("刷新测试套件失败")}},Le=t=>{q.value=t,S.value=!0},Pe=t=>!t||!Array.isArray(t)?[]:t;return Je(()=>{be()}),(t,e)=>{var ie;const o=p("el-icon"),i=p("el-button"),v=p("el-option"),Y=p("el-select"),L=p("el-dropdown-item"),Me=p("el-dropdown-menu"),Be=p("el-dropdown"),Ue=p("el-scrollbar"),Fe=p("el-empty"),$=p("el-tag"),c=p("el-table-column"),ze=p("el-switch"),H=p("el-table"),re=p("el-input"),P=p("el-form-item"),Ie=p("el-form"),J=p("el-dialog"),Oe=p("el-tree"),M=p("el-statistic"),B=p("el-col"),Ge=p("el-row"),Ke=Qe("loading");return y(),b("div",nt,[n("div",rt,[e[15]||(e[15]=n("h3",null,"自动化测试",-1)),l(i,{type:"primary",onClick:e[0]||(e[0]=s=>x.value=!0)},{default:a(()=>[l(o,null,{default:a(()=>[l(k(ue))]),_:1}),e[14]||(e[14]=r(" 新建测试套件 ",-1))]),_:1,__:[14]})]),n("div",it,[n("div",ut,[n("div",dt,[l(Y,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=s=>g.value=s),placeholder:"选择项目",onChange:se,style:{width:"100%"}},{default:a(()=>[(y(!0),b(U,null,F(Z.value,s=>(y(),E(v,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",ct,[n("div",pt,[e[16]||(e[16]=n("span",null,"测试套件",-1)),l(i,{size:"small",text:"",onClick:j},{default:a(()=>[l(o,null,{default:a(()=>[l(k(de))]),_:1})]),_:1})]),l(Ue,{height:"400px"},{default:a(()=>[(y(!0),b(U,null,F(D.value,s=>{var _,R;return y(),b("div",{key:s.id,class:ce(["suite-item",{active:((_=d.value)==null?void 0:_.id)===s.id}]),onClick:Ft=>Ce(s)},[n("div",mt,[n("div",vt,m(s.name),1),n("div",ft,m(((R=s.suite_requests)==null?void 0:R.length)||0)+" 个请求 ",1)]),l(Be,{onCommand:xe,trigger:"click"},{dropdown:a(()=>[l(Me,null,{default:a(()=>[l(L,{command:{action:"run",suite:s}},{default:a(()=>e[17]||(e[17]=[r("运行",-1)])),_:2,__:[17]},1032,["command"]),l(L,{command:{action:"edit",suite:s}},{default:a(()=>e[18]||(e[18]=[r("编辑",-1)])),_:2,__:[18]},1032,["command"]),l(L,{command:{action:"duplicate",suite:s}},{default:a(()=>e[19]||(e[19]=[r("复制",-1)])),_:2,__:[19]},1032,["command"]),l(L,{command:{action:"delete",suite:s},divided:""},{default:a(()=>e[20]||(e[20]=[r("删除",-1)])),_:2,__:[20]},1032,["command"])]),_:2},1024)]),default:a(()=>[l(i,{size:"small",text:""},{default:a(()=>[l(o,null,{default:a(()=>[l(k(tt))]),_:1})]),_:1})]),_:2},1024)],10,_t)}),128))]),_:1})])]),n("div",wt,[d.value?(y(),b("div",gt,[n("div",ht,[n("div",bt,[n("h4",null,m(d.value.name),1),n("div",kt,[l(i,{type:"success",onClick:e[2]||(e[2]=s=>ae(d.value)),loading:I.value},{default:a(()=>[l(o,null,{default:a(()=>[l(k(lt))]),_:1}),e[21]||(e[21]=r(" 运行测试 ",-1))]),_:1,__:[21]},8,["loading"]),l(i,{onClick:e[3]||(e[3]=s=>oe(d.value))},{default:a(()=>[l(o,null,{default:a(()=>[l(k(st))]),_:1}),e[22]||(e[22]=r(" 编辑 ",-1))]),_:1,__:[22]})])]),n("div",qt,m(d.value.description||"暂无描述"),1),n("div",Ct,[l($,{size:"small"},{default:a(()=>[r(m(he(d.value.environment)),1)]),_:1}),n("span",xt,"创建者："+m((ie=d.value.created_by)==null?void 0:ie.username),1),n("span",Et,"创建时间："+m(te(d.value.created_at)),1)])]),n("div",Tt,[n("div",Vt,[e[24]||(e[24]=n("h5",null,"测试请求",-1)),l(i,{size:"small",onClick:je},{default:a(()=>[l(o,null,{default:a(()=>[l(k(ue))]),_:1}),e[23]||(e[23]=r(" 添加请求 ",-1))]),_:1,__:[23]})]),l(H,{data:d.value.suite_requests,style:{width:"100%"}},{default:a(()=>[l(c,{type:"index",width:"50"}),l(c,{prop:"request.name",label:"请求名称","min-width":"200"}),l(c,{prop:"request.method",label:"方法",width:"80"},{default:a(s=>[l($,{type:ee(s.row.request.method),size:"small"},{default:a(()=>[r(m(s.row.request.method),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"request.url",label:"URL","min-width":"300","show-overflow-tooltip":""}),l(c,{prop:"enabled",label:"启用",width:"80"},{default:a(s=>[l(ze,{modelValue:s.row.enabled,"onUpdate:modelValue":_=>s.row.enabled=_,onChange:_=>De(s.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(c,{label:"断言",width:"100"},{default:a(s=>{var _;return[r(m(((_=s.row.assertions)==null?void 0:_.length)||0)+" 个 ",1)]}),_:1}),l(c,{label:"操作",width:"150"},{default:a(s=>[l(i,{link:"",type:"primary",onClick:_=>Ne(s.row),size:"small"},{default:a(()=>e[25]||(e[25]=[r(" 编辑断言 ",-1)])),_:2,__:[25]},1032,["onClick"]),l(i,{link:"",type:"danger",onClick:_=>Ae(s.row),size:"small"},{default:a(()=>e[26]||(e[26]=[r(" 移除 ",-1)])),_:2,__:[26]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),n("div",St,[n("div",jt,[e[28]||(e[28]=n("h5",null,"执行历史",-1)),l(i,{size:"small",onClick:W},{default:a(()=>[l(o,null,{default:a(()=>[l(k(de))]),_:1}),e[27]||(e[27]=r(" 刷新 ",-1))]),_:1,__:[27]})]),Xe((y(),E(H,{data:Q.value},{default:a(()=>[l(c,{prop:"status",label:"状态",width:"100"},{default:a(s=>[l($,{type:fe(s.row.status)},{default:a(()=>[r(m(we(s.row.status)),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"total_requests",label:"总请求数",width:"100"}),l(c,{prop:"passed_requests",label:"通过数",width:"100"},{default:a(s=>[n("span",$t,m(s.row.passed_requests),1)]),_:1}),l(c,{prop:"failed_requests",label:"失败数",width:"100"},{default:a(s=>[n("span",Rt,m(s.row.failed_requests),1)]),_:1}),l(c,{label:"平均耗时",width:"120"},{default:a(s=>[r(m(ye(s.row)),1)]),_:1}),l(c,{prop:"executed_by.username",label:"执行者",width:"120"}),l(c,{prop:"created_at",label:"执行时间",width:"160"},{default:a(s=>[r(m(te(s.row.created_at)),1)]),_:1}),l(c,{label:"操作",width:"120"},{default:a(s=>[l(i,{link:"",type:"primary",onClick:_=>Le(s.row),size:"small"},{default:a(()=>e[29]||(e[29]=[r(" 查看详情 ",-1)])),_:2,__:[29]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ke,O.value]])])])):(y(),b("div",yt,[l(Fe,{description:"请选择一个测试套件查看详情"})]))])]),l(J,{modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=s=>x.value=s),title:C.value?"编辑测试套件":"新建测试套件",width:"600px",onClose:Se},{footer:a(()=>[l(i,{onClick:e[8]||(e[8]=s=>x.value=!1)},{default:a(()=>e[30]||(e[30]=[r("取消",-1)])),_:1,__:[30]}),l(i,{type:"primary",onClick:Ve,loading:G.value},{default:a(()=>[r(m(C.value?"更新":"创建"),1)]),_:1},8,["loading"])]),default:a(()=>[l(Ie,{ref_key:"suiteFormRef",ref:N,model:w,rules:me,"label-width":"100px"},{default:a(()=>[l(P,{label:"套件名称",prop:"name"},{default:a(()=>[l(re,{modelValue:w.name,"onUpdate:modelValue":e[4]||(e[4]=s=>w.name=s),placeholder:"请输入套件名称"},null,8,["modelValue"])]),_:1}),l(P,{label:"套件描述",prop:"description"},{default:a(()=>[l(re,{modelValue:w.description,"onUpdate:modelValue":e[5]||(e[5]=s=>w.description=s),type:"textarea",rows:3,placeholder:"请输入套件描述"},null,8,["modelValue"])]),_:1}),l(P,{label:"所属项目",prop:"project"},{default:a(()=>[l(Y,{modelValue:w.project,"onUpdate:modelValue":e[6]||(e[6]=s=>w.project=s),placeholder:"请选择项目"},{default:a(()=>[(y(!0),b(U,null,F(Z.value,s=>(y(),E(v,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(P,{label:"执行环境",prop:"environment"},{default:a(()=>[l(Y,{modelValue:w.environment,"onUpdate:modelValue":e[7]||(e[7]=s=>w.environment=s),placeholder:"请选择执行环境",clearable:""},{default:a(()=>[(y(!0),b(U,null,F(z.value,s=>(y(),E(v,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(J,{modelValue:V.value,"onUpdate:modelValue":e[11]||(e[11]=s=>V.value=s),title:"添加请求到测试套件",width:"800px"},{footer:a(()=>[l(i,{onClick:e[10]||(e[10]=s=>V.value=!1)},{default:a(()=>e[31]||(e[31]=[r("取消",-1)])),_:1,__:[31]}),l(i,{type:"primary",onClick:Re,loading:K.value},{default:a(()=>e[32]||(e[32]=[r(" 添加选中的请求 ",-1)])),_:1,__:[32]},8,["loading"])]),default:a(()=>[n("div",Dt,[n("div",Nt,[l(Oe,{ref_key:"requestTreeRef",ref:A,data:X.value,props:ve,"show-checkbox":"","node-key":"id","check-on-click-node":!1,onCheck:$e},{default:a(({node:s,data:_})=>{var R;return[n("div",At,[_.type==="collection"?(y(),E(o,{key:0},{default:a(()=>[l(k(at))]),_:1})):(y(),E(o,{key:1},{default:a(()=>[l(k(ot))]),_:1})),n("span",null,m(_.name),1),_.type==="request"?(y(),b("span",{key:2,class:ce(["method-tag",(R=_.method)==null?void 0:R.toLowerCase()])},m(_.method),3)):pe("",!0)])]}),_:1},8,["data"])])])]),_:1},8,["modelValue"]),l(J,{modelValue:S.value,"onUpdate:modelValue":e[13]||(e[13]=s=>S.value=s),title:"测试执行结果",width:"80%",top:"5vh"},{footer:a(()=>[l(i,{onClick:e[12]||(e[12]=s=>S.value=!1)},{default:a(()=>e[34]||(e[34]=[r("关闭",-1)])),_:1,__:[34]})]),default:a(()=>[q.value?(y(),b("div",Lt,[n("div",Pt,[l(Ge,{gutter:20},{default:a(()=>[l(B,{span:6},{default:a(()=>[l(M,{title:"总请求数",value:q.value.total_requests},null,8,["value"])]),_:1}),l(B,{span:6},{default:a(()=>[l(M,{title:"通过数",value:q.value.passed_requests},null,8,["value"])]),_:1}),l(B,{span:6},{default:a(()=>[l(M,{title:"失败数",value:q.value.failed_requests},null,8,["value"])]),_:1}),l(B,{span:6},{default:a(()=>[l(M,{title:"通过率",value:ge(q.value),suffix:"%"},null,8,["value"])]),_:1})]),_:1})]),n("div",Mt,[e[33]||(e[33]=n("h4",null,"详细结果",-1)),l(H,{data:Pe(q.value.results)},{default:a(()=>[l(c,{prop:"name",label:"请求名称","min-width":"200"}),l(c,{prop:"method",label:"方法",width:"80"},{default:a(s=>[l($,{type:ee(s.row.method),size:"small"},{default:a(()=>[r(m(s.row.method),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"status",label:"结果",width:"100"},{default:a(s=>[l($,{type:s.row.passed?"success":"danger",size:"small"},{default:a(()=>[r(m(s.row.passed?"通过":"失败"),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"status_code",label:"状态码",width:"100"}),l(c,{prop:"response_time",label:"响应时间",width:"120"},{default:a(s=>{var _;return[r(m((_=s.row.response_time)==null?void 0:_.toFixed(0))+"ms ",1)]}),_:1}),l(c,{prop:"error",label:"错误信息","min-width":"200","show-overflow-tooltip":""})]),_:1},8,["data"])])])):pe("",!0)]),_:1},8,["modelValue"])])}}},It=We(Bt,[["__scopeId","data-v-8e616426"]]);export{It as default};
