import{_ as Ce,q as y,V as F,x as Se,e as m,r as i,S as xe,o as d,c as A,b as u,d as l,w as a,N as h,J as _,g as ee,D as Ue,f as r,t as b,B as w,i as Ae,F as D,y as R,C as te,E as Ie}from"./index-054e2682.js";import{c as Ne,e as De,f as Re,h as qe,i as Pe,u as Oe,j as Le,r as ze,k as Fe,l as Be}from"./api-testing-1acf99db.js";const Me={class:"scheduled-tasks"},$e={class:"header"},je={class:"filters"},Qe={class:"task-list"},Je={class:"pagination"},We={class:"cron-help"},Ge={class:"time-cell"},He={class:"time-cell"},Ke={__name:"ScheduledTasks",setup(Xe){const B=y([]),M=y([]),$=y([]),j=y([]),Q=y([]),J=y([]),q=y(!1),P=y(!1),O=y(!1),C=y(!1),L=y(!1),E=y(null),V=F({task_type:"",trigger_type:"",status:""}),T=F({current:1,size:10,total:0}),o=F({name:"",description:"",task_type:"TEST_SUITE",trigger_type:"CRON",cron_expression:"0 0 * * *",interval_seconds:3600,execute_at:"",test_suite:"",api_request:"",environment:"",notify_on_success:!1,notify_on_failure:!1,notify_emails:[]});Se(()=>{g(),le(),ae(),oe(),ne()});const g=async()=>{q.value=!0;try{const n={page:T.current,page_size:T.size,...V},e=await Ne(n);B.value=e.data.results,T.total=e.data.count}catch{m.error("加载任务列表失败")}finally{q.value=!1}},le=async()=>{try{const n=await De();$.value=n.data.results}catch(n){console.error("加载测试套件失败:",n)}},ae=async()=>{try{const n=await Re();j.value=n.data.results}catch(n){console.error("加载API请求失败:",n)}},oe=async()=>{try{const n=await qe();Q.value=n.data.results}catch(n){console.error("加载环境失败:",n)}},ne=async()=>{try{const n=await Pe(),e=n.data.results||n.data;J.value=e.map(f=>({...f,display_name:f.first_name?`${f.first_name}（${f.email}）`:`${f.username}（${f.email}）`}))}catch(n){console.error("加载用户列表失败:",n)}},se=()=>{console.log("新建按钮点击"),E.value=null,W(),C.value=!0},W=()=>{Object.assign(o,{name:"",description:"",task_type:"TEST_SUITE",trigger_type:"CRON",cron_expression:"0 0 * * *",interval_seconds:3600,execute_at:"",test_suite:"",api_request:"",environment:"",notify_on_success:!1,notify_on_failure:!1,notification_type:"email",notify_emails:[]})},re=()=>{Object.assign(V,{task_type:"",trigger_type:"",status:""}),g()},ie=async()=>{var n,e,f,v;O.value=!0;try{const s={name:o.name,description:o.description,task_type:o.task_type,trigger_type:o.trigger_type,notify_on_success:o.notify_on_success,notify_on_failure:o.notify_on_failure,notification_type_input:o.notification_type,notify_emails:o.notify_emails,environment:o.environment};o.trigger_type==="CRON"?s.cron_expression=o.cron_expression:o.trigger_type==="INTERVAL"?s.interval_seconds=o.interval_seconds:o.trigger_type==="ONCE"&&(s.execute_at=o.execute_at),o.task_type==="TEST_SUITE"?s.test_suite=o.test_suite:o.task_type==="API_REQUEST"&&(s.api_request=o.api_request),E.value?(await Oe(E.value.id,s),m.success("更新任务成功")):(await Le(s),m.success("创建任务成功")),C.value=!1,g()}catch(s){console.error("任务操作失败:",s),m.error(((e=(n=s.response)==null?void 0:n.data)==null?void 0:e.error)||((v=(f=s.response)==null?void 0:f.data)==null?void 0:v.detail)||(E.value?"更新任务失败":"创建任务失败"))}finally{O.value=!1}},ue=async n=>{try{n.running=!0,await ze(n.id),m.success("任务已开始执行"),setTimeout(()=>{g()},2e3)}catch{m.error("执行任务失败")}finally{n.running=!1}},I=n=>n?new Date(n).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-"):"-",de=n=>({邮箱通知:"",Webhook机器人:"primary",两种都发送:"warning"})[n]||"info",_e=async n=>{P.value=!0;try{const e=await Be(n.id);M.value=e.data.results||e.data,L.value=!0}catch(e){console.error("加载执行日志失败:",e),m.error("加载执行日志失败")}finally{P.value=!1}},pe=(n,e)=>{switch(n){case"pause":fe(e);break;case"activate":ce(e);break;case"edit":me(e);break;case"logs":_e(e);break;case"delete":ye(e);break}},me=n=>{E.value=n,Object.assign(o,{name:n.name,description:n.description,task_type:n.task_type,trigger_type:n.trigger_type,cron_expression:n.cron_expression,interval_seconds:n.interval_seconds,execute_at:n.execute_at,test_suite:n.test_suite||null,api_request:n.api_request||null,environment:n.environment||null,notify_on_success:n.notify_on_success,notify_on_failure:n.notify_on_failure,notification_type:n.notification_type||"email",notify_emails:n.notify_emails||[]}),console.log("编辑任务数据回显:",{test_suite:n.test_suite,environment:n.environment,taskForm_test_suite:o.test_suite,taskForm_environment:o.environment}),C.value=!0},fe=async n=>{try{await te.post(`/api-testing/scheduled-tasks/${n.id}/pause/`),m.success("任务已暂停"),g()}catch(e){console.error("暂停任务失败:",e),m.error("暂停任务失败")}},ce=async n=>{try{await te.post(`/api-testing/scheduled-tasks/${n.id}/activate/`),m.success("任务已激活"),g()}catch{m.error("激活任务失败")}},ye=async n=>{try{await Ie.confirm("确定要删除这个定时任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Fe(n.id),m.success("删除任务成功"),g()}catch(e){e!=="cancel"&&m.error("删除任务失败")}};return(n,e)=>{const f=i("el-icon"),v=i("el-button"),s=i("el-option"),k=i("el-select"),N=i("el-col"),ge=i("el-row"),c=i("el-table-column"),S=i("el-tag"),x=i("el-dropdown-item"),ve=i("el-dropdown-menu"),be=i("el-dropdown"),G=i("el-table"),we=i("el-pagination"),z=i("el-input"),p=i("el-form-item"),U=i("el-radio"),H=i("el-radio-group"),Ve=i("el-tooltip"),Te=i("el-input-number"),ke=i("el-date-picker"),K=i("el-checkbox"),Ee=i("el-form"),X=i("el-dialog"),Y=xe("loading");return d(),A("div",Me,[u("div",$e,[e[23]||(e[23]=u("h3",null,"定时任务管理",-1)),l(v,{type:"primary",onClick:se},{default:a(()=>[l(f,null,{default:a(()=>[l(ee(Ue))]),_:1}),e[22]||(e[22]=r(" 新建定时任务 ",-1))]),_:1,__:[22]})]),u("div",je,[l(ge,{gutter:20},{default:a(()=>[l(N,{span:6},{default:a(()=>[l(k,{modelValue:V.task_type,"onUpdate:modelValue":e[0]||(e[0]=t=>V.task_type=t),placeholder:"任务类型",clearable:""},{default:a(()=>[l(s,{label:"测试套件执行",value:"TEST_SUITE"}),l(s,{label:"API请求执行",value:"API_REQUEST"})]),_:1},8,["modelValue"])]),_:1}),l(N,{span:6},{default:a(()=>[l(k,{modelValue:V.trigger_type,"onUpdate:modelValue":e[1]||(e[1]=t=>V.trigger_type=t),placeholder:"触发器类型",clearable:""},{default:a(()=>[l(s,{label:"Cron表达式",value:"CRON"}),l(s,{label:"固定间隔",value:"INTERVAL"}),l(s,{label:"单次执行",value:"ONCE"})]),_:1},8,["modelValue"])]),_:1}),l(N,{span:6},{default:a(()=>[l(k,{modelValue:V.status,"onUpdate:modelValue":e[2]||(e[2]=t=>V.status=t),placeholder:"任务状态",clearable:""},{default:a(()=>[l(s,{label:"激活",value:"ACTIVE"}),l(s,{label:"暂停",value:"PAUSED"}),l(s,{label:"已完成",value:"COMPLETED"}),l(s,{label:"失败",value:"FAILED"})]),_:1},8,["modelValue"])]),_:1}),l(N,{span:6},{default:a(()=>[l(v,{onClick:re},{default:a(()=>e[24]||(e[24]=[r("重置",-1)])),_:1,__:[24]}),l(v,{type:"primary",onClick:g},{default:a(()=>e[25]||(e[25]=[r("搜索",-1)])),_:1,__:[25]})]),_:1})]),_:1})]),u("div",Qe,[h((d(),_(G,{data:B.value},{default:a(()=>[l(c,{prop:"name",label:"任务名称","min-width":"200"}),l(c,{prop:"task_type",label:"任务类型",width:"120"},{default:a(t=>[l(S,{type:t.row.task_type==="TEST_SUITE"?"success":"primary"},{default:a(()=>[r(b(t.row.task_type==="TEST_SUITE"?"测试套件":"API请求"),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"trigger_type",label:"触发器类型",width:"120"},{default:a(t=>[l(S,null,{default:a(()=>[r(b(t.row.trigger_type==="CRON"?"Cron":t.row.trigger_type==="INTERVAL"?"间隔":"单次"),1)]),_:2},1024)]),_:1}),l(c,{prop:"status",label:"状态",width:"100"},{default:a(t=>[l(S,{type:t.row.status==="ACTIVE"?"success":t.row.status==="PAUSED"?"warning":"info"},{default:a(()=>[r(b(t.row.status==="ACTIVE"?"激活":t.row.status==="PAUSED"?"暂停":"完成"),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"notification_type_display",label:"通知类型",width:"120"},{default:a(t=>[l(S,{type:de(t.row.notification_type_display),size:"small"},{default:a(()=>[r(b(t.row.notification_type_display||"-"),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"next_run_time",label:"下次执行时间",width:"180"},{default:a(t=>[r(b(I(t.row.next_run_time)),1)]),_:1}),l(c,{prop:"last_run_time",label:"上次执行时间",width:"180"},{default:a(t=>[r(b(I(t.row.last_run_time)),1)]),_:1}),l(c,{label:"操作",width:"200",fixed:"right"},{default:a(t=>[l(v,{size:"small",onClick:Z=>ue(t.row),loading:t.row.running},{default:a(()=>e[26]||(e[26]=[r(" 立即执行 ",-1)])),_:2,__:[26]},1032,["onClick","loading"]),l(be,{onCommand:Z=>pe(Z,t.row)},{dropdown:a(()=>[l(ve,null,{default:a(()=>[l(x,{command:"edit"},{default:a(()=>e[28]||(e[28]=[r("编辑",-1)])),_:1,__:[28]}),t.row.status==="ACTIVE"?(d(),_(x,{key:0,command:"pause"},{default:a(()=>e[29]||(e[29]=[r("暂停",-1)])),_:1,__:[29]})):w("",!0),t.row.status==="PAUSED"?(d(),_(x,{key:1,command:"activate"},{default:a(()=>e[30]||(e[30]=[r("激活",-1)])),_:1,__:[30]})):w("",!0),l(x,{command:"logs"},{default:a(()=>e[31]||(e[31]=[r("执行日志",-1)])),_:1,__:[31]}),l(x,{command:"delete",divided:""},{default:a(()=>e[32]||(e[32]=[r("删除",-1)])),_:1,__:[32]})]),_:2},1024)]),default:a(()=>[l(v,{size:"small"},{default:a(()=>[e[27]||(e[27]=r(" 更多",-1)),l(f,null,{default:a(()=>[l(ee(Ae))]),_:1})]),_:1,__:[27]})]),_:2},1032,["onCommand"])]),_:1})]),_:1},8,["data"])),[[Y,q.value]])]),u("div",Je,[l(we,{"current-page":T.current,"onUpdate:currentPage":e[3]||(e[3]=t=>T.current=t),"page-size":T.size,"onUpdate:pageSize":e[4]||(e[4]=t=>T.size=t),total:T.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:g,onCurrentChange:g},null,8,["current-page","page-size","total"])]),l(X,{modelValue:C.value,"onUpdate:modelValue":e[20]||(e[20]=t=>C.value=t),title:E.value?"编辑定时任务":"新建定时任务",width:"800px",onClose:W},{footer:a(()=>[l(v,{onClick:e[19]||(e[19]=t=>C.value=!1)},{default:a(()=>e[43]||(e[43]=[r("取消",-1)])),_:1,__:[43]}),l(v,{type:"primary",onClick:ie,loading:O.value},{default:a(()=>[r(b(E.value?"更新":"创建"),1)]),_:1},8,["loading"])]),default:a(()=>[l(Ee,{model:o,"label-width":"120px"},{default:a(()=>[l(p,{label:"任务名称",required:""},{default:a(()=>[l(z,{modelValue:o.name,"onUpdate:modelValue":e[5]||(e[5]=t=>o.name=t),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),l(p,{label:"任务描述"},{default:a(()=>[l(z,{modelValue:o.description,"onUpdate:modelValue":e[6]||(e[6]=t=>o.description=t),type:"textarea",placeholder:"请输入任务描述"},null,8,["modelValue"])]),_:1}),l(p,{label:"任务类型",required:""},{default:a(()=>[l(H,{modelValue:o.task_type,"onUpdate:modelValue":e[7]||(e[7]=t=>o.task_type=t)},{default:a(()=>[l(U,{label:"TEST_SUITE"},{default:a(()=>e[33]||(e[33]=[r("测试套件执行",-1)])),_:1,__:[33]}),l(U,{label:"API_REQUEST"},{default:a(()=>e[34]||(e[34]=[r("API请求执行",-1)])),_:1,__:[34]})]),_:1},8,["modelValue"])]),_:1}),l(p,{label:"触发器类型",required:""},{default:a(()=>[l(H,{modelValue:o.trigger_type,"onUpdate:modelValue":e[8]||(e[8]=t=>o.trigger_type=t)},{default:a(()=>[l(U,{label:"CRON"},{default:a(()=>e[35]||(e[35]=[r("Cron表达式",-1)])),_:1,__:[35]}),l(U,{label:"INTERVAL"},{default:a(()=>e[36]||(e[36]=[r("固定间隔",-1)])),_:1,__:[36]}),l(U,{label:"ONCE"},{default:a(()=>e[37]||(e[37]=[r("单次执行",-1)])),_:1,__:[37]})]),_:1},8,["modelValue"])]),_:1}),o.trigger_type==="CRON"?(d(),_(p,{key:0,label:"Cron表达式",required:""},{default:a(()=>[l(z,{modelValue:o.cron_expression,"onUpdate:modelValue":e[9]||(e[9]=t=>o.cron_expression=t),placeholder:"0 0 * * *"},null,8,["modelValue"]),u("div",We,[l(Ve,{"raw-content":"",placement:"top"},{content:a(()=>e[38]||(e[38]=[u("div",{style:{"line-height":"1.6","text-align":"left"}},[u("div",null,"Cron表达式格式: 分 时 日 月 周"),u("div",null,"• 分: 0-59"),u("div",null,"• 时: 0-23"),u("div",null,"• 日: 1-31"),u("div",null,"• 月: 1-12 或 JAN-DEC"),u("div",null,"• 周: 0-6 或 SUN-SAT (0=周日)"),u("div",{style:{"margin-top":"8px"}},"常用示例:"),u("div",null,"• 每天0点: 0 0 * * *"),u("div",null,"• 每小时: 0 * * * *"),u("div",null,"• 每周一9点: 0 9 * * 1"),u("div",null,"• 每月1号0点: 0 0 1 * *")],-1)])),default:a(()=>[e[39]||(e[39]=u("span",{style:{cursor:"pointer",color:"#409EFF"}},"Cron帮助信息",-1))]),_:1,__:[39]})])]),_:1})):w("",!0),o.trigger_type==="INTERVAL"?(d(),_(p,{key:1,label:"间隔时间",required:""},{default:a(()=>[l(Te,{modelValue:o.interval_seconds,"onUpdate:modelValue":e[10]||(e[10]=t=>o.interval_seconds=t),min:60,step:60},null,8,["modelValue"]),e[40]||(e[40]=u("span",{class:"unit"},"秒",-1))]),_:1,__:[40]})):w("",!0),o.trigger_type==="ONCE"?(d(),_(p,{key:2,label:"执行时间",required:""},{default:a(()=>[l(ke,{modelValue:o.execute_at,"onUpdate:modelValue":e[11]||(e[11]=t=>o.execute_at=t),type:"datetime",placeholder:"选择执行时间"},null,8,["modelValue"])]),_:1})):w("",!0),o.task_type==="TEST_SUITE"?(d(),_(p,{key:3,label:"测试套件",required:""},{default:a(()=>[l(k,{modelValue:o.test_suite,"onUpdate:modelValue":e[12]||(e[12]=t=>o.test_suite=t),placeholder:"请选择测试套件"},{default:a(()=>[(d(!0),A(D,null,R($.value,t=>(d(),_(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):w("",!0),o.task_type==="API_REQUEST"?(d(),_(p,{key:4,label:"API请求",required:""},{default:a(()=>[l(k,{modelValue:o.api_request,"onUpdate:modelValue":e[13]||(e[13]=t=>o.api_request=t),placeholder:"请选择API请求"},{default:a(()=>[(d(!0),A(D,null,R(j.value,t=>(d(),_(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):w("",!0),l(p,{label:"执行环境"},{default:a(()=>[l(k,{modelValue:o.environment,"onUpdate:modelValue":e[14]||(e[14]=t=>o.environment=t),placeholder:"请选择执行环境"},{default:a(()=>[(d(!0),A(D,null,R(Q.value,t=>(d(),_(s,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(p,{label:"通知设置"},{default:a(()=>[l(K,{modelValue:o.notify_on_success,"onUpdate:modelValue":e[15]||(e[15]=t=>o.notify_on_success=t)},{default:a(()=>e[41]||(e[41]=[r("执行成功时通知",-1)])),_:1,__:[41]},8,["modelValue"]),l(K,{modelValue:o.notify_on_failure,"onUpdate:modelValue":e[16]||(e[16]=t=>o.notify_on_failure=t)},{default:a(()=>e[42]||(e[42]=[r("执行失败时通知",-1)])),_:1,__:[42]},8,["modelValue"])]),_:1}),o.notify_on_success||o.notify_on_failure?(d(),_(p,{key:5,label:"通知类型"},{default:a(()=>[l(k,{modelValue:o.notification_type,"onUpdate:modelValue":e[17]||(e[17]=t=>o.notification_type=t),placeholder:"请选择通知类型"},{default:a(()=>[l(s,{label:"邮箱通知",value:"email"}),l(s,{label:"Webhook机器人",value:"webhook"}),l(s,{label:"两种都发送",value:"both"})]),_:1},8,["modelValue"])]),_:1})):w("",!0),(o.notify_on_success||o.notify_on_failure)&&o.notification_type!=="webhook"?(d(),_(p,{key:6,label:"通知邮箱"},{default:a(()=>[l(k,{modelValue:o.notify_emails,"onUpdate:modelValue":e[18]||(e[18]=t=>o.notify_emails=t),multiple:"",filterable:"",placeholder:"请选择通知邮箱"},{default:a(()=>[(d(!0),A(D,null,R(J.value,t=>(d(),_(s,{key:t.id,label:t.display_name,value:t.email},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):w("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(X,{modelValue:L.value,"onUpdate:modelValue":e[21]||(e[21]=t=>L.value=t),title:"任务执行日志",width:"1000px"},{default:a(()=>[h((d(),_(G,{data:M.value},{default:a(()=>[l(c,{prop:"start_time",label:"开始时间",width:"180"},{default:a(t=>[u("div",Ge,b(I(t.row.start_time)),1)]),_:1}),l(c,{prop:"end_time",label:"结束时间",width:"180"},{default:a(t=>[u("div",He,b(I(t.row.end_time)),1)]),_:1}),l(c,{prop:"status",label:"状态",width:"100"},{default:a(t=>[l(S,{type:t.row.status==="COMPLETED"?"success":"danger"},{default:a(()=>[r(b(t.row.status==="COMPLETED"?"成功":"失败"),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"error_message",label:"错误信息",width:"300","show-overflow-tooltip":""})]),_:1},8,["data"])),[[Y,P.value]])]),_:1},8,["modelValue"])])}}},he=Ce(Ke,[["__scopeId","data-v-940f592c"]]);export{he as default};
