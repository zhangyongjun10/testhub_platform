import{_ as ge,q as n,V as be,x as ye,r,S as Ve,o as i,c as V,b as m,J as g,w as a,B as R,d as l,N as he,C as h,e as u,E as G,g as Y,H as we,f as d,t as w,D as je,U as xe,F as q,y as H,R as ke}from"./index-054e2682.js";const Ce={class:"page-container"},$e={class:"page-header"},Be={class:"header-actions"},De={class:"card-container"},Ue={class:"filter-bar"},ze={class:"version-name"},Fe={key:0,class:"project-tags"},Se={key:1,class:"no-project"},Te={class:"pagination-container"},Ne={__name:"VersionList",setup(Ee){const B=n(!1),I=n([]),D=n([]),b=n(1),J=n(20),O=n(0),U=n(""),z=n(""),F=n(""),v=n([]),S=n(!1),y=n(!1),T=n(),N=n(!1),j=n(!1),E=n(null),s=be({name:"",description:"",project_ids:[],is_baseline:!1}),K={name:[{required:!0,message:"请输入版本名称",trigger:"blur"}],project_ids:[{required:!0,message:"请选择关联项目",trigger:"change"}]},f=async()=>{B.value=!0;try{const o={page:b.value,search:U.value,projects:z.value,is_baseline:F.value},e=await h.get("/versions/",{params:o});I.value=e.data.results||[],O.value=e.data.count||0}catch{u.error("获取版本列表失败")}finally{B.value=!1}},Q=async()=>{try{const o=await h.get("/projects/");D.value=o.data.results||o.data||[]}catch{u.error("获取项目列表失败")}},W=()=>{b.value=1,f()},A=()=>{b.value=1,f()},X=()=>{f()},Z=()=>{j.value=!1,ne(),y.value=!0},ee=o=>{j.value=!0,E.value=o.id,s.name=o.name,s.description=o.description,s.project_ids=o.projects.map(e=>e.id),s.is_baseline=o.is_baseline,y.value=!0},te=async()=>{var o;if(T.value)try{await T.value.validate(),N.value=!0,j.value?(await h.put(`/versions/${E.value}/`,s),u.success("版本更新成功")):(await h.post("/versions/",s),u.success("版本创建成功")),y.value=!1,f()}catch(e){if((o=e.response)!=null&&o.data){const p=Object.values(e.response.data).flat();u.error(p[0]||"保存失败")}else u.error("保存失败")}finally{N.value=!1}},le=async o=>{try{await G.confirm("确定要删除这个版本吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await h.delete(`/versions/${o.id}/`),u.success("版本删除成功"),f()}catch(e){e!=="cancel"&&u.error("版本删除失败")}},ae=o=>{v.value=o},oe=o=>(b.value-1)*J.value+o+1,se=async()=>{if(v.value.length===0){u.warning("请先选择要删除的版本");return}try{await G.confirm(`确定要删除选中的 ${v.value.length} 个版本吗？此操作不可恢复。`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),S.value=!0;let o=0,e=0;for(const p of v.value)try{await h.delete(`/versions/${p.id}/`),o++}catch(_){console.error(`删除版本 ${p.id} 失败:`,_),e++}o>0?u.success(`成功删除 ${o} 个版本${e>0?`，${e} 个失败`:""}`):u.error("删除失败"),v.value=[],f()}catch(o){o!=="cancel"&&(console.error("批量删除失败:",o),u.error("批量删除失败: "+(o.message||"未知错误")))}finally{S.value=!1}},ne=()=>{s.name="",s.description="",s.project_ids=[],s.is_baseline=!1,E.value=null},re=o=>ke(o).format("YYYY-MM-DD HH:mm"),ie=o=>o.map(e=>e.name).join("、");return ye(()=>{Q(),f()}),(o,e)=>{const p=r("el-icon"),_=r("el-button"),M=r("el-input"),P=r("el-col"),x=r("el-option"),L=r("el-select"),ue=r("el-row"),c=r("el-table-column"),k=r("el-tag"),de=r("el-tooltip"),ce=r("el-table"),pe=r("el-pagination"),C=r("el-form-item"),_e=r("el-checkbox"),me=r("el-form"),ve=r("el-dialog"),fe=Ve("loading");return i(),V("div",Ce,[m("div",$e,[e[11]||(e[11]=m("h1",{class:"page-title"},"版本管理",-1)),m("div",Be,[v.value.length>0?(i(),g(_,{key:0,type:"danger",onClick:se,disabled:S.value},{default:a(()=>[l(p,null,{default:a(()=>[l(Y(we))]),_:1}),d(" 批量删除 ("+w(v.value.length)+") ",1)]),_:1},8,["disabled"])):R("",!0),l(_,{type:"primary",onClick:Z},{default:a(()=>[l(p,null,{default:a(()=>[l(Y(je))]),_:1}),e[10]||(e[10]=d(" 新建版本 ",-1))]),_:1,__:[10]})])]),m("div",De,[m("div",Ue,[l(ue,{gutter:20},{default:a(()=>[l(P,{span:6},{default:a(()=>[l(M,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=t=>U.value=t),placeholder:"搜索版本名称",clearable:"",onInput:W},{prefix:a(()=>[l(p,null,{default:a(()=>[l(Y(xe))]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(P,{span:4},{default:a(()=>[l(L,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=t=>z.value=t),placeholder:"关联项目",clearable:"",onChange:A},{default:a(()=>[(i(!0),V(q,null,H(D.value,t=>(i(),g(x,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(P,{span:3},{default:a(()=>[l(L,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=t=>F.value=t),placeholder:"版本类型",clearable:"",onChange:A},{default:a(()=>[l(x,{label:"基线版本",value:!0}),l(x,{label:"普通版本",value:!1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),he((i(),g(ce,{data:I.value,style:{width:"100%"},onSelectionChange:ae},{default:a(()=>[l(c,{type:"selection",width:"55"}),l(c,{type:"index",label:"序号",width:"80",index:oe}),l(c,{prop:"name",label:"版本名称","min-width":"100"},{default:a(({row:t})=>[m("div",ze,[m("span",null,w(t.name),1),t.is_baseline?(i(),g(k,{key:0,type:"warning",size:"small",class:"baseline-tag"},{default:a(()=>e[12]||(e[12]=[d("基线",-1)])),_:1,__:[12]})):R("",!0)])]),_:1}),l(c,{prop:"projects",label:"关联项目",width:"300"},{default:a(({row:t})=>[t.projects&&t.projects.length>0?(i(),V("div",Fe,[(i(!0),V(q,null,H(t.projects.slice(0,2),$=>(i(),g(k,{key:$.id,size:"small",type:"primary",class:"project-tag"},{default:a(()=>[d(w($.name),1)]),_:2},1024))),128)),t.projects.length>2?(i(),g(de,{key:0,content:ie(t.projects)},{default:a(()=>[l(k,{size:"small",type:"info",class:"project-tag"},{default:a(()=>[d(" +"+w(t.projects.length-2),1)]),_:2},1024)]),_:2},1032,["content"])):R("",!0)])):(i(),V("span",Se,"未关联项目"))]),_:1}),l(c,{prop:"description",label:"描述","min-width":"200","show-overflow-tooltip":""}),l(c,{prop:"testcases_count",label:"用例数量",width:"100"},{default:a(({row:t})=>[l(k,{type:"info",size:"small"},{default:a(()=>[d(w(t.testcases_count),1)]),_:2},1024)]),_:1}),l(c,{prop:"created_by.username",label:"创建者",width:"120"}),l(c,{prop:"created_at",label:"创建时间",width:"180"},{default:a(({row:t})=>[d(w(re(t.created_at)),1)]),_:1}),l(c,{label:"操作",width:"150",fixed:"right"},{default:a(({row:t})=>[l(_,{size:"small",onClick:$=>ee(t)},{default:a(()=>e[13]||(e[13]=[d("编辑",-1)])),_:2,__:[13]},1032,["onClick"]),l(_,{size:"small",type:"danger",onClick:$=>le(t)},{default:a(()=>e[14]||(e[14]=[d("删除",-1)])),_:2,__:[14]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[fe,B.value]]),m("div",Te,[l(pe,{"current-page":b.value,"onUpdate:currentPage":e[3]||(e[3]=t=>b.value=t),"page-size":J.value,total:O.value,layout:"total, prev, pager, next",onCurrentChange:X},null,8,["current-page","page-size","total"])])]),l(ve,{modelValue:y.value,"onUpdate:modelValue":e[9]||(e[9]=t=>y.value=t),title:j.value?"编辑版本":"创建版本",width:"600px"},{footer:a(()=>[l(_,{onClick:e[8]||(e[8]=t=>y.value=!1)},{default:a(()=>e[16]||(e[16]=[d("取消",-1)])),_:1,__:[16]}),l(_,{type:"primary",onClick:te,loading:N.value},{default:a(()=>e[17]||(e[17]=[d("保存",-1)])),_:1,__:[17]},8,["loading"])]),default:a(()=>[l(me,{model:s,rules:K,ref_key:"versionFormRef",ref:T,"label-width":"120px"},{default:a(()=>[l(C,{label:"版本名称",prop:"name"},{default:a(()=>[l(M,{modelValue:s.name,"onUpdate:modelValue":e[4]||(e[4]=t=>s.name=t),placeholder:"请输入版本名称"},null,8,["modelValue"])]),_:1}),l(C,{label:"关联项目",prop:"project_ids"},{default:a(()=>[l(L,{modelValue:s.project_ids,"onUpdate:modelValue":e[5]||(e[5]=t=>s.project_ids=t),placeholder:"请选择项目（可多选）",multiple:"",style:{width:"100%"}},{default:a(()=>[(i(!0),V(q,null,H(D.value,t=>(i(),g(x,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(C,{label:"版本描述"},{default:a(()=>[l(M,{modelValue:s.description,"onUpdate:modelValue":e[6]||(e[6]=t=>s.description=t),type:"textarea",rows:3,placeholder:"请输入版本描述"},null,8,["modelValue"])]),_:1}),l(C,null,{default:a(()=>[l(_e,{modelValue:s.is_baseline,"onUpdate:modelValue":e[7]||(e[7]=t=>s.is_baseline=t)},{default:a(()=>e[15]||(e[15]=[d("设为基线版本",-1)])),_:1,__:[15]},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},Pe=ge(Ne,[["__scopeId","data-v-4d593c94"]]);export{Pe as default};
