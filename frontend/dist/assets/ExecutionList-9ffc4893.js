import{_ as Ee,q as y,V as J,x as Se,r as c,S as ze,o as r,c as f,b as _,d as t,w as l,N as Te,J as w,e as x,F as K,y as A,z as De,g as P,U as Me,f as n,t as i,av as Pe,ao as Ue,B as U,a5 as ae,E as le}from"./index-054e2682.js";import{b as $e,L as Be,M as Ne,N as Ie,r as Le}from"./ui_automation-53e326f9.js";const je={class:"page-container"},Fe={class:"page-header"},qe={class:"card-container"},Re={class:"filter-bar"},Je={class:"pagination-container"},Ke={key:0,class:"execution-detail"},Ae={class:"logs-container"},He={key:0},Oe={class:"log-header"},Qe={class:"log-action"},Ge={class:"log-desc"},We={key:0,class:"log-error"},Xe={class:"error-message"},Ye={class:"screenshots-container"},Ze={key:0},et={key:0,class:"screenshot-wrapper"},tt=["src","alt","onError"],at={key:1,class:"screenshot-error"},lt={class:"screenshot-time"},st={class:"errors-container"},nt={key:0,class:"error-item"},ot={class:"error-content"},rt={class:"error-text"},it={__name:"ExecutionList",setup(ut){const $=y([]),T=y(""),I=y([]),L=y(!1),H=y(0),v=J({currentPage:1,pageSize:20}),g=J({project:void 0,search:"",status:"",browser:""}),S=y([]),B=y(!1),j=y("logs"),u=y(null),z=y(!1),F=y(!1),p=J({testCaseId:null,engine:"playwright",browser:"chrome",headless:!1}),D=s=>{if(!s)return"-";const e=new Date(s);return isNaN(e.getTime())?"-":e.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})},se=(s,e)=>{console.error("截图加载失败:",e);const o=s.target;if(o.style.display="none",!o.parentElement.querySelector(".img-load-error")){const d=document.createElement("div");d.className="img-load-error",d.innerHTML=`
      <i class="el-icon-warning"></i>
      <span>图片加载失败（可能是 base64 编码问题）</span>
    `,o.parentElement.appendChild(d)}},O=s=>{if(!s&&s!==0)return"-";const e=Math.floor(s),o=Math.floor(e/3600),b=Math.floor(e%3600/60),d=e%60;return o>0?`${o}h ${b}m ${d}s`:b>0?`${b}m ${d}s`:`${d}s`},Q=s=>({pending:"info",running:"warning",passed:"success",failed:"danger",error:"danger"})[s]||"info",G=s=>({pending:"待执行",running:"执行中",passed:"通过",failed:"失败",error:"错误"})[s]||s,W=s=>({chrome:"Chrome",firefox:"Firefox",safari:"Safari",edge:"Edge"})[s]||s||"Chrome",ne=s=>({playwright:"Playwright",selenium:"Selenium"})[s]||s||"Playwright",oe=s=>({click:"点击",fill:"填写",getText:"获取文本",waitFor:"等待元素",hover:"悬停",scroll:"滚动",screenshot:"截图",assert:"断言",wait:"等待"})[s]||s,re=s=>{if(!s)return[];try{return typeof s=="string"?JSON.parse(s):s}catch(e){return console.error("解析执行日志失败:",e),[]}},ie=async()=>{try{const s=await $e({page_size:100});$.value=s.data.results||s.data}catch(s){x.error("获取项目列表失败"),console.error("获取项目列表失败:",s)}},h=async()=>{L.value=!0;try{const s={page:v.currentPage,page_size:v.pageSize,...g};T.value?s.project=T.value:s.project=void 0;const e=await Be(s);I.value=e.data.results||e.data,H.value=e.data.count||I.value.length}catch(s){x.error("获取执行列表失败"),console.error("获取执行列表失败:",s)}finally{L.value=!1}},ue=()=>{g.search="",g.status="",g.browser="",v.currentPage=1,h()},X=()=>{v.currentPage=1,h()},de=()=>{g.search="",g.status="",g.browser="",v.currentPage=1,h()},ce=s=>{v.pageSize=s,v.currentPage=1,h()},_e=s=>{v.currentPage=s,h()},pe=s=>{S.value=s.map(e=>e.id)},ge=s=>{le.confirm("确认删除该执行记录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ne(s.id),x.success("删除成功"),h()}catch(e){console.error("删除失败:",e),x.error("删除失败")}})},me=()=>{S.value.length!==0&&le.confirm(`确认删除选中的 ${S.value.length} 条记录吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Ie(S.value),x.success("批量删除成功"),S.value=[],h()}catch(s){console.error("批量删除失败:",s),x.error("批量删除失败")}})},Y=s=>{u.value=s,j.value="logs",B.value=!0},fe=s=>{p.testCaseId=s.test_case,p.engine=s.engine||"playwright",p.browser=s.browser||"chrome",p.headless=s.headless||!1,z.value=!0},ve=async()=>{var s,e,o,b;if(!p.testCaseId){x.error("测试用例ID无效");return}F.value=!0;try{const d=await Le(p.testCaseId,{engine:p.engine,browser:p.browser,headless:p.headless});z.value=!1,setTimeout(async()=>{await h()},500),d.data.success?x.success("用例重跑成功"):x.warning("用例执行完成，但有步骤失败: "+(((e=(s=d.data.errors)==null?void 0:s[0])==null?void 0:e.message)||"请查看执行详情"))}catch(d){z.value=!1,x.error("用例重跑失败: "+(((b=(o=d.response)==null?void 0:o.data)==null?void 0:b.message)||d.message||"未知错误")),console.error("重跑失败:",d),setTimeout(async()=>{await h()},500)}finally{F.value=!1}};return Se(async()=>{await ie(),$.value.length>0&&(T.value=$.value[0].id),await h()}),(s,e)=>{const o=c("el-option"),b=c("el-select"),d=c("el-icon"),be=c("el-input"),V=c("el-form-item"),k=c("el-button"),Z=c("el-form"),m=c("el-table-column"),ye=c("el-link"),M=c("el-tag"),he=c("el-table"),we=c("el-pagination"),E=c("el-descriptions-item"),xe=c("el-descriptions"),q=c("el-empty"),R=c("el-tab-pane"),ke=c("el-tabs"),ee=c("el-dialog"),N=c("el-radio"),te=c("el-radio-group"),Ce=ze("loading");return r(),f("div",je,[_("div",Fe,[e[14]||(e[14]=_("h1",{class:"page-title"},"测试执行记录",-1)),t(b,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=a=>T.value=a),placeholder:"选择项目",style:{width:"200px","margin-right":"15px"},onChange:ue},{default:l(()=>[(r(!0),f(K,null,A($.value,a=>(r(),w(o,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_("div",qe,[_("div",Re,[t(Z,{inline:!0,model:g,class:"demo-form-inline"},{default:l(()=>[t(V,{label:"搜索"},{default:l(()=>[t(be,{modelValue:g.search,"onUpdate:modelValue":e[1]||(e[1]=a=>g.search=a),placeholder:"搜索用例名称",clearable:"",onKeyup:De(X,["enter"])},{prefix:l(()=>[t(d,null,{default:l(()=>[t(P(Me))]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(V,{label:"状态"},{default:l(()=>[t(b,{modelValue:g.status,"onUpdate:modelValue":e[2]||(e[2]=a=>g.status=a),placeholder:"执行状态",clearable:""},{default:l(()=>[t(o,{label:"待执行",value:"pending"}),t(o,{label:"执行中",value:"running"}),t(o,{label:"通过",value:"passed"}),t(o,{label:"失败",value:"failed"}),t(o,{label:"错误",value:"error"})]),_:1},8,["modelValue"])]),_:1}),t(V,{label:"浏览器"},{default:l(()=>[t(b,{modelValue:g.browser,"onUpdate:modelValue":e[3]||(e[3]=a=>g.browser=a),placeholder:"浏览器",clearable:""},{default:l(()=>[t(o,{label:"Chrome",value:"chrome"}),t(o,{label:"Firefox",value:"firefox"}),t(o,{label:"Safari",value:"safari"}),t(o,{label:"Edge",value:"edge"})]),_:1},8,["modelValue"])]),_:1}),t(V,null,{default:l(()=>[t(k,{type:"primary",onClick:X},{default:l(()=>e[15]||(e[15]=[n("查询",-1)])),_:1,__:[15]}),t(k,{onClick:de},{default:l(()=>e[16]||(e[16]=[n("重置",-1)])),_:1,__:[16]}),t(k,{type:"danger",disabled:S.value.length===0,onClick:me},{default:l(()=>e[17]||(e[17]=[n(" 批量删除 ",-1)])),_:1,__:[17]},8,["disabled"])]),_:1})]),_:1},8,["model"])]),Te((r(),w(he,{data:I.value,style:{width:"100%"},onSelectionChange:pe},{default:l(()=>[t(m,{type:"selection",width:"55",align:"center"}),t(m,{prop:"id",label:"ID",width:"80",align:"center"}),t(m,{prop:"test_case_name",label:"用例名称","min-width":"200"},{default:l(({row:a})=>[t(ye,{onClick:C=>Y(a),type:"primary"},{default:l(()=>[n(i(a.test_case_name),1)]),_:2},1032,["onClick"])]),_:1}),t(m,{label:"关联对象",width:"100",align:"center"},{default:l(({row:a})=>[a.test_suite?(r(),w(M,{key:1,type:"warning",size:"small"},{default:l(()=>e[19]||(e[19]=[n("套件",-1)])),_:1,__:[19]})):(r(),w(M,{key:0,type:"info",size:"small"},{default:l(()=>e[18]||(e[18]=[n("用例",-1)])),_:1,__:[18]}))]),_:1}),t(m,{prop:"status",label:"执行状态",width:"100",align:"center"},{default:l(({row:a})=>[t(M,{type:Q(a.status),size:"small"},{default:l(()=>[n(i(G(a.status)),1)]),_:2},1032,["type"])]),_:1}),t(m,{prop:"engine",label:"测试引擎",width:"120",align:"center"},{default:l(({row:a})=>[n(i(ne(a.engine)),1)]),_:1}),t(m,{prop:"headless",label:"执行模式",width:"100",align:"center"},{default:l(({row:a})=>[n(i(a.headless?"无头模式":"有头模式"),1)]),_:1}),t(m,{prop:"browser",label:"浏览器",width:"100",align:"center"},{default:l(({row:a})=>[n(i(W(a.browser)),1)]),_:1}),t(m,{prop:"created_by_name",label:"执行人",width:"120",align:"center"}),t(m,{prop:"started_at",label:"开始时间",width:"180",align:"center"},{default:l(({row:a})=>[n(i(D(a.started_at)),1)]),_:1}),t(m,{prop:"finished_at",label:"结束时间",width:"180",align:"center"},{default:l(({row:a})=>[n(i(D(a.finished_at)),1)]),_:1}),t(m,{label:"执行时长",width:"120",align:"center"},{default:l(({row:a})=>[n(i(O(a.execution_time)),1)]),_:1}),t(m,{label:"操作",width:"150",fixed:"right",align:"center"},{default:l(({row:a})=>[t(k,{size:"small",type:"primary",link:"",onClick:C=>Y(a)},{default:l(()=>[t(d,null,{default:l(()=>[t(P(Pe))]),_:1}),e[20]||(e[20]=n(" 详情 ",-1))]),_:2,__:[20]},1032,["onClick"]),a.status==="failed"||a.status==="error"?(r(),w(k,{key:0,size:"small",type:"warning",link:"",onClick:C=>fe(a)},{default:l(()=>[t(d,null,{default:l(()=>[t(P(Ue))]),_:1}),e[21]||(e[21]=n(" 重跑 ",-1))]),_:2,__:[21]},1032,["onClick"])):U("",!0),t(k,{link:"",type:"danger",onClick:C=>ge(a)},{default:l(()=>e[22]||(e[22]=[n(" 删除 ",-1)])),_:2,__:[22]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ce,L.value]]),_("div",Je,[t(we,{"current-page":v.currentPage,"onUpdate:currentPage":e[4]||(e[4]=a=>v.currentPage=a),"page-size":v.pageSize,"onUpdate:pageSize":e[5]||(e[5]=a=>v.pageSize=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:H.value,onSizeChange:ce,onCurrentChange:_e},null,8,["current-page","page-size","total"])])]),t(ee,{modelValue:B.value,"onUpdate:modelValue":e[8]||(e[8]=a=>B.value=a),title:"执行详情",width:"900px"},{footer:l(()=>[t(k,{onClick:e[7]||(e[7]=a=>B.value=!1)},{default:l(()=>e[23]||(e[23]=[n("关闭",-1)])),_:1,__:[23]})]),default:l(()=>[u.value?(r(),f("div",Ke,[t(xe,{column:2,border:""},{default:l(()=>[t(E,{label:"用例名称"},{default:l(()=>[n(i(u.value.test_case_name),1)]),_:1}),t(E,{label:"执行状态"},{default:l(()=>[t(M,{type:Q(u.value.status)},{default:l(()=>[n(i(G(u.value.status)),1)]),_:1},8,["type"])]),_:1}),t(E,{label:"浏览器"},{default:l(()=>[n(i(W(u.value.browser)),1)]),_:1}),t(E,{label:"执行人"},{default:l(()=>[n(i(u.value.created_by_name),1)]),_:1}),t(E,{label:"开始时间"},{default:l(()=>[n(i(D(u.value.started_at)),1)]),_:1}),t(E,{label:"结束时间"},{default:l(()=>[n(i(D(u.value.finished_at)),1)]),_:1}),t(E,{label:"执行时长",span:2},{default:l(()=>[n(i(O(u.value.execution_time)),1)]),_:1})]),_:1}),t(ke,{modelValue:j.value,"onUpdate:modelValue":e[6]||(e[6]=a=>j.value=a),class:"execution-tabs",style:{"margin-top":"20px"}},{default:l(()=>[t(R,{label:"执行日志",name:"logs"},{default:l(()=>[_("div",Ae,[u.value.execution_logs?(r(),f("div",He,[(r(!0),f(K,null,A(re(u.value.execution_logs),(a,C)=>(r(),f("div",{key:C,class:"log-item"},[_("div",Oe,[t(M,{type:a.success?"success":"danger",size:"small"},{default:l(()=>[n(" 步骤 "+i(a.step_number),1)]),_:2},1032,["type"]),_("span",Qe,i(oe(a.action_type)),1),_("span",Ge,i(a.description),1)]),a.error?(r(),f("div",We,[t(d,null,{default:l(()=>[t(P(ae))]),_:1}),_("pre",Xe,i(a.error),1)])):U("",!0)]))),128))])):(r(),w(q,{key:1,description:"暂无执行日志"}))])]),_:1}),u.value.status==="failed"||u.value.status==="error"?(r(),w(R,{key:0,label:"失败截图",name:"screenshots"},{default:l(()=>[_("div",Ye,[u.value.screenshots&&u.value.screenshots.length>0?(r(),f("div",Ze,[(r(!0),f(K,null,A(u.value.screenshots,(a,C)=>(r(),f("div",{key:C,class:"screenshot-item"},[_("h5",null,i(a.description||`截图 ${C+1}`),1),a.url?(r(),f("div",et,[_("img",{src:a.url,alt:a.description,class:"screenshot-img",onError:Ve=>se(Ve,a)},null,40,tt)])):(r(),f("div",at,[t(d,null,{default:l(()=>[t(P(ae))]),_:1}),_("span",null,"截图失败："+i(a.error||"未知原因"),1)])),_("p",lt,i(D(a.timestamp)),1)]))),128))])):(r(),w(q,{key:1,description:"暂无失败截图"}))])]),_:1})):U("",!0),u.value.status==="failed"||u.value.status==="error"?(r(),w(R,{key:1,label:"错误信息",name:"error"},{default:l(()=>[_("div",st,[u.value.error_message?(r(),f("div",nt,[_("div",ot,[_("pre",rt,i(u.value.error_message),1)])])):(r(),w(q,{key:1,description:"暂无错误信息"}))])]),_:1})):U("",!0)]),_:1},8,["modelValue"])])):U("",!0)]),_:1},8,["modelValue"]),t(ee,{modelValue:z.value,"onUpdate:modelValue":e[13]||(e[13]=a=>z.value=a),title:"重跑测试用例",width:"500px"},{footer:l(()=>[t(k,{onClick:e[12]||(e[12]=a=>z.value=!1)},{default:l(()=>e[28]||(e[28]=[n("取消",-1)])),_:1,__:[28]}),t(k,{type:"primary",onClick:ve,loading:F.value},{default:l(()=>e[29]||(e[29]=[n("确认重跑",-1)])),_:1,__:[29]},8,["loading"])]),default:l(()=>[t(Z,{model:p,"label-width":"100px"},{default:l(()=>[t(V,{label:"测试引擎"},{default:l(()=>[t(te,{modelValue:p.engine,"onUpdate:modelValue":e[9]||(e[9]=a=>p.engine=a)},{default:l(()=>[t(N,{label:"playwright"},{default:l(()=>e[24]||(e[24]=[n("Playwright",-1)])),_:1,__:[24]}),t(N,{label:"selenium"},{default:l(()=>e[25]||(e[25]=[n("Selenium",-1)])),_:1,__:[25]})]),_:1},8,["modelValue"])]),_:1}),t(V,{label:"浏览器"},{default:l(()=>[t(b,{modelValue:p.browser,"onUpdate:modelValue":e[10]||(e[10]=a=>p.browser=a),style:{width:"100%"}},{default:l(()=>[t(o,{label:"Chrome",value:"chrome"}),t(o,{label:"Firefox",value:"firefox"}),t(o,{label:"Safari",value:"safari"}),t(o,{label:"Edge",value:"edge"})]),_:1},8,["modelValue"])]),_:1}),t(V,{label:"执行模式"},{default:l(()=>[t(te,{modelValue:p.headless,"onUpdate:modelValue":e[11]||(e[11]=a=>p.headless=a)},{default:l(()=>[t(N,{label:!1},{default:l(()=>e[26]||(e[26]=[n("有头模式",-1)])),_:1,__:[26]}),t(N,{label:!0},{default:l(()=>e[27]||(e[27]=[n("无头模式",-1)])),_:1,__:[27]})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},_t=Ee(it,[["__scopeId","data-v-df7cbf3c"]]);export{_t as default};
