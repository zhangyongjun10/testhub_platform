import{_ as ce,u as _e,a as me,q as f,V as $,x as ge,r as n,S as ve,o as i,c as V,b,d as l,w as o,N as fe,J as w,C as x,e as h,g as be,D as we,f as s,F,y as q,t as y,G as ye,B as D,R as ke}from"./index-054e2682.js";const Ce={class:"page-container"},Ve={class:"page-header"},xe={class:"filter-bar"},he={class:"table-container"},je={key:0},Re={key:1},ze={class:"pagination-container"},Me={__name:"ReviewList",setup(Ue){const j=_e(),R=me(),S=f([]),B=f([]),N=f([]),z=f(!1),k=f(!1),P=f(null),p=$({project:"",status:"",reviewer:""}),c=$({page:1,size:20,total:0}),_=$({status:"approved",comment:""}),m=async()=>{z.value=!0;try{const a={page:c.page,page_size:c.size,...p};Object.keys(a).forEach(u=>a[u]===""&&delete a[u]);const e=await x.get("/reviews/reviews/",{params:a});S.value=e.data.results,c.total=e.data.count}catch{h.error("获取评审列表失败")}finally{z.value=!1}},H=async()=>{try{const a=await x.get("/projects/");B.value=a.data.results||a.data||[]}catch(a){console.error("获取项目列表失败:",a)}},G=async()=>{try{const a=await x.get("/auth/users/");N.value=a.data.results||a.data||[]}catch(a){console.error("获取用户列表失败:",a)}},I=()=>{j.push("/ai-generation/reviews/create")},J=a=>{j.push(`/ai-generation/reviews/${a}`)},O=a=>{j.push(`/ai-generation/reviews/${a}/edit`)},A=a=>{P.value=a,_.status="approved",_.comment="",k.value=!0},K=async()=>{try{await x.post(`/reviews/reviews/${P.value.id}/submit_review/`,_),h.success("评审提交成功"),k.value=!1,m()}catch{h.error("评审提交失败")}},Q=async a=>{try{await x.delete(`/reviews/reviews/${a}/`),h.success("删除成功"),m()}catch{h.error("删除失败")}},W=a=>({pending:"warning",in_progress:"primary",approved:"success",rejected:"danger",cancelled:"info"})[a]||"info",X=a=>({pending:"待评审",in_progress:"评审中",approved:"已通过",rejected:"已拒绝",cancelled:"已取消"})[a]||a,Z=a=>({low:"低",medium:"中",high:"高",urgent:"紧急"})[a]||a,E=a=>{const e=a.assignments||[];if(e.length===0)return 0;const u=e.filter(r=>r.status!=="pending").length;return Math.round(u/e.length*100)},ee=a=>{const e=E(a);return e===100?"#67c23a":e>=50?"#e6a23c":"#f56c6c"},te=a=>{var e;return(e=a.assignments)==null?void 0:e.some(u=>{var r;return u.reviewer.id===((r=R.user)==null?void 0:r.id)&&u.status==="pending"})},ae=a=>{var e;return a.creator.id===((e=R.user)==null?void 0:e.id)&&["pending","in_progress"].includes(a.status)},le=a=>{var e;return a.creator.id===((e=R.user)==null?void 0:e.id)&&a.status==="pending"},L=a=>ke(a).format("YYYY-MM-DD HH:mm");return ge(()=>{m(),H(),G()}),(a,e)=>{const u=n("el-icon"),r=n("el-button"),v=n("el-option"),M=n("el-select"),C=n("el-form-item"),T=n("el-form"),d=n("el-table-column"),Y=n("el-tag"),oe=n("el-progress"),ne=n("el-popconfirm"),se=n("el-table"),re=n("el-pagination"),U=n("el-radio-button"),ie=n("el-radio-group"),de=n("el-input"),ue=n("el-dialog"),pe=ve("loading");return i(),V("div",Ce,[b("div",Ve,[e[10]||(e[10]=b("h1",{class:"page-title"},"用例评审",-1)),b("div",null,[l(r,{type:"primary",onClick:I},{default:o(()=>[l(u,null,{default:o(()=>[l(be(we))]),_:1}),e[9]||(e[9]=s(" 创建评审 ",-1))]),_:1,__:[9]})])]),b("div",xe,[l(T,{inline:!0,model:p,class:"filter-form"},{default:o(()=>[l(C,{label:"项目"},{default:o(()=>[l(M,{modelValue:p.project,"onUpdate:modelValue":e[0]||(e[0]=t=>p.project=t),placeholder:"请选择项目",clearable:"",onChange:m},{default:o(()=>[(i(!0),V(F,null,q(B.value,t=>(i(),w(v,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(C,{label:"状态"},{default:o(()=>[l(M,{modelValue:p.status,"onUpdate:modelValue":e[1]||(e[1]=t=>p.status=t),placeholder:"请选择状态",clearable:"",onChange:m},{default:o(()=>[l(v,{label:"待评审",value:"pending"}),l(v,{label:"评审中",value:"in_progress"}),l(v,{label:"已通过",value:"approved"}),l(v,{label:"已拒绝",value:"rejected"}),l(v,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),l(C,{label:"评审人"},{default:o(()=>[l(M,{modelValue:p.reviewer,"onUpdate:modelValue":e[2]||(e[2]=t=>p.reviewer=t),placeholder:"请选择评审人",clearable:"",onChange:m},{default:o(()=>[(i(!0),V(F,null,q(N.value,t=>(i(),w(v,{key:t.id,label:t.username,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),b("div",he,[fe((i(),w(se,{data:S.value,stripe:""},{default:o(()=>[l(d,{prop:"title",label:"评审标题","min-width":"200","show-overflow-tooltip":""}),l(d,{label:"关联项目",width:"200"},{default:o(({row:t})=>[t.projects&&t.projects.length>0?(i(),V("span",je,y(t.projects.map(g=>g.name).join(", ")),1)):(i(),V("span",Re,"-"))]),_:1}),l(d,{label:"评审状态",width:"120"},{default:o(({row:t})=>[l(Y,{type:W(t.status)},{default:o(()=>[s(y(X(t.status)),1)]),_:2},1032,["type"])]),_:1}),l(d,{label:"优先级",width:"100"},{default:o(({row:t})=>[l(Y,{class:ye(`priority-tag ${t.priority}`)},{default:o(()=>[s(y(Z(t.priority)),1)]),_:2},1032,["class"])]),_:1}),l(d,{prop:"creator.username",label:"创建人",width:"120"}),l(d,{label:"用例数量",width:"100"},{default:o(({row:t})=>{var g;return[s(y(((g=t.testcases)==null?void 0:g.length)||0),1)]}),_:1}),l(d,{label:"评审进度",width:"120"},{default:o(({row:t})=>[l(oe,{percentage:E(t),color:ee(t),"stroke-width":6},null,8,["percentage","color"])]),_:1}),l(d,{prop:"deadline",label:"截止时间",width:"160"},{default:o(({row:t})=>[s(y(t.deadline?L(t.deadline):"无"),1)]),_:1}),l(d,{prop:"created_at",label:"创建时间",width:"160"},{default:o(({row:t})=>[s(y(L(t.created_at)),1)]),_:1}),l(d,{label:"操作",width:"200",fixed:"right"},{default:o(({row:t})=>[l(r,{link:"",type:"primary",onClick:g=>J(t.id)},{default:o(()=>e[11]||(e[11]=[s("详情",-1)])),_:2,__:[11]},1032,["onClick"]),te(t)?(i(),w(r,{key:0,link:"",type:"success",onClick:g=>A(t)},{default:o(()=>e[12]||(e[12]=[s("评审",-1)])),_:2,__:[12]},1032,["onClick"])):D("",!0),ae(t)?(i(),w(r,{key:1,link:"",type:"warning",onClick:g=>O(t.id)},{default:o(()=>e[13]||(e[13]=[s("编辑",-1)])),_:2,__:[13]},1032,["onClick"])):D("",!0),le(t)?(i(),w(ne,{key:2,title:"确定要删除这个评审吗？",onConfirm:g=>Q(t.id)},{reference:o(()=>[l(r,{link:"",type:"danger"},{default:o(()=>e[14]||(e[14]=[s("删除",-1)])),_:1,__:[14]})]),_:2},1032,["onConfirm"])):D("",!0)]),_:1})]),_:1},8,["data"])),[[pe,z.value]]),b("div",ze,[l(re,{"current-page":c.page,"onUpdate:currentPage":e[3]||(e[3]=t=>c.page=t),"page-size":c.size,"onUpdate:pageSize":e[4]||(e[4]=t=>c.size=t),total:c.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:m,onCurrentChange:m},null,8,["current-page","page-size","total"])])]),l(ue,{modelValue:k.value,"onUpdate:modelValue":e[8]||(e[8]=t=>k.value=t),title:"提交评审",width:"600px"},{footer:o(()=>[l(r,{onClick:e[7]||(e[7]=t=>k.value=!1)},{default:o(()=>e[18]||(e[18]=[s("取消",-1)])),_:1,__:[18]}),l(r,{type:"primary",onClick:K},{default:o(()=>e[19]||(e[19]=[s("提交",-1)])),_:1,__:[19]})]),default:o(()=>[l(T,{model:_,"label-width":"80px"},{default:o(()=>[l(C,{label:"评审结果",required:""},{default:o(()=>[l(ie,{modelValue:_.status,"onUpdate:modelValue":e[5]||(e[5]=t=>_.status=t)},{default:o(()=>[l(U,{label:"approved"},{default:o(()=>e[15]||(e[15]=[s("通过",-1)])),_:1,__:[15]}),l(U,{label:"rejected"},{default:o(()=>e[16]||(e[16]=[s("拒绝",-1)])),_:1,__:[16]}),l(U,{label:"abstained"},{default:o(()=>e[17]||(e[17]=[s("弃权",-1)])),_:1,__:[17]})]),_:1},8,["modelValue"])]),_:1}),l(C,{label:"评审意见"},{default:o(()=>[l(de,{modelValue:_.comment,"onUpdate:modelValue":e[6]||(e[6]=t=>_.comment=t),type:"textarea",rows:4,placeholder:"请输入评审意见"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},De=ce(Me,[["__scopeId","data-v-02437dab"]]);export{De as default};
