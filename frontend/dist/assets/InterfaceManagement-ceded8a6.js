import{_ as Le,q as m,Z as Wl,r as g,o as d,c,ab as Al,b as u,F as D,y as H,G as ie,d as t,J as j,w as n,f as V,t as E,B as N,g as ee,H as Kl,D as ge,v as Se,V as Fe,x as Ml,al as $l,N as Dl,am as Pl,an as Fl,C as K,e as p,M as Je,E as Jl,ac as He,a2 as Hl,z as Ie}from"./index-054e2682.js";const Il={class:"key-value-editor"},Ll={class:"rows"},Gl={class:"column key-column"},Xl={class:"column value-column"},Yl={key:2,class:"file-name"},Zl={class:"column description-column"},Ql={class:"column action-column"},ea={class:"footer"},la={__name:"KeyValueEditor",props:{modelValue:{type:Object,default:()=>({})},placeholderKey:{type:String,default:"Key"},placeholderValue:{type:String,default:"Value"},showFile:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(se,{expose:Ve,emit:B}){const G=se,q=B,C=m([]),z=()=>{const U=G.modelValue||{};console.log("KeyValueEditor initializeRows called with data:",U);const k=[];Array.isArray(U)?(console.log("Data is array, processing..."),k.push(...U.map(b=>({enabled:b.enabled!==!1,key:b.key||"",value:b.value||"",description:b.description||"",type:b.type||"text",file:b.file||null})))):(console.log("Data is object, converting..."),Object.keys(U).forEach(b=>{b&&U[b]!==void 0&&k.push({enabled:!0,key:b,value:U[b],description:"",type:"text",file:null})})),k.length===0&&k.push({enabled:!0,key:"",value:"",description:"",type:"text",file:null}),console.log("KeyValueEditor final rows:",k),C.value=k},M=()=>{const U=C.value.filter(b=>b.key||b.value||b.description).map(b=>({key:b.key||"",value:b.value||"",description:b.description||"",enabled:b.enabled!==!1,type:b.type||"text"}));console.log("KeyValueEditor updateValue result (full format):",U),q("update:modelValue",U);const k=C.value[C.value.length-1];(k.key||k.value)&&I()},I=()=>{C.value.push({enabled:!0,key:"",value:"",description:"",type:"text",file:null})},s=U=>{C.value.length>1&&(C.value.splice(U,1),M())},w=(U,k)=>{C.value[U].file=k,C.value[U].value=k.name,M()};return Wl(()=>G.modelValue,()=>{z()},{immediate:!0}),Ve({rows:C}),(U,k)=>{const b=g("el-checkbox"),ne=g("el-input"),P=g("el-button"),ce=g("el-upload"),ue=g("el-option"),fe=g("el-select"),ye=g("el-icon");return d(),c("div",Il,[k[2]||(k[2]=Al('<div class="header" data-v-f2229ce0><div class="column key-column" data-v-f2229ce0>Key</div><div class="column value-column" data-v-f2229ce0>Value</div><div class="column description-column" data-v-f2229ce0>Description</div><div class="column action-column" data-v-f2229ce0></div></div>',1)),u("div",Ll,[(d(!0),c(D,null,H(C.value,(_,X)=>(d(),c("div",{key:X,class:ie(["row",{disabled:!_.enabled}])},[u("div",Gl,[t(b,{modelValue:_.enabled,"onUpdate:modelValue":x=>_.enabled=x,onChange:M},null,8,["modelValue","onUpdate:modelValue"]),t(ne,{modelValue:_.key,"onUpdate:modelValue":x=>_.key=x,placeholder:se.placeholderKey,size:"small",onInput:M},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),u("div",Xl,[!se.showFile||_.type!=="file"?(d(),j(ne,{key:0,modelValue:_.value,"onUpdate:modelValue":x=>_.value=x,placeholder:se.placeholderValue,size:"small",onInput:M},null,8,["modelValue","onUpdate:modelValue","placeholder"])):(d(),j(ce,{key:1,"auto-upload":!1,"show-file-list":!1,onChange:x=>w(X,x)},{default:n(()=>[t(P,{size:"small"},{default:n(()=>k[0]||(k[0]=[V("选择文件",-1)])),_:1,__:[0]})]),_:2},1032,["onChange"])),_.file?(d(),c("span",Yl,E(_.file.name),1)):N("",!0)]),u("div",Zl,[t(ne,{modelValue:_.description,"onUpdate:modelValue":x=>_.description=x,placeholder:"描述",size:"small",onInput:M},null,8,["modelValue","onUpdate:modelValue"])]),u("div",Ql,[se.showFile?(d(),j(fe,{key:0,modelValue:_.type,"onUpdate:modelValue":x=>_.type=x,size:"small",style:{width:"70px","margin-right":"5px"},onChange:M},{default:n(()=>[t(ue,{label:"Text",value:"text"}),t(ue,{label:"File",value:"file"})]),_:2},1032,["modelValue","onUpdate:modelValue"])):N("",!0),t(P,{size:"small",type:"danger",icon:ee(Kl),onClick:x=>s(X),disabled:C.value.length<=1},null,8,["icon","onClick","disabled"])])],2))),128))]),u("div",ea,[t(P,{size:"small",onClick:I},{default:n(()=>[t(ye,null,{default:n(()=>[t(ee(ge))]),_:1}),k[1]||(k[1]=V(" 添加行 ",-1))]),_:1,__:[1]})])])}}},he=Le(la,[["__scopeId","data-v-f2229ce0"]]);const aa={class:"interface-management"},ta={class:"interface-layout"},oa={class:"sidebar"},sa={class:"sidebar-header"},na={class:"header-actions"},ua={class:"collection-tree"},da={class:"tree-node"},ra={key:2,class:"node-edit"},ia={key:3,class:"node-label"},ca={class:"main-content"},pa={key:0,class:"empty-state"},va={key:1,class:"request-detail"},ma={class:"request-header"},fa={class:"request-line"},ya={key:0},_a={key:1},ba={key:2},ha={class:"request-name"},ga={class:"body-container"},Va={key:0,class:"body-content"},ka={key:1,class:"body-content"},wa={key:2,class:"body-content"},Ca={class:"raw-options"},xa={class:"assertions-editor"},Sa={class:"assertions-header"},Ua={class:"assertions-list"},Ea={class:"assertion-header"},qa={class:"assertion-config"},Ta={key:0,class:"assertion-params"},Na={key:0},ja={key:1},Oa={key:2},Ba={key:3},Ra={key:4},za={key:5},Wa={key:0,class:"no-assertions"},Aa={class:"message-container"},Ka={class:"message-input-section"},Ma={key:0},$a={key:1},Da={key:0,class:"uploaded-file"},Pa={class:"message-actions",style:{"margin-top":"15px"}},Fa={key:0,class:"websocket-response-section"},Ja={class:"websocket-messages"},Ha={class:"message-header"},Ia={class:"message-time"},La={class:"message-content"},Ga={key:0},Xa={key:1},Ya={class:"message-actions"},Za={key:0,class:"response-section"},Qa={class:"response-header"},et={class:"response-info"},lt={class:"response-time"},at={class:"response-body"},tt={class:"response-actions"},ot={class:"response-content"},st={class:"response-headers"},nt={class:"assertions-results"},ut={class:"assertion-result-header"},dt={class:"assertion-name"},rt={class:"assertion-result-details"},it={class:"result-row"},ct={class:"value"},pt={class:"result-row"},vt={class:"value"},mt={key:0,class:"result-row"},ft={class:"value error"},yt={__name:"InterfaceManagement",setup(se){const Ve=m(null),B=m([]),G=m([]),q=m(null),C=m([]),z=m([]),M=m([]),I=m(null),s=m(null),w=m(null),U=m(!1),k=m(!1),b=m("params"),ne=m("body"),P=m(!1),ce=m(!1),ue=m(!1),fe=m(0),ye=m(0),_=m(null),X=m(null),x=m(null),Y=m(""),ke=m(null),de=l=>l?Array.isArray(l)?(console.log("Input is already array format:",l),l.map(e=>({key:e.key||"",value:e.value||"",enabled:e.enabled!==!1,description:e.description||""}))):typeof l=="object"?(console.log("Converting object to array:",l),Object.entries(l).map(([e,o])=>({key:e,value:String(o),enabled:!0,description:""}))):[]:[],Ue=l=>{if(console.log("convertKeyValueArrayToObject input:",l),l&&typeof l=="object"&&!Array.isArray(l))return console.log("Input is already an object, returning as-is"),l;if(!Array.isArray(l))return{};const e={};return l.forEach(o=>{console.log("Processing item:",o,"enabled:",o.enabled),o.enabled!==!1&&o.key&&(e[o.key]=o.value||"",console.log("Added to obj:",o.key,"=",o.value))}),console.log("convertKeyValueArrayToObject output:",e),e},Ge=["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS"],Xe=["CONNECT","SUBSCRIBE","UNSUBSCRIBE","SEND","PING","PONG"],Ye=Se(()=>s.value&&s.value.request_type==="WEBSOCKET"?Xe:Ge),L=m("text"),_e=m(""),le=m(null),A=m("disconnected"),R=m(null),be=m([]),y=m("none"),F=m("json"),ae=m({}),te=m({}),S=m(""),Ze={children:"children",label:"name"},J=Fe({name:"",description:"",parent:null}),Z=Fe({id:null,name:"",description:"",parent:null}),Ee={name:[{required:!0,message:"请输入集合名称",trigger:"blur"}]},we=Se(()=>s.value&&["POST","PUT","PATCH"].includes(s.value.method)),Ce=Se(()=>{var l;if(!((l=w.value)!=null&&l.response_data))return"";try{return w.value.response_data.json?JSON.stringify(w.value.response_data.json,null,2):w.value.response_data.body||""}catch{return w.value.response_data.body||""}}),Qe=l=>l>=200&&l<300?"success":l>=300&&l<400?"warning":l>=400?"danger":"info",el=async()=>{try{const l=await K.get("/api-testing/projects/");G.value=l.data.results||l.data,G.value.length>0&&!q.value&&(q.value=G.value[0].id,await je())}catch{p.error("加载项目失败")}},xe=async(l=!0)=>{if(q.value)try{const e=await K.get("/api-testing/collections/",{params:{project:q.value}}),o=e.data.results||e.data;C.value=al(o),z.value=o,await qe(),l||(B.value=[])}catch{p.error("加载集合失败")}},qe=async()=>{if(q.value)try{const l=await K.get("/api-testing/requests/"),e=l.data.results||l.data;C.value.forEach(o=>{Te(o)}),e.forEach(o=>{const r=Ne(C.value,o.collection);r&&(r.children||(r.children=[]),r.children.push({...o,type:"request",name:o.name}))})}catch{p.error("加载请求失败")}},Te=l=>{l.children&&(l.children=l.children.filter(e=>e.type==="collection"),l.children.forEach(e=>Te(e)))},ll=async()=>{try{const l=await K.get("/api-testing/environments/"),e=l.data.results||l.data;M.value=e.filter(o=>o.scope==="GLOBAL"||o.scope==="LOCAL"&&(!q.value||o.project===q.value))}catch{p.error("加载环境失败")}},al=l=>{const e={},o=[];return l.forEach(r=>{e[r.id]={...r,type:"collection",children:[]}}),l.forEach(r=>{r.parent?e[r.parent]&&e[r.parent].children.push(e[r.id]):o.push(e[r.id])}),o},Ne=(l,e)=>{for(const o of l){if(o.id===e)return o;if(o.children){const r=Ne(o.children,e);if(r)return r}}return null},je=async()=>{await Promise.all([xe(!1),ll()])},tl=l=>{if(l.type==="request"){console.log("onNodeClick - original data.headers:",l.headers);const e=de(l.headers||{});console.log("onNodeClick - converted headers:",e),ve.value=l.headers||{},console.log("onNodeClick - initialized currentHeaders:",ve.value),s.value={...l,params:de(l.params||{}),headers:e,body:l.body||{},auth:l.auth||{}},console.log("onNodeClick - selectedRequest.value.headers:",s.value.headers),l.body&&l.body.type?l.body.type==="json"&&l.body.data?(y.value="raw",F.value="json",S.value=JSON.stringify(l.body.data,null,2)):l.body.type==="raw"&&l.body.data?(y.value="raw",F.value="text",S.value=l.body.data):l.body.type==="form-data"?(y.value="form-data",ae.value=l.body.data||{}):l.body.type==="x-www-form-urlencoded"?(y.value="x-www-form-urlencoded",te.value=l.body.data||{}):l.body.type==="binary"?y.value="binary":(y.value="none",S.value=""):(y.value="none",S.value=""),w.value=null}},ol=(l,e)=>{l.preventDefault(),_.value=e,fe.value=l.clientX,ye.value=l.clientY,ue.value=!0,Je(()=>{document.addEventListener("click",oe)})},oe=()=>{ue.value=!1,document.removeEventListener("click",oe)},sl=l=>{x.value=l.id,Y.value=l.name,Je(()=>{ke.value&&ke.value.focus()})},Oe=async()=>{if(!x.value||!Y.value.trim()){pe();return}try{const l=z.value.find(i=>i.id===x.value);if(!l){p.error("集合不存在"),pe();return}const e={name:Y.value.trim(),description:l.description,parent:l.parent,project:q.value};await K.put(`/api-testing/collections/${x.value}/`,e);const o=(i,f,v)=>{for(const O of i){if(O.type==="collection"&&O.id===f)return O.name=v,!0;if(O.children&&o(O.children,f,v))return!0}return!1};o(C.value,x.value,Y.value.trim());const r=z.value.find(i=>i.id===x.value);r&&(r.name=Y.value.trim()),p.success("集合名称更新成功"),pe()}catch{p.error("更新失败"),pe()}},pe=()=>{x.value=null,Y.value=""},nl=l=>{B.value.includes(l.id)||B.value.push(l.id)},ul=l=>{const e=B.value.indexOf(l.id);e>-1&&B.value.splice(e,1)},dl=()=>{const l={name:"新建请求",method:"GET",url:"",headers:{},params:{},body:{},collection:_.value.type==="collection"?_.value.id:_.value.collection,type:"request"};s.value=l,oe()},rl=()=>{J.parent=_.value.type==="collection"?_.value.id:null,P.value=!0,oe()},il=()=>{if(_.value.type==="request"){const l=_.value;console.log("editNode - original data.headers:",l.headers);const e=de(l.headers||{});console.log("editNode - converted headers:",e),ve.value=l.headers||{},console.log("editNode - initialized currentHeaders:",ve.value),s.value={...l,params:de(l.params||{}),headers:e,body:l.body||{},auth:l.auth||{}},console.log("editNode - selectedRequest.value.headers:",s.value.headers),l.body&&l.body.type?l.body.type==="json"&&l.body.data?(y.value="raw",F.value="json",S.value=JSON.stringify(l.body.data,null,2)):l.body.type==="raw"&&l.body.data?(y.value="raw",F.value="text",S.value=l.body.data):l.body.type==="form-data"?(y.value="form-data",ae.value=l.body.data||{}):l.body.type==="x-www-form-urlencoded"?(y.value="x-www-form-urlencoded",te.value=l.body.data||{}):l.body.type==="binary"?y.value="binary":(y.value="none",S.value=""):(y.value="none",S.value=""),w.value=null}else _.value.type==="collection"&&sl(_.value);oe()},cl=async()=>{if(!_.value){oe();return}const l=_.value.type,e=_.value.name;try{await Jl.confirm(`确定要删除${l==="collection"?"集合":"接口"} "${e}" 吗？${l==="collection"?"删除集合会同时删除其中的所有接口。":""}`,"确认删除",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"}),l==="collection"?await pl(_.value.id):l==="request"&&await vl(_.value.id)}catch(o){console.log("删除操作被取消或失败:",o)}oe()},pl=async l=>{try{await K.delete(`/api-testing/collections/${l}/`),p.success("集合删除成功"),s.value&&s.value.collection===l&&(s.value=null,w.value=null);const e=(i,f)=>{for(let v=0;v<i.length;v++){if(i[v].id===f)return i.splice(v,1),!0;if(i[v].children&&e(i[v].children,f))return!0}return!1};e(C.value,l);const o=z.value.findIndex(i=>i.id===l);o>-1&&z.value.splice(o,1);const r=B.value.indexOf(l);r>-1&&B.value.splice(r,1)}catch(e){p.error("删除集合失败"),console.error("Delete collection error:",e)}},vl=async l=>{try{await K.delete(`/api-testing/requests/${l}/`),p.success("接口删除成功"),s.value&&s.value.id===l&&(s.value=null,w.value=null);const e=(o,r)=>{for(const i of o){if(i.children){const f=i.children.findIndex(v=>v.type==="request"&&v.id===r);if(f>-1)return i.children.splice(f,1),!0}if(i.children&&e(i.children,r))return!0}return!1};e(C.value,l)}catch(e){p.error("删除接口失败"),console.error("Delete request error:",e)}},ml=async()=>{try{const l={...J,project:q.value},o=(await K.post("/api-testing/collections/",l)).data;p.success("创建成功"),P.value=!1,Object.assign(J,{name:"",description:"",parent:null});const r={...o,type:"collection",children:[]};if(z.value.push(o),o.parent){const i=(f,v,O)=>{for(const $ of f){if($.id===v)return $.children||($.children=[]),$.children.push(O),!0;if($.children&&i($.children,v,O))return!0}return!1};i(C.value,o.parent,r),B.value.includes(o.parent)||B.value.push(o.parent)}else C.value.push(r);B.value.includes(o.id)||B.value.push(o.id)}catch{p.error("创建失败")}},Be=()=>{s.value.assertions||(s.value.assertions=[]),s.value.assertions.push({name:`断言${s.value.assertions.length+1}`,type:"",expected:null,json_path:"",header_name:""})},fl=l=>{s.value.assertions&&s.value.assertions.splice(l,1)},yl=l=>{l.expected=null,l.json_path="",l.header_name=""},_l=l=>(le.value=l.raw,!1),bl=()=>{le.value=null},hl=()=>{if(A.value!=="connected"){p.warning("请先建立WebSocket连接");return}if(!R.value){p.error("WebSocket连接不存在");return}try{let l="";if(L.value==="text"||L.value==="json")l=_e.value;else if(L.value==="binary"&&le.value){const e=new FileReader;e.onload=o=>{R.value.send(o.target.result),Q("sent","[二进制数据]"),p.success("二进制消息已发送")},e.onerror=()=>{p.error("读取文件失败")},e.readAsArrayBuffer(le.value);return}else{p.warning("请输入消息内容或选择文件");return}R.value.send(l),Q("sent",l),p.success("消息已发送")}catch(l){const e="发送消息失败: "+l.message;Q("error",e),p.error(e)}},gl=()=>{_e.value="",le.value=null,L.value="text"},Q=(l,e)=>{const o=new Date().toLocaleTimeString();be.value.push({type:l,content:e,timestamp:o})},Re=()=>{be.value=[]},Vl=l=>{try{return JSON.parse(l),!0}catch{return!1}},kl=l=>{try{return JSON.stringify(JSON.parse(l),null,2)}catch{return l}},wl=()=>{A.value==="disconnected"?Cl():xl()},Cl=()=>{if(!s.value||!s.value.url){p.warning("请输入WebSocket连接地址");return}A.value="connecting";try{let l=s.value.url;if(I.value){const e=M.value.find(o=>o.id===I.value);e&&e.variables&&Object.entries(e.variables).forEach(([o,r])=>{l=l.replace(`{{${o}}}`,r.currentValue||r.initialValue||"")})}R.value=new WebSocket(l),R.value.onopen=()=>{A.value="connected",Q("connected",`Websocket已连接至${l}`),p.success("WebSocket连接成功")},R.value.onmessage=e=>{console.log("WebSocket message received:",e.data),Q("received",e.data),p.info("收到WebSocket消息")},R.value.onclose=()=>{A.value="disconnected",Q("info","WebSocket连接已关闭"),p.info("WebSocket连接已关闭")},R.value.onerror=e=>{A.value="disconnected";const o="WebSocket连接错误: "+(e.message||"连接失败");Q("error",o),p.error(o)}}catch(l){A.value="disconnected";const e="WebSocket连接失败: "+l.message;Q("error",e),p.error(e)}},xl=()=>{R.value&&(R.value.close(),R.value=null),A.value="disconnected",Re()},ze=async()=>{if(!q.value){p.warning("请先选择一个项目");return}if(!z.value||z.value.length===0){p.warning("请先创建一个集合");return}const l=z.value[0],e=G.value.find(r=>r.id===q.value),o=e&&e.project_type==="WEBSOCKET";k.value=!0;try{const r={name:"新建接口",method:o?"CONNECT":"GET",url:o?"ws://{{host}}/websocket":"{{base_url}}/api/new-endpoint",description:"",collection:l.id,project:q.value,request_type:o?"WEBSOCKET":"HTTP",params:{},headers:o?{}:{"Content-Type":"application/json"},body:{},auth:{},pre_request_script:"",post_request_script:""},i=await K.post("/api-testing/requests/",r);p.success("创建成功"),await Promise.all([xe(),qe()]),s.value={id:i.data.id,name:i.data.name,method:i.data.method,url:i.data.url,description:i.data.description||"",collection:i.data.collection,project:i.data.project,request_type:i.data.request_type,params:de(i.data.params||{}),headers:de(i.data.headers||{}),body:i.data.body||{},auth:i.data.auth||{},pre_request_script:i.data.pre_request_script||"",post_request_script:i.data.post_request_script||""},b.value="params",y.value="none",F.value="json",ae.value={},te.value={},S.value=""}catch(r){p.error("创建失败"),console.error("Create request error:",r)}finally{k.value=!1}},Sl=async()=>{var l;if(s.value){if(s.value.request_type==="WEBSOCKET"){p.warning("WebSocket接口暂不支持在此界面直接执行，请使用专门的WebSocket测试工具");return}if(!I.value){p.warning("请选择环境");return}U.value=!0;try{await We();let e={};if(we.value)if(y.value==="none")e={};else if(y.value==="raw"&&S.value)if(F.value==="json")try{e={type:"json",data:JSON.parse(S.value)}}catch{e={type:"raw",data:S.value}}else e={type:"raw",data:S.value};else y.value==="form-data"?e={type:"form-data",data:ae.value||{}}:y.value==="x-www-form-urlencoded"?e={type:"x-www-form-urlencoded",data:te.value||{}}:y.value==="binary"&&(e={type:"binary",data:null});const o={...s.value,params:Ue(s.value.params||[]),headers:s.value.headers,body:e,environment_id:I.value},r=await K.post(`/api-testing/requests/${s.value.id}/execute/`,o);w.value=r.data,p.success("请求发送成功")}catch(e){p.error("请求发送失败"),(l=e.response)!=null&&l.data&&(w.value=e.response.data)}finally{U.value=!1}}},ve=m({}),Ul=l=>{console.log("Headers updated:",l),ve.value=l,s.value&&(s.value={...s.value,headers:l},console.log("Updated selectedRequest.headers:",s.value.headers))},We=async()=>{if(s.value){k.value=!0;try{let l={};if(we.value)if(y.value==="none")l={};else if(y.value==="raw"&&S.value)if(F.value==="json")try{l={type:"json",data:JSON.parse(S.value)}}catch{l={type:"raw",data:S.value}}else l={type:"raw",data:S.value};else y.value==="form-data"?l={type:"form-data",data:ae.value||{}}:y.value==="x-www-form-urlencoded"?l={type:"x-www-form-urlencoded",data:te.value||{}}:y.value==="binary"&&(l={type:"binary",data:null});let e=[];if(console.log("headersEditorRef.value:",X.value),X.value){const r=X.value.rows||[];console.log("Direct access to headers rows:",r),e=r.filter(i=>i.enabled&&i.key&&i.key.trim()).map(i=>({key:i.key.trim(),value:i.value||"",description:i.description||"",enabled:i.enabled!==!1})),console.log("Final headers array format:",e)}else console.log("headersEditorRef.value is null or undefined"),s.value.headers&&Array.isArray(s.value.headers)&&(e=s.value.headers.filter(r=>r.enabled&&r.key));console.log("Final headers to save:",e),console.log("selectedRequest.value.params:",s.value.params);const o={...s.value,params:Ue(s.value.params||[]),headers:e,body:l};if(console.log("Data being sent to backend:",o),console.log("Final save data:",o),console.log("Headers being saved:",o.headers),s.value.id){await K.put(`/api-testing/requests/${s.value.id}/`,o);const r=(i,f,v)=>{for(const O of i){if(O.children){const $=O.children.find(W=>W.type==="request"&&W.id===f);if($)return $.name=v,!0}if(O.children&&r(O.children,f,v))return!0}return!1};r(C.value,s.value.id,s.value.name)}else{const r=await K.post("/api-testing/requests/",o);s.value.id=r.data.id,await xe()}p.success("保存成功")}catch{p.error("保存失败")}finally{k.value=!1}}},El=()=>{y.value==="raw"&&(F.value="json",S.value="")},ql=()=>{var l,e;try{(e=(l=w.value)==null?void 0:l.response_data)!=null&&e.json&&(w.value.response_data.body=JSON.stringify(w.value.response_data.json,null,2))}catch{p.error("格式化失败")}},Tl=()=>{Ce.value&&(navigator.clipboard.writeText(Ce.value),p.success("已复制到剪贴板"))};return Ml(()=>{el()}),$l(()=>{R.value&&(R.value.close(),R.value=null)}),(l,e)=>{var Pe;const o=g("el-option"),r=g("el-select"),i=g("el-icon"),f=g("el-button"),v=g("el-input"),O=g("el-tree"),$=g("el-empty"),W=g("el-tab-pane"),me=g("el-radio"),Nl=g("el-radio-group"),jl=g("Delete"),Ae=g("el-input-number"),Ol=g("upload-filled"),Bl=g("el-upload"),Ke=g("el-tabs"),Me=g("el-tag"),Rl=g("el-button-group"),re=g("el-form-item"),$e=g("el-form"),De=g("el-dialog");return d(),c("div",aa,[u("div",ta,[u("div",oa,[u("div",sa,[t(r,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=a=>q.value=a),placeholder:"选择项目",onChange:je},{default:n(()=>[(d(!0),c(D,null,H(G.value,a=>(d(),j(o,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u("div",na,[t(f,{type:"primary",size:"small",onClick:e[1]||(e[1]=a=>P.value=!0),title:"创建集合"},{default:n(()=>[t(i,null,{default:n(()=>[t(ee(He))]),_:1})]),_:1}),t(f,{type:"success",size:"small",onClick:ze,title:"添加接口"},{default:n(()=>[t(i,null,{default:n(()=>[t(ee(ge))]),_:1})]),_:1})])]),u("div",ua,[t(O,{ref_key:"treeRef",ref:Ve,data:C.value,props:Ze,"node-key":"id","expand-on-click-node":!1,"default-expanded-keys":B.value,onNodeClick:tl,onNodeContextmenu:ol,onNodeExpand:nl,onNodeCollapse:ul},{default:n(({node:a,data:T})=>{var h;return[u("div",da,[T.type==="collection"?(d(),j(i,{key:0},{default:n(()=>[t(ee(He))]),_:1})):(d(),j(i,{key:1},{default:n(()=>[t(ee(Hl))]),_:1})),T.type==="collection"&&x.value===T.id?(d(),c("div",ra,[t(v,{modelValue:Y.value,"onUpdate:modelValue":e[2]||(e[2]=zl=>Y.value=zl),size:"small",onBlur:Oe,onKeyup:[Ie(Oe,["enter"]),Ie(pe,["esc"])],ref_key:"editInputRef",ref:ke},null,8,["modelValue"])])):(d(),c("span",ia,E(a.label),1)),T.type==="request"&&T.request_type!=="WEBSOCKET"?(d(),c("span",{key:4,class:ie(["method-tag",(h=T.method)==null?void 0:h.toLowerCase()])},E(T.method),3)):N("",!0)])]}),_:1},8,["data","default-expanded-keys"])])]),u("div",ca,[s.value?(d(),c("div",va,[u("div",ma,[u("div",fa,[!s.value||s.value.request_type!=="WEBSOCKET"?(d(),j(r,{key:0,modelValue:s.value.method,"onUpdate:modelValue":e[3]||(e[3]=a=>s.value.method=a),style:{width:"100px"}},{default:n(()=>[(d(!0),c(D,null,H(Ye.value,a=>(d(),j(o,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):N("",!0),t(v,{modelValue:s.value.url,"onUpdate:modelValue":e[5]||(e[5]=a=>s.value.url=a),placeholder:"输入请求URL",class:ie(["url-input",{"websocket-url":s.value&&s.value.request_type==="WEBSOCKET"}])},{prepend:n(()=>[t(r,{modelValue:I.value,"onUpdate:modelValue":e[4]||(e[4]=a=>I.value=a),placeholder:"环境",style:{width:"120px"}},{default:n(()=>[t(o,{label:"无环境",value:null}),(d(!0),c(D,null,H(M.value,a=>(d(),j(o,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["modelValue","class"]),s.value&&s.value.request_type==="WEBSOCKET"?(d(),j(f,{key:1,type:A.value==="disconnected"?"primary":"info",loading:A.value==="connecting",onClick:wl},{default:n(()=>[A.value==="disconnected"?(d(),c("span",ya,"连接")):A.value==="connecting"?(d(),c("span",_a,"连接中")):(d(),c("span",ba,"关闭连接"))]),_:1},8,["type","loading"])):(d(),j(f,{key:2,type:"primary",onClick:Sl,loading:U.value},{default:n(()=>e[31]||(e[31]=[V(" 发送 ",-1)])),_:1,__:[31]},8,["loading"]))]),u("div",ha,[t(v,{modelValue:s.value.name,"onUpdate:modelValue":e[6]||(e[6]=a=>s.value.name=a),placeholder:"请求名称",size:"small",style:{width:"300px"}},null,8,["modelValue"]),t(f,{size:"small",onClick:We,loading:k.value,ref:"saveButtonRef"},{default:n(()=>e[32]||(e[32]=[V(" 保存 ",-1)])),_:1,__:[32]},8,["loading"])])]),t(Ke,{modelValue:b.value,"onUpdate:modelValue":e[18]||(e[18]=a=>b.value=a),class:"request-tabs"},{default:n(()=>[t(W,{label:"Params",name:"params"},{default:n(()=>[t(he,{modelValue:s.value.params,"onUpdate:modelValue":e[7]||(e[7]=a=>s.value.params=a),"placeholder-key":"参数名","placeholder-value":"参数值"},null,8,["modelValue"])]),_:1}),t(W,{label:"Headers",name:"headers"},{default:n(()=>[t(he,{ref_key:"headersEditorRef",ref:X,modelValue:s.value.headers,"onUpdate:modelValue":[e[8]||(e[8]=a=>s.value.headers=a),Ul],"placeholder-key":"Header名","placeholder-value":"Header值"},null,8,["modelValue"])]),_:1}),we.value?(d(),j(W,{key:0,label:"Body",name:"body"},{default:n(()=>[u("div",ga,[t(Nl,{modelValue:y.value,"onUpdate:modelValue":e[9]||(e[9]=a=>y.value=a),onChange:El},{default:n(()=>[t(me,{value:"none"},{default:n(()=>e[33]||(e[33]=[V("none",-1)])),_:1,__:[33]}),t(me,{value:"form-data"},{default:n(()=>e[34]||(e[34]=[V("form-data",-1)])),_:1,__:[34]}),t(me,{value:"x-www-form-urlencoded"},{default:n(()=>e[35]||(e[35]=[V("x-www-form-urlencoded",-1)])),_:1,__:[35]}),t(me,{value:"raw"},{default:n(()=>e[36]||(e[36]=[V("raw",-1)])),_:1,__:[36]}),t(me,{value:"binary"},{default:n(()=>e[37]||(e[37]=[V("binary",-1)])),_:1,__:[37]})]),_:1},8,["modelValue"]),y.value==="form-data"?(d(),c("div",Va,[t(he,{modelValue:ae.value,"onUpdate:modelValue":e[10]||(e[10]=a=>ae.value=a),"placeholder-key":"键","placeholder-value":"值","show-file":!0},null,8,["modelValue"])])):y.value==="x-www-form-urlencoded"?(d(),c("div",ka,[t(he,{modelValue:te.value,"onUpdate:modelValue":e[11]||(e[11]=a=>te.value=a),"placeholder-key":"键","placeholder-value":"值"},null,8,["modelValue"])])):y.value==="raw"?(d(),c("div",wa,[u("div",Ca,[t(r,{modelValue:F.value,"onUpdate:modelValue":e[12]||(e[12]=a=>F.value=a),style:{width:"150px"}},{default:n(()=>[t(o,{label:"Text",value:"text"}),t(o,{label:"JSON",value:"json"}),t(o,{label:"HTML",value:"html"}),t(o,{label:"XML",value:"xml"})]),_:1},8,["modelValue"])]),t(v,{modelValue:S.value,"onUpdate:modelValue":e[13]||(e[13]=a=>S.value=a),type:"textarea",rows:10,placeholder:"请输入请求体内容",class:"raw-body"},null,8,["modelValue"])])):N("",!0)])]),_:1})):N("",!0),!s.value||s.value.request_type!=="WEBSOCKET"?(d(),c(D,{key:1},[t(W,{label:"Pre-request Script",name:"pre-script"},{default:n(()=>[t(v,{modelValue:s.value.pre_request_script,"onUpdate:modelValue":e[14]||(e[14]=a=>s.value.pre_request_script=a),type:"textarea",rows:10,placeholder:"// 请求前脚本，使用JavaScript语法"},null,8,["modelValue"])]),_:1}),t(W,{label:"Tests",name:"tests"},{default:n(()=>[t(v,{modelValue:s.value.post_request_script,"onUpdate:modelValue":e[15]||(e[15]=a=>s.value.post_request_script=a),type:"textarea",rows:10,placeholder:"// 请求后脚本和测试，使用JavaScript语法"},null,8,["modelValue"])]),_:1}),t(W,{label:"断言",name:"assertions"},{default:n(()=>[u("div",xa,[u("div",Sa,[t(f,{size:"small",type:"primary",onClick:Be},{default:n(()=>[t(i,null,{default:n(()=>[t(ee(ge))]),_:1}),e[38]||(e[38]=V(" 添加断言 ",-1))]),_:1,__:[38]})]),u("div",Ua,[(d(!0),c(D,null,H(s.value.assertions,(a,T)=>(d(),c("div",{key:T,class:"assertion-item"},[u("div",Ea,[t(v,{modelValue:a.name,"onUpdate:modelValue":h=>a.name=h,placeholder:"断言名称",size:"small",class:"assertion-name"},null,8,["modelValue","onUpdate:modelValue"]),t(f,{size:"small",type:"danger",onClick:h=>fl(T),circle:""},{default:n(()=>[t(i,null,{default:n(()=>[t(jl)]),_:1})]),_:2},1032,["onClick"])]),u("div",qa,[t(r,{modelValue:a.type,"onUpdate:modelValue":h=>a.type=h,placeholder:"选择断言类型",size:"small",onChange:h=>yl(a)},{default:n(()=>[t(o,{label:"状态码",value:"status_code"}),t(o,{label:"响应时间",value:"response_time"}),t(o,{label:"包含文本",value:"contains"}),t(o,{label:"JSON路径",value:"json_path"}),t(o,{label:"响应头",value:"header"}),t(o,{label:"完全匹配",value:"equals"})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),a.type?(d(),c("div",Ta,[a.type==="status_code"?(d(),c("div",Na,[t(Ae,{modelValue:a.expected,"onUpdate:modelValue":h=>a.expected=h,min:100,max:599,size:"small",placeholder:"期望状态码"},null,8,["modelValue","onUpdate:modelValue"])])):a.type==="response_time"?(d(),c("div",ja,[t(Ae,{modelValue:a.expected,"onUpdate:modelValue":h=>a.expected=h,min:1,size:"small",placeholder:"最大响应时间(ms)"},null,8,["modelValue","onUpdate:modelValue"])])):a.type==="contains"?(d(),c("div",Oa,[t(v,{modelValue:a.expected,"onUpdate:modelValue":h=>a.expected=h,placeholder:"期望包含的文本",size:"small"},null,8,["modelValue","onUpdate:modelValue"])])):a.type==="json_path"?(d(),c("div",Ba,[t(v,{modelValue:a.json_path,"onUpdate:modelValue":h=>a.json_path=h,placeholder:"JSON路径表达式",size:"small",class:"assertion-input"},null,8,["modelValue","onUpdate:modelValue"]),t(v,{modelValue:a.expected,"onUpdate:modelValue":h=>a.expected=h,placeholder:"期望值",size:"small",class:"assertion-input"},null,8,["modelValue","onUpdate:modelValue"])])):a.type==="header"?(d(),c("div",Ra,[t(v,{modelValue:a.header_name,"onUpdate:modelValue":h=>a.header_name=h,placeholder:"响应头名称",size:"small",class:"assertion-input"},null,8,["modelValue","onUpdate:modelValue"]),t(v,{modelValue:a.expected_value,"onUpdate:modelValue":h=>a.expected_value=h,placeholder:"期望值",size:"small",class:"assertion-input"},null,8,["modelValue","onUpdate:modelValue"])])):a.type==="equals"?(d(),c("div",za,[t(v,{modelValue:a.expected,"onUpdate:modelValue":h=>a.expected=h,placeholder:"期望完全匹配的文本",size:"small"},null,8,["modelValue","onUpdate:modelValue"])])):N("",!0)])):N("",!0)])]))),128)),!s.value.assertions||s.value.assertions.length===0?(d(),c("div",Wa,[e[40]||(e[40]=u("p",null,"暂无断言配置",-1)),t(f,{size:"small",type:"primary",onClick:Be},{default:n(()=>[t(i,null,{default:n(()=>[t(ee(ge))]),_:1}),e[39]||(e[39]=V(" 添加第一个断言 ",-1))]),_:1,__:[39]})])):N("",!0)])])]),_:1})],64)):s.value&&s.value.request_type==="WEBSOCKET"?(d(),j(W,{key:2,label:"Message",name:"message"},{default:n(()=>[u("div",Aa,[u("div",Ka,[t(r,{modelValue:L.value,"onUpdate:modelValue":e[16]||(e[16]=a=>L.value=a),placeholder:"选择消息类型",style:{width:"150px","margin-bottom":"15px"}},{default:n(()=>[t(o,{label:"Text",value:"text"}),t(o,{label:"JSON",value:"json"}),t(o,{label:"Binary",value:"binary"})]),_:1},8,["modelValue"]),L.value==="text"||L.value==="json"?(d(),c("div",Ma,[t(v,{modelValue:_e.value,"onUpdate:modelValue":e[17]||(e[17]=a=>_e.value=a),type:"textarea",rows:6,placeholder:"请输入要发送的WebSocket消息内容"},null,8,["modelValue"])])):L.value==="binary"?(d(),c("div",$a,[t(Bl,{drag:"",action:"#","auto-upload":!1,"show-file-list":!1,"on-change":_l},{default:n(()=>[t(i,{class:"el-icon--upload"},{default:n(()=>[t(Ol)]),_:1}),e[41]||(e[41]=u("div",{class:"el-upload__text"},[V(" 将二进制文件拖到此处，或"),u("em",null,"点击上传")],-1))]),_:1,__:[41]}),le.value?(d(),c("div",Da,[u("span",null,E(le.value.name),1),t(f,{size:"small",type:"danger",onClick:bl},{default:n(()=>e[42]||(e[42]=[V("清除",-1)])),_:1,__:[42]})])):N("",!0)])):N("",!0),u("div",Pa,[t(f,{type:"primary",onClick:hl},{default:n(()=>e[43]||(e[43]=[V(" 发送消息 ",-1)])),_:1,__:[43]}),t(f,{onClick:gl},{default:n(()=>e[44]||(e[44]=[V(" 清空消息 ",-1)])),_:1,__:[44]})])]),be.value.length>0?(d(),c("div",Fa,[e[46]||(e[46]=u("h3",null,"消息历史",-1)),u("div",Ja,[(d(!0),c(D,null,H(be.value.slice().reverse(),(a,T)=>(d(),c("div",{key:T,class:ie(["websocket-message-item",a.type])},[u("div",Ha,[u("span",{class:ie(["message-type",a.type])},E(a.type==="sent"?"↑ 发送":a.type==="connected"?"✅连接成功":a.type==="info"?"ℹ️信息":a.type==="error"?"❌错误":"↓ 接收"),3),u("span",Ia,E(a.timestamp),1)]),u("div",La,[a.type==="received"&&Vl(a.content)?(d(),c("pre",Ga,E(kl(a.content)),1)):(d(),c("pre",Xa,E(a.content),1))])],2))),128))]),u("div",Ya,[t(f,{size:"small",onClick:Re},{default:n(()=>e[45]||(e[45]=[V("清空历史",-1)])),_:1,__:[45]})])])):N("",!0)])]),_:1})):N("",!0)]),_:1},8,["modelValue"]),w.value?(d(),c("div",Za,[u("div",Qa,[e[47]||(e[47]=u("h3",null,"响应",-1)),u("div",et,[t(Me,{type:Qe(w.value.status_code)},{default:n(()=>[V(E(w.value.status_code),1)]),_:1},8,["type"]),u("span",lt,E((Pe=w.value.response_time)==null?void 0:Pe.toFixed(0))+"ms",1)])]),t(Ke,{modelValue:ne.value,"onUpdate:modelValue":e[19]||(e[19]=a=>ne.value=a)},{default:n(()=>[t(W,{label:"Body",name:"body"},{default:n(()=>[u("div",at,[u("div",tt,[t(Rl,null,{default:n(()=>[t(f,{size:"small",onClick:ql},{default:n(()=>e[48]||(e[48]=[V("格式化",-1)])),_:1,__:[48]}),t(f,{size:"small",onClick:Tl},{default:n(()=>e[49]||(e[49]=[V("复制",-1)])),_:1,__:[49]})]),_:1})]),u("pre",ot,E(Ce.value),1)])]),_:1}),t(W,{label:"Headers",name:"headers"},{default:n(()=>{var a;return[u("div",st,[(d(!0),c(D,null,H((a=w.value.response_data)==null?void 0:a.headers,(T,h)=>(d(),c("div",{key:h,class:"header-row"},[u("strong",null,E(h)+":",1),V(" "+E(T),1)]))),128))])]}),_:1}),w.value.assertions_results&&w.value.assertions_results.length>0?(d(),j(W,{key:0,label:"断言结果",name:"assertions"},{default:n(()=>[u("div",nt,[(d(!0),c(D,null,H(w.value.assertions_results,(a,T)=>(d(),c("div",{key:T,class:ie(["assertion-result-item",{passed:a.passed,failed:!a.passed}])},[u("div",ut,[t(Me,{type:a.passed?"success":"danger",size:"small"},{default:n(()=>[V(E(a.passed?"通过":"失败"),1)]),_:2},1032,["type"]),u("span",dt,E(a.name),1)]),u("div",rt,[u("div",it,[e[50]||(e[50]=u("span",{class:"label"},"期望:",-1)),u("span",ct,E(a.expected!==null&&a.expected!==void 0?a.expected:"未设置"),1)]),u("div",pt,[e[51]||(e[51]=u("span",{class:"label"},"实际:",-1)),u("span",vt,E(a.actual!==null&&a.actual!==void 0?a.actual:"未获取到"),1)]),a.error?(d(),c("div",mt,[e[52]||(e[52]=u("span",{class:"label"},"错误:",-1)),u("span",ft,E(a.error),1)])):N("",!0)])],2))),128))])]),_:1})):N("",!0)]),_:1},8,["modelValue"])])):N("",!0)])):(d(),c("div",pa,[t($,{description:"请选择一个接口查看详情，或点击上方绿色按钮创建新接口"},{default:n(()=>[t(f,{type:"primary",onClick:ze},{default:n(()=>e[30]||(e[30]=[V("创建新接口",-1)])),_:1,__:[30]})]),_:1})]))])]),t(De,{modelValue:P.value,"onUpdate:modelValue":e[24]||(e[24]=a=>P.value=a),title:"创建集合",width:"500px"},{footer:n(()=>[t(f,{onClick:e[23]||(e[23]=a=>P.value=!1)},{default:n(()=>e[53]||(e[53]=[V("取消",-1)])),_:1,__:[53]}),t(f,{type:"primary",onClick:ml},{default:n(()=>e[54]||(e[54]=[V("创建",-1)])),_:1,__:[54]})]),default:n(()=>[t($e,{ref:"collectionFormRef",model:J,rules:Ee,"label-width":"80px"},{default:n(()=>[t(re,{label:"集合名称",prop:"name"},{default:n(()=>[t(v,{modelValue:J.name,"onUpdate:modelValue":e[20]||(e[20]=a=>J.name=a),placeholder:"请输入集合名称"},null,8,["modelValue"])]),_:1}),t(re,{label:"描述",prop:"description"},{default:n(()=>[t(v,{modelValue:J.description,"onUpdate:modelValue":e[21]||(e[21]=a=>J.description=a),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),t(re,{label:"父级集合",prop:"parent"},{default:n(()=>[t(r,{modelValue:J.parent,"onUpdate:modelValue":e[22]||(e[22]=a=>J.parent=a),placeholder:"选择父级集合（可选）",clearable:""},{default:n(()=>[(d(!0),c(D,null,H(z.value,a=>(d(),j(o,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(De,{modelValue:ce.value,"onUpdate:modelValue":e[29]||(e[29]=a=>ce.value=a),title:"编辑集合",width:"500px"},{footer:n(()=>[t(f,{onClick:e[28]||(e[28]=a=>ce.value=!1)},{default:n(()=>e[55]||(e[55]=[V("取消",-1)])),_:1,__:[55]}),t(f,{type:"primary",onClick:l.updateCollection},{default:n(()=>e[56]||(e[56]=[V("保存",-1)])),_:1,__:[56]},8,["onClick"])]),default:n(()=>[t($e,{ref:"editCollectionFormRef",model:Z,rules:Ee,"label-width":"80px"},{default:n(()=>[t(re,{label:"集合名称",prop:"name"},{default:n(()=>[t(v,{modelValue:Z.name,"onUpdate:modelValue":e[25]||(e[25]=a=>Z.name=a),placeholder:"请输入集合名称"},null,8,["modelValue"])]),_:1}),t(re,{label:"描述",prop:"description"},{default:n(()=>[t(v,{modelValue:Z.description,"onUpdate:modelValue":e[26]||(e[26]=a=>Z.description=a),type:"textarea",rows:3,placeholder:"请输入描述"},null,8,["modelValue"])]),_:1}),t(re,{label:"父级集合",prop:"parent"},{default:n(()=>[t(r,{modelValue:Z.parent,"onUpdate:modelValue":e[27]||(e[27]=a=>Z.parent=a),placeholder:"选择父级集合（可选）",clearable:""},{default:n(()=>[(d(!0),c(D,null,H(z.value.filter(a=>a.id!==Z.id),a=>(d(),j(o,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),Dl(u("ul",{class:"context-menu",style:Fl({left:fe.value+"px",top:ye.value+"px"})},[u("li",{onClick:dl},"添加请求"),u("li",{onClick:rl},"添加子集合"),u("li",{onClick:il},"编辑"),u("li",{onClick:cl},"删除")],4),[[Pl,ue.value]])])}}},bt=Le(yt,[["__scopeId","data-v-efd3bb43"]]);export{bt as default};
