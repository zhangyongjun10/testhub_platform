import{_ as re,q as m,v as le,Z as ae,r as _,o as r,J as V,w as n,b as e,d as a,f as v,c as p,g as G,L as ce,af as oe,T as pe,t as u,B as w,F as O,y as W,M as ve,e as z,V as _e,x as me,a7 as fe,S as ge,N as ye,E as be,H as he}from"./index-644940f8.js";import{a5 as we,a6 as ke,b as xe,a7 as ne,a8 as Ce}from"./ui_automation-3c95efdb.js";import{i as ie}from"./index-6433f102.js";const Re={key:0,class:"report-loading"},Ie={key:1,class:"report-container"},Se={class:"report-type-tabs"},$e={key:0,class:"report-content"},ze={class:"report-section"},Ve={class:"overview-cards"},De={class:"overview-card"},Pe={class:"overview-card"},Ae={class:"card-value"},Ee={class:"overview-card"},Te={class:"card-value"},Ue={class:"overview-card"},Fe={class:"card-value"},Be={key:0,class:"report-section"},Me={class:"statistics-container"},Le={class:"chart-wrapper"},je={class:"stats-table"},Ne={class:"stats-table-content"},Ge={class:"stat-value"},Oe={class:"success-row"},We={class:"stat-value"},qe={class:"info-row"},He={class:"stat-value"},Je={class:"danger-row"},Ze={class:"stat-value"},Ke={class:"warning-row"},Qe={class:"stat-value"},Xe={class:"report-section"},Ye={class:"timeline-container"},et={class:"timeline-task-content"},tt={class:"task-description"},st={key:1,class:"report-content"},lt={class:"report-section"},at={class:"steps-list"},ot={class:"step-header"},nt={class:"step-number"},it={class:"step-content"},rt={class:"step-action"},dt={key:0,class:"step-element"},ut={key:1,class:"step-thinking"},ct={key:0,class:"report-section"},pt={class:"errors-list"},vt={key:2,class:"report-content"},_t={key:0,class:"report-section"},mt={class:"performance-metrics"},ft={class:"metric-card"},gt={class:"metric-value"},yt={class:"metric-card"},bt={class:"metric-value"},ht={class:"metric-card"},wt={class:"metric-value"},kt={key:1,class:"report-section"},xt={key:2,class:"report-section"},Ct={key:3,class:"report-section"},Rt={class:"recommendations-list"},It={key:2,class:"report-error"},St={class:"dialog-footer"},$t={key:0,class:"gif-container"},zt=["src"],Vt={__name:"AIExecutionReport",props:{modelValue:{type:Boolean,default:!1},recordId:{type:[Number,String],default:null}},emits:["update:modelValue"],setup(se,{emit:U}){const b=se,D=U,R=m(!1),P=m(!1),s=m(null),y=m("summary"),f=m(!1),A=m(null),I=m(null);let x=null,C=null;const F=le(()=>({summary:"执行摘要",detailed:"详细步骤",performance:"性能分析"})[y.value]||"执行摘要"),L=le(()=>{if(s.value&&s.value.gif_path){const o=s.value.gif_path;return o.startsWith("media/")?`/${o}`:`/media/${o}`}return""});ae(()=>b.modelValue,o=>{R.value=o,o&&b.recordId&&(y.value="summary",q("summary"))}),ae(R,o=>{D("update:modelValue",o),o||(x&&(x.dispose(),x=null),C&&(C.dispose(),C=null))});const q=async(o="summary")=>{if(b.recordId){P.value=!0;try{const t=await we(b.recordId,{report_type:o});console.log("API Response:",t.data),t.data.success?(s.value=t.data.data,console.log("Report Data:",s.value),await ve(),setTimeout(()=>{o==="summary"?E():o==="performance"&&Q()},100)):z.error(t.data.error||"获取报告失败")}catch(t){console.error("加载报告失败:",t),z.error("加载报告失败")}finally{P.value=!1}}},K=o=>{y.value=o,q(o)},E=()=>{if(!A.value||!s.value)return;if(!s.value.statistics){console.warn("统计数据不存在");return}x&&x.dispose(),x=ie(A.value);const o=s.value.statistics,t={tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},legend:{orient:"vertical",right:10,top:"center"},series:[{type:"pie",radius:["40%","70%"],center:["35%","50%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:16,fontWeight:"bold"}},labelLine:{show:!1},data:[{value:o.completed||0,name:"已完成",itemStyle:{color:"#67C23A"}},{value:o.pending||0,name:"待执行",itemStyle:{color:"#909399"}},{value:o.failed||0,name:"失败",itemStyle:{color:"#F56C6C"}},{value:o.skipped||0,name:"跳过",itemStyle:{color:"#E6A23C"}}].filter(g=>g.value>0)}]};x.setOption(t)},Q=()=>{if(!I.value||!s.value)return;if(!s.value.action_distribution){console.warn("操作分布数据不存在");return}C&&C.dispose(),C=ie(I.value);const o=s.value.action_distribution,t=[{name:"点击",value:o.click||0},{name:"输入",value:o.input||0},{name:"滚动",value:o.scroll||0},{name:"等待",value:o.wait||0},{name:"切换标签",value:o.switch_tab||0},{name:"导航",value:o.navigate||0},{name:"新标签",value:o.open_tab||0},{name:"任务完成",value:o.done||0},{name:"其他",value:o.other||0}].filter(h=>h.value>0),g={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},xAxis:{type:"category",data:t.map(h=>h.name)},yAxis:{type:"value"},series:[{type:"bar",data:t.map(h=>h.value),itemStyle:{color:"#409EFF"}}]};C.setOption(g)},X=o=>({completed:"success",pending:"info",failed:"danger",skipped:"warning"})[o]||"info",Y=o=>({completed:"success",pending:"info",failed:"danger",skipped:"warning"})[o]||"info",ee=o=>({completed:"success",pending:"info",failed:"danger"})[o]||"info",te=async()=>{var o,t;if(!b.recordId){z.error("无法导出报告：缺少记录ID");return}try{z.info("正在生成PDF报告，请稍候...");const g=await ke(b.recordId,{report_type:y.value}),h=new Blob([g.data],{type:"application/pdf"}),B=window.URL.createObjectURL(h),k=document.createElement("a");k.href=B;const i=g.headers["content-disposition"];let l="AI_Report.pdf";if(i){const S=i.match(/filename="(.+)"/);S&&S[1]&&(l=decodeURIComponent(S[1]))}k.download=l,document.body.appendChild(k),k.click(),document.body.removeChild(k),window.URL.revokeObjectURL(B),z.success("PDF报告导出成功！")}catch(g){console.error("导出报告失败:",g),z.error(((t=(o=g.response)==null?void 0:o.data)==null?void 0:t.error)||"导出报告失败，请稍后重试")}},j=()=>{R.value=!1};return(o,t)=>{const g=_("el-icon"),h=_("el-radio-button"),B=_("el-radio-group"),k=_("el-button"),i=_("el-tag"),l=_("el-card"),S=_("el-timeline-item"),T=_("el-timeline"),H=_("el-alert"),M=_("el-table-column"),$=_("el-table"),J=_("el-empty"),Z=_("el-dialog");return r(),V(Z,{modelValue:R.value,"onUpdate:modelValue":t[3]||(t[3]=d=>R.value=d),title:`AI测试执行报告 - ${F.value}`,width:"1000px","close-on-click-modal":!1,onClose:j},{footer:n(()=>[e("span",St,[a(k,{onClick:j},{default:n(()=>t[35]||(t[35]=[v("关闭",-1)])),_:1,__:[35]})])]),default:n(()=>[P.value?(r(),p("div",Re,[a(g,{class:"is-loading"},{default:n(()=>[a(G(ce))]),_:1}),t[4]||(t[4]=e("span",null,"正在生成报告...",-1))])):s.value?(r(),p("div",Ie,[e("div",Se,[a(B,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=d=>y.value=d),onChange:K},{default:n(()=>[a(h,{value:"summary"},{default:n(()=>t[5]||(t[5]=[v("执行摘要",-1)])),_:1,__:[5]}),a(h,{value:"detailed"},{default:n(()=>t[6]||(t[6]=[v("详细步骤",-1)])),_:1,__:[6]}),a(h,{value:"performance"},{default:n(()=>t[7]||(t[7]=[v("性能分析",-1)])),_:1,__:[7]})]),_:1},8,["modelValue"]),s.value.gif_path?(r(),V(k,{key:0,type:"primary",size:"small",onClick:t[1]||(t[1]=d=>f.value=!0)},{default:n(()=>[a(g,null,{default:n(()=>[a(G(oe))]),_:1}),t[8]||(t[8]=v(" 查看GIF回放 ",-1))]),_:1,__:[8]})):(r(),V(k,{key:1,type:"info",size:"small",disabled:""},{default:n(()=>[a(g,null,{default:n(()=>[a(G(oe))]),_:1}),t[9]||(t[9]=v(" GIF未生成 ",-1))]),_:1,__:[9]})),a(k,{type:"success",size:"small",onClick:te},{default:n(()=>[a(g,null,{default:n(()=>[a(G(pe))]),_:1}),t[10]||(t[10]=v(" 导出报告 ",-1))]),_:1,__:[10]})]),y.value==="summary"?(r(),p("div",$e,[e("div",ze,[t[15]||(t[15]=e("h3",{class:"section-title"},"执行概览",-1)),e("div",Ve,[e("div",De,[t[11]||(t[11]=e("div",{class:"card-label"},"执行状态",-1)),a(i,{type:s.value.overview.status_color,size:"large"},{default:n(()=>[v(u(s.value.overview.status),1)]),_:1},8,["type"])]),e("div",Pe,[t[12]||(t[12]=e("div",{class:"card-label"},"执行时长",-1)),e("div",Ae,u(s.value.overview.duration_formatted),1)]),e("div",Ee,[t[13]||(t[13]=e("div",{class:"card-label"},"任务完成率",-1)),e("div",Te,u(s.value.overview.completion_rate)+"%",1)]),e("div",Ue,[t[14]||(t[14]=e("div",{class:"card-label"},"执行步骤",-1)),e("div",Fe,u(s.value.overview.total_steps)+" 步",1)])])]),s.value.statistics?(r(),p("div",Be,[t[21]||(t[21]=e("h3",{class:"section-title"},"任务统计",-1)),e("div",Me,[e("div",Le,[e("div",{ref_key:"pieChartRef",ref:A,class:"chart",style:{height:"200px"}},null,512)]),e("div",je,[e("table",Ne,[e("tbody",null,[e("tr",null,[t[16]||(t[16]=e("td",null,"总任务数",-1)),e("td",Ge,u(s.value.statistics.total),1)]),e("tr",Oe,[t[17]||(t[17]=e("td",null,"已完成",-1)),e("td",We,u(s.value.statistics.completed),1)]),e("tr",qe,[t[18]||(t[18]=e("td",null,"待执行",-1)),e("td",He,u(s.value.statistics.pending),1)]),e("tr",Je,[t[19]||(t[19]=e("td",null,"失败",-1)),e("td",Ze,u(s.value.statistics.failed),1)]),e("tr",Ke,[t[20]||(t[20]=e("td",null,"跳过",-1)),e("td",Qe,u(s.value.statistics.skipped),1)])])])])])])):w("",!0),e("div",Xe,[t[22]||(t[22]=e("h3",{class:"section-title"},"任务执行时间线",-1)),e("div",Ye,[a(T,null,{default:n(()=>[(r(!0),p(O,null,W(s.value.timeline,d=>(r(),V(S,{key:d.id,timestamp:`任务 ${d.id}`,placement:"top",type:X(d.status)},{default:n(()=>[a(l,null,{default:n(()=>[e("div",et,[e("div",tt,u(d.description),1),a(i,{type:Y(d.status),size:"small"},{default:n(()=>[v(u(d.status_display),1)]),_:2},1032,["type"])])]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1})])])])):y.value==="detailed"?(r(),p("div",st,[e("div",lt,[t[26]||(t[26]=e("h3",{class:"section-title"},"执行步骤详情",-1)),e("div",at,[(r(!0),p(O,null,W(s.value.detailed_steps,d=>(r(),V(l,{key:d.step_number,class:"step-card"},{default:n(()=>[e("div",ot,[e("span",nt,"步骤 "+u(d.step_number),1),a(i,{type:ee(d.status),size:"small"},{default:n(()=>[v(u(d.status),1)]),_:2},1032,["type"])]),e("div",it,[e("div",rt,[t[23]||(t[23]=e("strong",null,"操作:",-1)),v(" "+u(d.action||"-"),1)]),d.element?(r(),p("div",dt,[t[24]||(t[24]=e("strong",null,"元素:",-1)),v(" "+u(d.element),1)])):w("",!0),d.thinking?(r(),p("div",ut,[t[25]||(t[25]=e("strong",null,"思考:",-1)),v(" "+u(d.thinking),1)])):w("",!0)])]),_:2},1024))),128))])]),s.value.errors&&s.value.errors.length>0?(r(),p("div",ct,[t[27]||(t[27]=e("h3",{class:"section-title"},"错误信息",-1)),e("div",pt,[(r(!0),p(O,null,W(s.value.errors,(d,N)=>(r(),V(H,{key:N,type:d.type==="error"?"error":"warning",title:d.message,closable:!1,"show-icon":""},null,8,["type","title"]))),128))])])):w("",!0)])):y.value==="performance"?(r(),p("div",vt,[s.value.metrics?(r(),p("div",_t,[t[31]||(t[31]=e("h3",{class:"section-title"},"性能指标",-1)),e("div",mt,[e("div",ft,[t[28]||(t[28]=e("div",{class:"metric-label"},"平均步骤耗时",-1)),e("div",gt,u(s.value.metrics.avg_step_duration)+" 秒",1)]),e("div",yt,[t[29]||(t[29]=e("div",{class:"metric-label"},"最长步骤耗时",-1)),e("div",bt,u(s.value.metrics.max_step_duration)+" 秒",1)]),e("div",ht,[t[30]||(t[30]=e("div",{class:"metric-label"},"最短步骤耗时",-1)),e("div",wt,u(s.value.metrics.min_step_duration)+" 秒",1)])])])):w("",!0),s.value.action_distribution?(r(),p("div",kt,[t[32]||(t[32]=e("h3",{class:"section-title"},"操作类型分布",-1)),e("div",{ref_key:"barChartRef",ref:I,class:"chart",style:{height:"250px"}},null,512)])):w("",!0),s.value.bottlenecks&&s.value.bottlenecks.length>0?(r(),p("div",xt,[t[33]||(t[33]=e("h3",{class:"section-title"},"性能瓶颈",-1)),a($,{data:s.value.bottlenecks,stripe:""},{default:n(()=>[a(M,{prop:"step_number",label:"步骤",width:"80"}),a(M,{prop:"action",label:"操作","min-width":"200"}),a(M,{prop:"duration",label:"耗时(秒)",width:"100"}),a(M,{prop:"slower_than_avg_by",label:"慢于平均",width:"100"},{default:n(({row:d})=>[v(u(d.slower_than_avg_by)+"% ",1)]),_:1})]),_:1},8,["data"])])):w("",!0),s.value.recommendations&&s.value.recommendations.length>0?(r(),p("div",Ct,[t[34]||(t[34]=e("h3",{class:"section-title"},"优化建议",-1)),e("div",Rt,[(r(!0),p(O,null,W(s.value.recommendations,(d,N)=>(r(),V(H,{key:N,type:"info",title:d,closable:!1,"show-icon":""},null,8,["title"]))),128))])])):w("",!0)])):w("",!0)])):(r(),p("div",It,[a(J,{description:"暂无报告数据"})])),a(Z,{modelValue:f.value,"onUpdate:modelValue":t[2]||(t[2]=d=>f.value=d),title:"GIF回放",width:"800px","append-to-body":""},{default:n(()=>[s.value&&s.value.gif_path?(r(),p("div",$t,[e("img",{src:L.value,alt:"Execution GIF",class:"gif-image"},null,8,zt)])):w("",!0)]),_:1},8,["modelValue"])]),_:1},8,["modelValue","title"])}}},Dt=re(Vt,[["__scopeId","data-v-2861d9f1"]]);const Pt={class:"page-container"},At={class:"page-header"},Et={class:"header-actions"},Tt={class:"card-container"},Ut={class:"pagination-container"},Ft={key:0,class:"record-detail"},Bt={class:"detail-item"},Mt={class:"value"},Lt={class:"detail-item"},jt={class:"detail-item"},Nt={class:"detail-item"},Gt={key:0,class:"detail-item mt-15"},Ot={key:1,class:"task-description-container"},Wt={class:"task-description-content"},qt={class:"log-container"},Ht={class:"dialog-footer"},Jt={__name:"AIExecutionRecords",setup(se){const U=m([]),b=m(""),D=m([]),R=m(!1),P=m(0),s=_e({currentPage:1,pageSize:20}),y=m(!1),f=m(null);let A=null;const I=m([]),x=m(!1),C=m(null),F=m(!1),L=m(null),q=async()=>{try{const i=await xe({page_size:100});U.value=i.data.results||i.data,U.value.length>0&&(b.value=U.value[0].id,E(),k())}catch(i){console.error("获取项目列表失败:",i),z.error("获取项目列表失败")}},K=()=>{s.currentPage=1,E()},E=async()=>{if(b.value){R.value=!0;try{const i=await ne({project:b.value,page:s.currentPage,page_size:s.pageSize});D.value=i.data.results||[],P.value=i.data.count||0,C.value&&C.value.clearSelection()}catch(i){console.error("获取执行记录失败:",i),z.error("获取执行记录失败")}finally{R.value=!1}}},Q=()=>{s.currentPage=1,E()},X=()=>{E()},Y=i=>{f.value=i,y.value=!0},ee=i=>{L.value=i.id,F.value=!0},te=()=>{f.value&&(L.value=f.value.id,F.value=!0)},j=i=>({pending:"info",running:"warning",passed:"success",failed:"danger"})[i]||"info",o=i=>({pending:"等待中",running:"执行中",passed:"成功",failed:"失败"})[i]||i,t=(i,l,S)=>S?new Date(S).toLocaleString():"",g=i=>(s.currentPage-1)*s.pageSize+i+1,h=i=>{I.value=i},B=async()=>{if(I.value.length!==0)try{await be.confirm(`确定要删除选中的 ${I.value.length} 条记录吗？此操作不可恢复。`,"批量删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"警告"}),x.value=!0;const i=I.value.map(l=>l.id);await Ce(i),z.success("删除成功"),D.value.length===i.length&&s.currentPage>1&&s.currentPage--,E()}catch(i){i!=="cancel"&&(console.error("批量删除失败:",i),z.error("批量删除失败"))}finally{x.value=!1}},k=()=>{A=setInterval(()=>{if(s.currentPage===1&&!y.value&&!R.value){if(!D.value.some(l=>l.status==="running"||l.status==="pending"))return;ne({project:b.value,page:1,page_size:s.pageSize}).then(l=>{I.value.length===0&&(D.value=l.data.results||[],P.value=l.data.count||0)}).catch(console.error)}},5e3)};return me(()=>{q()}),fe(()=>{A&&clearInterval(A)}),(i,l)=>{const S=_("el-icon"),T=_("el-button"),H=_("el-option"),M=_("el-select"),$=_("el-table-column"),J=_("el-tag"),Z=_("el-table"),d=_("el-pagination"),N=_("el-dialog"),de=ge("loading");return r(),p("div",Pt,[e("div",At,[l[7]||(l[7]=e("h1",{class:"page-title"},"AI 执行记录",-1)),e("div",Et,[a(T,{type:"danger",disabled:I.value.length===0,onClick:B,loading:x.value},{default:n(()=>[a(S,null,{default:n(()=>[a(G(he))]),_:1}),l[6]||(l[6]=v(" 批量删除 ",-1))]),_:1,__:[6]},8,["disabled","loading"]),a(M,{modelValue:b.value,"onUpdate:modelValue":l[0]||(l[0]=c=>b.value=c),placeholder:"选择项目",style:{width:"200px","margin-left":"15px"},onChange:K},{default:n(()=>[(r(!0),p(O,null,W(U.value,c=>(r(),V(H,{key:c.id,label:c.name,value:c.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),e("div",Tt,[ye((r(),V(Z,{data:D.value,style:{width:"100%"},onSelectionChange:h,ref_key:"tableRef",ref:C},{default:n(()=>[a($,{type:"selection",width:"55"}),a($,{label:"序号",width:"80"},{default:n(({$index:c})=>[v(u(g(c)),1)]),_:1}),a($,{prop:"case_name",label:"用例名称","min-width":"200","show-overflow-tooltip":""}),a($,{prop:"status",label:"状态",width:"120"},{default:n(({row:c})=>[a(J,{type:j(c.status)},{default:n(()=>[v(u(o(c.status)),1)]),_:2},1032,["type"])]),_:1}),a($,{prop:"duration",label:"耗时(秒)",width:"120"},{default:n(({row:c})=>[v(u(c.duration?c.duration.toFixed(2):"-"),1)]),_:1}),a($,{prop:"start_time",label:"开始时间",width:"180",formatter:t}),a($,{prop:"executed_by.username",label:"执行人",width:"120"}),a($,{label:"操作",width:"200",fixed:"right"},{default:n(({row:c})=>[a(T,{size:"small",onClick:ue=>Y(c)},{default:n(()=>l[8]||(l[8]=[v(" 查看详情 ",-1)])),_:2,__:[8]},1032,["onClick"]),a(T,{size:"small",type:"success",onClick:ue=>ee(c)},{default:n(()=>l[9]||(l[9]=[v(" 查看报告 ",-1)])),_:2,__:[9]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[de,R.value]]),e("div",Ut,[a(d,{"current-page":s.currentPage,"onUpdate:currentPage":l[1]||(l[1]=c=>s.currentPage=c),"page-size":s.pageSize,"onUpdate:pageSize":l[2]||(l[2]=c=>s.pageSize=c),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:P.value,onSizeChange:Q,onCurrentChange:X},null,8,["current-page","page-size","total"])])]),a(N,{modelValue:y.value,"onUpdate:modelValue":l[4]||(l[4]=c=>y.value=c),title:"执行详情",width:"800px"},{footer:n(()=>[e("div",Ht,[a(T,{type:"success",onClick:te},{default:n(()=>l[16]||(l[16]=[v("查看报告",-1)])),_:1,__:[16]}),a(T,{onClick:l[3]||(l[3]=c=>y.value=!1)},{default:n(()=>l[17]||(l[17]=[v("关闭",-1)])),_:1,__:[17]})])]),default:n(()=>[f.value?(r(),p("div",Ft,[e("div",Bt,[l[10]||(l[10]=e("span",{class:"label"},"用例名称:",-1)),e("span",Mt,u(f.value.case_name),1)]),e("div",Lt,[l[11]||(l[11]=e("span",{class:"label"},"状态:",-1)),a(J,{type:j(f.value.status)},{default:n(()=>[v(u(o(f.value.status)),1)]),_:1},8,["type"])]),e("div",jt,[l[12]||(l[12]=e("span",{class:"label"},"开始时间:",-1)),e("span",null,u(t(null,null,f.value.start_time)),1)]),e("div",Nt,[l[13]||(l[13]=e("span",{class:"label"},"耗时:",-1)),e("span",null,u(f.value.duration?f.value.duration.toFixed(2)+" 秒":"未知"),1)]),f.value.task_description?(r(),p("div",Gt,l[14]||(l[14]=[e("span",{class:"label"},"任务描述:",-1)]))):w("",!0),f.value.task_description?(r(),p("div",Ot,[e("div",Wt,u(f.value.task_description),1)])):w("",!0),l[15]||(l[15]=e("div",{class:"detail-item mt-15"},[e("span",{class:"label"},"执行日志:")],-1)),e("div",qt,[e("pre",null,u(f.value.logs),1)])])):w("",!0)]),_:1},8,["modelValue"]),a(Dt,{modelValue:F.value,"onUpdate:modelValue":l[5]||(l[5]=c=>F.value=c),"record-id":L.value},null,8,["modelValue","record-id"])])}}},Xt=re(Jt,[["__scopeId","data-v-8a292beb"]]);export{Xt as default};
