import{_ as me,q as _,V as fe,Z as R,x as ge,r as f,o as b,c as N,b as a,d as l,w as s,N as he,O as ye,t as u,e as $,F as G,y as J,J as M,g as S,U as Ee,ar as we,A as H,D as Ce,av as be,B as K,ag as $e,f as g,H as W,W as ke,G as xe,ac as Te,a2 as Se}from"./index-054e2682.js";import{b as Ve,y as De,h as Ne,i as ze,z as Ue}from"./ui_automation-53e326f9.js";const je={class:"script-editor-enhanced"},Be={class:"page-header"},Le={class:"header-actions"},Pe={class:"main-content"},Oe={class:"left-panel"},Ie={class:"panel-header"},Me={class:"panel-content"},Ae={class:"tree-node"},Fe={class:"node-label"},Re={key:0,class:"node-actions"},Ge={class:"center-panel"},Je={class:"editor-toolbar"},He={class:"toolbar-left"},Ke={class:"toolbar-right"},We={class:"code-editor-container"},Xe={class:"editor-status"},qe={class:"right-panel"},Ye={class:"panel-content"},Ze={class:"log-controls"},Qe={class:"log-output"},et={class:"log-time"},tt={class:"log-level"},lt={class:"log-message"},at={class:"panel-content"},nt={class:"element-detail"},st={class:"element-actions",style:{"margin-top":"15px"}},ot={__name:"ScriptEditorEnhanced",setup(rt){const D=_([]),h=_(""),m=_(""),y=_("python"),V=_("playwright"),z=_([]),P=_(""),d=_(null),k=_([]),U=fe({line:1,column:1}),O=_(!1),j=_("logs"),E=_(null),X=async()=>{try{const t=await Ve({page_size:100});D.value=t.data.results||t.data}catch(t){$.error("获取项目列表失败"),console.error("获取项目列表失败:",t)}},q=async()=>{var t;if(!h.value){z.value=[];return}try{const[e,o]=await Promise.all([Ne({project:h.value}),ze({project:h.value})]),i=x=>x.map(c=>({...c,type:"page",children:c.children?i(c.children):[]})),r=i(e.data||[]),w=((t=o.data)==null?void 0:t.results)||o.data||[];console.log("=== 智能脚本生成 - 加载元素树 ==="),console.log("页面节点数:",r.length),console.log("元素总数:",w.length);const v=x=>{x.forEach(c=>{const C=w.filter(T=>T.group_id===c.id);console.log(`页面 ${c.name} (ID: ${c.id}) 找到 ${C.length} 个元素`);const L=C.map(T=>({...T,type:"element"}));c.children=c.children?[...c.children,...L]:[...L],c.children&&v(c.children.filter(T=>T.type==="page"))})};v(r),z.value=r,p("info",`已加载 ${Y(z.value)} 个元素`)}catch(e){console.error("获取元素树失败:",e),p("error","获取元素树失败")}},Y=t=>{let e=0;const o=i=>{i.forEach(r=>{r.type==="element"&&e++,r.children&&o(r.children)})};return o(t),e},Z=()=>{},Q=()=>{},ee=()=>{B()},B=()=>{if(E.value){const t=E.value,e=t.value,o=t.selectionStart,i=e.substring(0,o).split(`
`);U.line=i.length,U.column=i[i.length-1].length+1}},A=async()=>{d.value=null,k.value=[],m.value="",await q()},te=(t,e)=>t?e.name.indexOf(t)!==-1:!0,le=t=>{t.type==="element"&&(d.value=t,j.value="elementDetail")},ae=t=>{d.value=t,j.value="elementDetail"},F=t=>{if(t.type!=="element")return;const e=se(t);ne(e+`
`),p("info",`插入元素代码: ${t.name}`)},ne=t=>{if(!E.value)return;const e=E.value,o=e.selectionStart,i=e.selectionEnd,r=e.value,w=r.substring(0,o)+t+r.substring(i);m.value=w,setTimeout(()=>{e.focus(),e.setSelectionRange(o+t.length,o+t.length),B()},0)},se=t=>{var i;const e=t.locator_value||"",o=((i=t.locator_strategy)==null?void 0:i.name)||t.locator_strategy||"css";if(y.value==="javascript")switch(V.value){case"playwright":return`await page.locator('${e}').click();`;case"selenium":return`await driver.findElement(By.${o.toUpperCase()}('${e}')).click();`;default:return`await page.locator('${e}').click();`}else switch(V.value){case"playwright":return`page.locator('${e}').click()`;case"selenium":return`driver.find_element(By.${o.toUpperCase()}, '${e}').click()`;default:return`page.locator('${e}').click()`}},oe=()=>{const t=D.value.find(c=>c.id===h.value),e=(t==null?void 0:t.name)||"Script",o=y.value==="javascript"?"JS":"Python",i=V.value==="playwright"?"Playwright":"Selenium",r=new Date,w=`${r.getFullYear()}${String(r.getMonth()+1).padStart(2,"0")}${String(r.getDate()).padStart(2,"0")}`,v=Date.now()%1e3,x=y.value==="javascript"?"js":"py";return`${e}_${o}_${i}_${w}_${v}.${x}`},re=async()=>{if(!h.value){$.warning("请先选择项目");return}if(!m.value.trim()){$.warning("脚本内容不能为空");return}try{O.value=!0;const t=oe();await De({name:t,project:h.value,script_type:"CODE",content:m.value,language:y.value,framework:V.value}),$.success(`脚本保存成功: ${t}`),p("success",`脚本已保存: ${t}`)}catch(t){console.error("保存脚本失败:",t),$.error("脚本保存失败"),p("error","脚本保存失败")}finally{O.value=!1}},ie=async t=>{try{const o=(await Ue(t.id)).data;o.is_valid?($.success("元素验证通过"),p("info",`元素验证通过: ${t.name}`)):($.error(`元素验证失败: ${o.validation_message}`),p("error",`元素验证失败: ${t.name} - ${o.validation_message}`))}catch(e){console.error("验证元素失败:",e),$.error("验证元素失败"),p("error",`验证元素失败: ${t.name}`)}},ce=()=>{try{if(y.value==="javascript"){let t=m.value.replace(/;/g,`;
`).replace(/\{/g,` {
`).replace(/\}/g,`
}`).replace(/\n\s*\n/g,`
`);m.value=t,p("info","代码格式化完成")}else p("info","当前语言的格式化功能开发中...")}catch{p("error","代码格式化失败")}},ue=()=>{m.value="",p("info","代码已清空")},de=()=>{k.value=[]},p=(t,e)=>{k.value.push({level:t,message:e,timestamp:new Date}),k.value.length>100&&(k.value=k.value.slice(-100))},pe=t=>t==="page"?Te:Se,ve=t=>({BUTTON:"按钮",INPUT:"输入框",LINK:"链接",DROPDOWN:"下拉框",CHECKBOX:"复选框",RADIO:"单选框",TEXT:"文本",IMAGE:"图片",CONTAINER:"容器",TABLE:"表格",FORM:"表单",MODAL:"弹窗"})[t]||t,_e=t=>t.toLocaleTimeString();return R(P,t=>{}),R(y,t=>{p("info",`切换到${t}语言`)}),ge(async()=>{await X(),D.value.length>0&&(h.value=D.value[0].id,await A()),E.value&&(E.value.addEventListener("click",B),E.value.addEventListener("keyup",B))}),(t,e)=>{const o=f("el-option"),i=f("el-select"),r=f("el-icon"),w=f("el-input"),v=f("el-button"),x=f("el-tree"),c=f("el-tab-pane"),C=f("el-descriptions-item"),L=f("el-descriptions"),T=f("el-tabs");return b(),N("div",je,[a("div",Be,[e[8]||(e[8]=a("h1",{class:"page-title"},"智能脚本生成",-1)),a("div",Le,[l(i,{modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=n=>h.value=n),placeholder:"选择项目",style:{width:"200px","margin-right":"15px"},onChange:A},{default:s(()=>[(b(!0),N(G,null,J(D.value,n=>(b(),M(o,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),a("div",Pe,[a("div",Oe,[a("div",Ie,[e[9]||(e[9]=a("h3",null,"元素库",-1)),l(w,{modelValue:P.value,"onUpdate:modelValue":e[1]||(e[1]=n=>P.value=n),placeholder:"搜索元素...",clearable:"",size:"small",style:{"margin-top":"10px"}},{prefix:s(()=>[l(r,null,{default:s(()=>[l(S(Ee))]),_:1})]),_:1},8,["modelValue"])]),a("div",Me,[l(x,{data:z.value,"filter-node-method":te,props:{children:"children",label:"name"},"node-key":"id","default-expand-all":"",onNodeClick:le},{default:s(({data:n})=>[a("div",Ae,[l(r,{class:"node-icon"},{default:s(()=>[(b(),M(we(pe(n.type))))]),_:2},1024),a("span",Fe,u(n.name),1),n.type==="element"?(b(),N("div",Re,[l(v,{size:"small",text:"",onClick:H(I=>F(n),["stop"]),title:"点击插入代码"},{default:s(()=>[l(r,null,{default:s(()=>[l(S(Ce))]),_:1})]),_:2},1032,["onClick"]),l(v,{size:"small",text:"",onClick:H(I=>ae(n),["stop"])},{default:s(()=>[l(r,null,{default:s(()=>[l(S(be))]),_:1})]),_:2},1032,["onClick"])])):K("",!0)])]),_:1},8,["data"])])]),a("div",Ge,[a("div",Je,[a("div",He,[l(i,{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=n=>y.value=n),size:"small",style:{width:"120px"}},{default:s(()=>[l(o,{label:"JavaScript",value:"javascript"}),l(o,{label:"Python",value:"python"})]),_:1},8,["modelValue"]),l(i,{modelValue:V.value,"onUpdate:modelValue":e[3]||(e[3]=n=>V.value=n),size:"small",style:{width:"120px","margin-left":"10px"}},{default:s(()=>[l(o,{label:"Playwright",value:"playwright"}),l(o,{label:"Selenium",value:"selenium"})]),_:1},8,["modelValue"])]),a("div",Ke,[l(v,{size:"small",onClick:ce},{default:s(()=>[l(r,null,{default:s(()=>[l(S($e))]),_:1}),e[10]||(e[10]=g(" 格式化 ",-1))]),_:1,__:[10]}),l(v,{size:"small",onClick:ue},{default:s(()=>[l(r,null,{default:s(()=>[l(S(W))]),_:1}),e[11]||(e[11]=g(" 清空 ",-1))]),_:1,__:[11]}),l(v,{size:"small",type:"primary",onClick:re,loading:O.value},{default:s(()=>[l(r,null,{default:s(()=>[l(S(ke))]),_:1}),e[12]||(e[12]=g(" 保存脚本 ",-1))]),_:1,__:[12]},8,["loading"])])]),a("div",We,[he(a("textarea",{ref_key:"codeEditor",ref:E,"onUpdate:modelValue":e[4]||(e[4]=n=>m.value=n),class:"code-editor",placeholder:"请输入脚本代码或点击左侧元素库中的+号自动插入代码...",onFocus:Z,onBlur:Q,onInput:ee},null,544),[[ye,m.value]])]),a("div",Xe,[a("span",null,"行: "+u(U.line)+", 列: "+u(U.column),1),a("span",null,"字符数: "+u(m.value.length),1),a("span",null,"语言: "+u(y.value),1)])]),a("div",qe,[l(T,{modelValue:j.value,"onUpdate:modelValue":e[7]||(e[7]=n=>j.value=n),type:"border-card"},{default:s(()=>[l(c,{label:"执行日志",name:"logs"},{default:s(()=>[a("div",Ye,[a("div",Ze,[l(v,{size:"small",onClick:de},{default:s(()=>[l(r,null,{default:s(()=>[l(S(W))]),_:1}),e[13]||(e[13]=g(" 清空日志 ",-1))]),_:1,__:[13]})]),a("div",Qe,[(b(!0),N(G,null,J(k.value,(n,I)=>(b(),N("div",{key:I,class:xe(["log-entry",n.level])},[a("span",et,u(_e(n.timestamp)),1),a("span",tt,u(n.level.toUpperCase()),1),a("span",lt,u(n.message),1)],2))),128))])])]),_:1}),d.value?(b(),M(c,{key:0,label:"元素详情",name:"elementDetail"},{default:s(()=>[a("div",at,[a("div",nt,[a("h4",null,u(d.value.name),1),l(L,{column:1,border:"",size:"small"},{default:s(()=>[l(C,{label:"类型"},{default:s(()=>[g(u(ve(d.value.element_type)),1)]),_:1}),l(C,{label:"页面"},{default:s(()=>[g(u(d.value.page||"未指定"),1)]),_:1}),l(C,{label:"定位策略"},{default:s(()=>{var n;return[g(u(((n=d.value.locator_strategy)==null?void 0:n.name)||d.value.locator_strategy),1)]}),_:1}),l(C,{label:"定位表达式"},{default:s(()=>[a("code",null,u(d.value.locator_value),1)]),_:1}),l(C,{label:"使用次数"},{default:s(()=>[g(u(d.value.usage_count||0),1)]),_:1})]),_:1}),a("div",st,[l(v,{size:"small",type:"primary",onClick:e[5]||(e[5]=n=>F(d.value))},{default:s(()=>e[14]||(e[14]=[g(" 插入代码 ",-1)])),_:1,__:[14]}),l(v,{size:"small",onClick:e[6]||(e[6]=n=>ie(d.value))},{default:s(()=>e[15]||(e[15]=[g(" 验证元素 ",-1)])),_:1,__:[15]})])])])]),_:1})):K("",!0)]),_:1},8,["modelValue"])])])])}}},ut=me(ot,[["__scopeId","data-v-ae98903f"]]);export{ut as default};
