import{_ as te,q as b,r,S as ve,o as _,c as A,N as _e,J as k,w as t,d as e,f as u,t as E,B as G,b as v,R as fe,V as be,v as ye,x as Ve,C as O,e as g,g as Y,D as ee,F as q,y as H,H as ge,E as we}from"./index-054e2682.js";const Le={class:"environment-table"},ke={key:0,class:"variables-view"},Ce={class:"env-info"},Oe={class:"variables-table"},Ae={__name:"EnvironmentTable",props:{data:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},scope:{type:String,default:"GLOBAL"}},emits:["edit","delete","activate","duplicate"],setup(U){const w=b(!1),y=b(null),z=c=>fe(c).format("YYYY-MM-DD HH:mm"),j=c=>!c||typeof c!="object"?[]:Object.keys(c).map(o=>{const d=c[o];return typeof d=="object"?{key:o,initialValue:d.initialValue||"",currentValue:d.currentValue||d.initialValue||""}:{key:o,initialValue:d||"",currentValue:d||""}}),C=c=>{y.value=c,w.value=!0};return(c,o)=>{const d=r("el-table-column"),f=r("el-tag"),L=r("el-button"),x=r("el-button-group"),B=r("el-table"),n=r("el-descriptions-item"),M=r("el-descriptions"),F=r("el-dialog"),N=ve("loading");return _(),A("div",Le,[_e((_(),k(B,{data:U.data,style:{width:"100%"}},{default:t(()=>[e(d,{prop:"name",label:"环境名称","min-width":"200"}),e(d,{prop:"scope",label:"作用域",width:"120"},{default:t(i=>[e(f,{type:i.row.scope==="GLOBAL"?"primary":"success"},{default:t(()=>[u(E(i.row.scope==="GLOBAL"?"全局":"局部"),1)]),_:2},1032,["type"])]),_:1}),U.scope==="LOCAL"?(_(),k(d,{key:0,prop:"project_name",label:"关联项目",width:"150"})):G("",!0),e(d,{label:"变量数量",width:"100"},{default:t(i=>[u(E(Object.keys(i.row.variables||{}).length),1)]),_:1}),e(d,{prop:"is_active",label:"状态",width:"80"},{default:t(i=>[i.row.is_active?(_(),k(f,{key:0,type:"success",size:"small"},{default:t(()=>o[3]||(o[3]=[u("激活",-1)])),_:1,__:[3]})):(_(),k(f,{key:1,type:"info",size:"small"},{default:t(()=>o[4]||(o[4]=[u("未激活",-1)])),_:1,__:[4]}))]),_:1}),e(d,{prop:"created_by.username",label:"创建者",width:"120"}),e(d,{prop:"created_at",label:"创建时间",width:"160"},{default:t(i=>[u(E(z(i.row.created_at)),1)]),_:1}),e(d,{label:"操作",width:"250",fixed:"right"},{default:t(i=>[e(x,null,{default:t(()=>[i.row.is_active?G("",!0):(_(),k(L,{key:0,link:"",type:"success",onClick:V=>c.$emit("activate",i.row),size:"small"},{default:t(()=>o[5]||(o[5]=[u(" 激活 ",-1)])),_:2,__:[5]},1032,["onClick"])),e(L,{link:"",type:"primary",onClick:V=>C(i.row),size:"small"},{default:t(()=>o[6]||(o[6]=[u(" 查看变量 ",-1)])),_:2,__:[6]},1032,["onClick"]),e(L,{link:"",type:"primary",onClick:V=>c.$emit("edit",i.row),size:"small"},{default:t(()=>o[7]||(o[7]=[u(" 编辑 ",-1)])),_:2,__:[7]},1032,["onClick"]),e(L,{link:"",type:"primary",onClick:V=>c.$emit("duplicate",i.row),size:"small"},{default:t(()=>o[8]||(o[8]=[u(" 复制 ",-1)])),_:2,__:[8]},1032,["onClick"]),e(L,{link:"",type:"danger",onClick:V=>c.$emit("delete",i.row),size:"small"},{default:t(()=>o[9]||(o[9]=[u(" 删除 ",-1)])),_:2,__:[9]},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[N,U.loading]]),e(F,{modelValue:w.value,"onUpdate:modelValue":o[2]||(o[2]=i=>w.value=i),title:"环境变量",width:"600px"},{footer:t(()=>[e(L,{onClick:o[0]||(o[0]=i=>w.value=!1)},{default:t(()=>o[13]||(o[13]=[u("关闭",-1)])),_:1,__:[13]}),e(L,{type:"primary",onClick:o[1]||(o[1]=i=>c.$emit("edit",y.value))},{default:t(()=>o[14]||(o[14]=[u(" 编辑环境 ",-1)])),_:1,__:[14]})]),default:t(()=>[y.value?(_(),A("div",ke,[v("div",Ce,[e(M,{column:2,border:""},{default:t(()=>[e(n,{label:"环境名称"},{default:t(()=>[u(E(y.value.name),1)]),_:1}),e(n,{label:"作用域"},{default:t(()=>[e(f,{type:y.value.scope==="GLOBAL"?"primary":"success"},{default:t(()=>[u(E(y.value.scope==="GLOBAL"?"全局":"局部"),1)]),_:1},8,["type"])]),_:1}),y.value.project_name?(_(),k(n,{key:0,label:"关联项目"},{default:t(()=>[u(E(y.value.project_name),1)]),_:1})):G("",!0),e(n,{label:"状态"},{default:t(()=>[y.value.is_active?(_(),k(f,{key:0,type:"success"},{default:t(()=>o[10]||(o[10]=[u("激活",-1)])),_:1,__:[10]})):(_(),k(f,{key:1,type:"info"},{default:t(()=>o[11]||(o[11]=[u("未激活",-1)])),_:1,__:[11]}))]),_:1})]),_:1})]),v("div",Oe,[o[12]||(o[12]=v("h4",null,"环境变量列表",-1)),e(B,{data:j(y.value.variables),style:{width:"100%"}},{default:t(()=>[e(d,{prop:"key",label:"变量名",width:"150"}),e(d,{prop:"initialValue",label:"初始值"}),e(d,{prop:"currentValue",label:"当前值"})]),_:1},8,["data"])])])):G("",!0)]),_:1},8,["modelValue"])])}}},le=te(Ae,[["__scopeId","data-v-5d4e074b"]]);const je={class:"environment-management"},Be={class:"header"},Ee={class:"local-env-header"},$e={class:"scope-help"},Ge={class:"variables-editor"},xe={class:"variables-body"},De={class:"column"},Ue={class:"column"},ze={class:"column"},he={class:"column"},Te={class:"variables-footer"},Me={key:0,class:"view-variables"},Fe={__name:"EnvironmentManagement",setup(U){const w=b("GLOBAL"),y=b([]),z=b([]),j=b([]),C=b(null),c=b(!1),o=b(!1),d=b(!1),f=b(null),L=b(null),x=b(!1),B=b(),n=be({name:"",scope:"GLOBAL",project:null,variables:[{key:"",initialValue:"",currentValue:""}]}),M={name:[{required:!0,message:"请输入环境名称",trigger:"blur"}],scope:[{required:!0,message:"请选择作用域",trigger:"change"}],project:[{validator:(a,l,m)=>{n.scope==="LOCAL"&&!l?m(new Error("请选择关联项目")):m()},trigger:"change"}]},F=ye(()=>{var l;if(!((l=L.value)!=null&&l.variables))return[];const a=L.value.variables;return Object.keys(a).map(m=>{var p,D;return{key:m,initialValue:((p=a[m])==null?void 0:p.initialValue)||a[m]||"",currentValue:((D=a[m])==null?void 0:D.currentValue)||a[m]||""}})}),N=async()=>{try{const a=await O.get("/api-testing/projects/");j.value=a.data.results||a.data,j.value.length>0&&!C.value&&(C.value=j.value[0].id)}catch{g.error("加载项目列表失败")}},i=async()=>{c.value=!0;try{const a=await O.get("/api-testing/environments/",{params:{scope:"GLOBAL"}});y.value=a.data.results||a.data}catch{g.error("加载全局环境失败")}finally{c.value=!1}},V=async()=>{if(C.value){c.value=!0;try{const a=await O.get("/api-testing/environments/",{params:{scope:"LOCAL",project:C.value}});z.value=a.data.results||a.data}catch{g.error("加载局部环境失败")}finally{c.value=!1}}},ae=a=>{a==="GLOBAL"?i():V()},oe=()=>{n.scope==="GLOBAL"&&(n.project=null)},ne=()=>{n.variables.push({key:"",initialValue:"",currentValue:""})},se=a=>{n.variables.length>1&&n.variables.splice(a,1)},R=a=>{f.value=a,n.name=a.name,n.scope=a.scope,n.project=a.project;const l=a.variables||{};n.variables=Object.keys(l).map(m=>{const p=l[m];return typeof p=="object"?{key:m,initialValue:p.initialValue||"",currentValue:p.currentValue||""}:{key:m,initialValue:p||"",currentValue:p||""}}),n.variables.length===0&&n.variables.push({key:"",initialValue:"",currentValue:""}),o.value=!0},I=async a=>{try{await we.confirm(`确定要删除环境 "${a.name}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await O.delete(`/api-testing/environments/${a.id}/`),g.success("删除成功"),w.value==="GLOBAL"?await i():await V()}catch(l){l!=="cancel"&&g.error("删除失败")}},P=async a=>{try{await O.post(`/api-testing/environments/${a.id}/activate/`),g.success("环境已激活"),w.value==="GLOBAL"?await i():await V()}catch{g.error("激活失败")}},J=async a=>{const l={name:`${a.name} - 副本`,scope:a.scope,project:a.scope==="LOCAL"?typeof a.project=="object"?a.project.id:a.project:null,variables:a.variables||{}};try{await O.post("/api-testing/environments/",l),g.success("复制成功"),w.value==="GLOBAL"?await i():await V()}catch{g.error("复制失败")}},ie=async()=>{if(!(!B.value||!await B.value.validate().catch(()=>!1))){x.value=!0;try{const l={};n.variables.forEach(p=>{p.key&&(l[p.key]={initialValue:p.initialValue||"",currentValue:p.currentValue||p.initialValue||""})});const m={name:n.name,scope:n.scope,project:n.scope==="LOCAL"?n.project:null,variables:l};f.value?(await O.put(`/api-testing/environments/${f.value.id}/`,m),g.success("环境更新成功")):(await O.post("/api-testing/environments/",m),g.success("环境创建成功")),o.value=!1,w.value==="GLOBAL"?await i():await V()}catch{g.error(f.value?"更新环境失败":"创建环境失败")}finally{x.value=!1}}},ue=()=>{var a;f.value=null,Object.assign(n,{name:"",scope:"GLOBAL",project:null,variables:[{key:"",initialValue:"",currentValue:""}]}),(a=B.value)==null||a.resetFields()};return Ve(async()=>{await N(),await i(),C.value&&await V()}),(a,l)=>{const m=r("el-icon"),p=r("el-button"),D=r("el-tab-pane"),K=r("el-option"),Q=r("el-select"),re=r("el-tabs"),h=r("el-input"),T=r("el-form-item"),W=r("el-radio"),de=r("el-radio-group"),ce=r("el-text"),pe=r("el-form"),X=r("el-dialog"),S=r("el-table-column"),me=r("el-table");return _(),A("div",je,[v("div",Be,[l[11]||(l[11]=v("h3",null,"环境管理",-1)),e(p,{type:"primary",onClick:l[0]||(l[0]=s=>o.value=!0)},{default:t(()=>[e(m,null,{default:t(()=>[e(Y(ee))]),_:1}),l[10]||(l[10]=u(" 新建环境 ",-1))]),_:1,__:[10]})]),e(re,{modelValue:w.value,"onUpdate:modelValue":l[2]||(l[2]=s=>w.value=s),onTabChange:ae},{default:t(()=>[e(D,{label:"全局环境变量",name:"GLOBAL"},{default:t(()=>[e(le,{data:y.value,loading:c.value,scope:"GLOBAL",onEdit:R,onDelete:I,onActivate:P,onDuplicate:J},null,8,["data","loading"])]),_:1}),e(D,{label:"局部环境变量",name:"LOCAL"},{default:t(()=>[v("div",Ee,[e(Q,{modelValue:C.value,"onUpdate:modelValue":l[1]||(l[1]=s=>C.value=s),placeholder:"选择项目",onChange:V,style:{width:"200px"}},{default:t(()=>[(_(!0),A(q,null,H(j.value,s=>(_(),k(K,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),e(le,{data:z.value,loading:c.value,scope:"LOCAL",onEdit:R,onDelete:I,onActivate:P,onDuplicate:J},null,8,["data","loading"])]),_:1})]),_:1},8,["modelValue"]),e(X,{modelValue:o.value,"onUpdate:modelValue":l[7]||(l[7]=s=>o.value=s),title:f.value?"编辑环境":"新建环境",width:"800px",onClose:ue},{footer:t(()=>[e(p,{onClick:l[6]||(l[6]=s=>o.value=!1)},{default:t(()=>l[17]||(l[17]=[u("取消",-1)])),_:1,__:[17]}),e(p,{type:"primary",onClick:ie,loading:x.value},{default:t(()=>[u(E(f.value?"更新":"创建"),1)]),_:1},8,["loading"])]),default:t(()=>[e(pe,{ref_key:"formRef",ref:B,model:n,rules:M,"label-width":"120px"},{default:t(()=>[e(T,{label:"环境名称",prop:"name"},{default:t(()=>[e(h,{modelValue:n.name,"onUpdate:modelValue":l[3]||(l[3]=s=>n.name=s),placeholder:"请输入环境名称"},null,8,["modelValue"])]),_:1}),e(T,{label:"作用域",prop:"scope"},{default:t(()=>[e(de,{modelValue:n.scope,"onUpdate:modelValue":l[4]||(l[4]=s=>n.scope=s),onChange:oe},{default:t(()=>[e(W,{value:"GLOBAL"},{default:t(()=>l[12]||(l[12]=[u("全局环境变量",-1)])),_:1,__:[12]}),e(W,{value:"LOCAL"},{default:t(()=>l[13]||(l[13]=[u("局部环境变量",-1)])),_:1,__:[13]})]),_:1},8,["modelValue"]),v("div",$e,[e(ce,{size:"small",type:"info"},{default:t(()=>l[14]||(l[14]=[u(" 全局环境变量对所有项目生效，局部环境变量仅对关联项目生效 ",-1)])),_:1,__:[14]})])]),_:1}),n.scope==="LOCAL"?(_(),k(T,{key:0,label:"关联项目",prop:"project"},{default:t(()=>[e(Q,{modelValue:n.project,"onUpdate:modelValue":l[5]||(l[5]=s=>n.project=s),placeholder:"请选择关联项目"},{default:t(()=>[(_(!0),A(q,null,H(j.value,s=>(_(),k(K,{key:s.id,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):G("",!0),e(T,{label:"环境变量",prop:"variables"},{default:t(()=>[v("div",Ge,[l[16]||(l[16]=v("div",{class:"variables-header"},[v("div",{class:"column"},"变量名"),v("div",{class:"column"},"初始值"),v("div",{class:"column"},"当前值"),v("div",{class:"column"},"操作")],-1)),v("div",xe,[(_(!0),A(q,null,H(n.variables,(s,Z)=>(_(),A("div",{key:Z,class:"variable-row"},[v("div",De,[e(h,{modelValue:s.key,"onUpdate:modelValue":$=>s.key=$,placeholder:"变量名",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),v("div",Ue,[e(h,{modelValue:s.initialValue,"onUpdate:modelValue":$=>s.initialValue=$,placeholder:"初始值",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),v("div",ze,[e(h,{modelValue:s.currentValue,"onUpdate:modelValue":$=>s.currentValue=$,placeholder:"当前值",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),v("div",he,[e(p,{size:"small",type:"danger",icon:Y(ge),onClick:$=>se(Z),disabled:n.variables.length<=1},null,8,["icon","onClick","disabled"])])]))),128))]),v("div",Te,[e(p,{size:"small",onClick:ne},{default:t(()=>[e(m,null,{default:t(()=>[e(Y(ee))]),_:1}),l[15]||(l[15]=u(" 添加变量 ",-1))]),_:1,__:[15]})])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(X,{modelValue:d.value,"onUpdate:modelValue":l[9]||(l[9]=s=>d.value=s),title:"环境变量详情",width:"600px"},{footer:t(()=>[e(p,{onClick:l[8]||(l[8]=s=>d.value=!1)},{default:t(()=>l[18]||(l[18]=[u("关闭",-1)])),_:1,__:[18]})]),default:t(()=>[L.value?(_(),A("div",Me,[e(me,{data:F.value,style:{width:"100%"}},{default:t(()=>[e(S,{prop:"key",label:"变量名",width:"150"}),e(S,{prop:"initialValue",label:"初始值"}),e(S,{prop:"currentValue",label:"当前值"})]),_:1},8,["data"])])):G("",!0)]),_:1},8,["modelValue"])])}}},Se=te(Fe,[["__scopeId","data-v-62fd355a"]]);export{Se as default};
