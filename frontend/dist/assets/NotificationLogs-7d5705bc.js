import{_ as H,U as I,q as z,V as K,v as Q,x as X,r as s,S as Z,o as g,c as S,b as c,d as n,w as o,N as $,J as D,$ as J,e as W,z as ee,f,t as i,F as q,y as G,B as V}from"./index-054e2682.js";const te={name:"NotificationLogs",components:{Search:I},setup(){const T=z(!1),l=z([]),R=z(!1),t=z(null),d=K({taskName:"",dateRange:[],status:""}),u=K({currentPage:1,pageSize:10,total:0}),y=K({prop:"created_at",order:"descending"}),h=async()=>{T.value=!0;try{const a={page:u.currentPage,page_size:u.pageSize,ordering:y.order==="ascending"?y.prop:`-${y.prop}`};d.taskName&&(a.search=d.taskName),d.dateRange&&d.dateRange.length===2&&(a.start_date=d.dateRange[0],a.end_date=d.dateRange[1]),d.status&&(a.status=d.status);const e=await J.get("/api/api-testing/notification-logs/",{params:a});l.value=e.data.results||[],u.total=e.data.count||0}catch(a){console.error("获取通知日志失败:",a),W.error("获取通知日志失败")}finally{T.value=!1}},F=()=>{u.currentPage=1,h()},r=()=>{d.taskName="",d.dateRange=[],d.status="",u.currentPage=1,h()},M=a=>{u.pageSize=a,u.currentPage=1,h()},w=a=>{u.currentPage=a,h()},P=({prop:a,order:e})=>{y.prop=a,y.order=e||"descending",h()},L=async a=>{try{const e=await J.get(`/api/api-testing/notification-logs/${a.id}/detail/`);t.value=e.data,R.value=!0}catch(e){console.error("获取通知详情失败:",e),W.error("获取通知详情失败")}},N=a=>{t.value=null,a()},b=a=>a?new Date(a).toLocaleString("zh-CN"):"-",C=a=>({发送成功:"success",success:"success",发送失败:"danger",failed:"danger",待发送:"info",pending:"info",发送中:"warning",sending:"warning",已取消:"info",cancelled:"info"})[a]||"info",U=a=>({邮箱通知:"",Webhook机器人:"primary",两种都发送:"warning"})[a]||"info",A=a=>({wechat:"success",feishu:"primary",dingtalk:"warning",email:"info"})[a]||"info",p=a=>a?typeof a=="string"?a.length>20?a.substring(0,20)+"...":a:Array.isArray(a)?a.length===0?"-":a.length===1?a[0]:`${a[0]} 等${a.length}人`:"-":"-",E=a=>a?Array.isArray(a)?a.map(e=>e.email?`${e.name} <${e.email}>`:e.name):[a]:[],B=a=>a?Array.isArray(a)?a.map(e=>e.name||e.type):[a.name||a.type]:[],Y=Q(()=>{if(!t.value||!t.value.notification_content)return null;const a=t.value.notification_content;try{const e=JSON.parse(a),v=[];let _="";if(e.msgtype==="markdown"&&e.markdown?e.markdown.text?_=e.markdown.text:e.markdown.content&&(_=e.markdown.content):e.msg_type==="interactive"&&e.card&&e.card.elements&&e.card.elements[0]&&e.card.elements[0].text&&(_=e.card.elements[0].text.content),_)return _.split(`
`).filter(m=>m.trim()).forEach(m=>{if(m.includes("**")||m.trim()==="")return;const k=m.indexOf(":");if(k>0){const O=m.substring(0,k).trim(),j=m.substring(k+1).trim();O&&j&&v.push({label:O,value:j})}}),v.length>0?v:null}catch{console.log("尝试解析为纯文本格式")}try{const e=[];return a.split(`
`).filter(_=>_.trim()).forEach(_=>{if(!_.trim())return;const x=_.indexOf(":");if(x>0){const m=_.substring(0,x).trim(),k=_.substring(x+1).trim();m&&k&&!k.includes("'results':")&&!k.includes('"results":')&&e.push({label:m,value:k})}}),e.length>0?e:null}catch(e){return console.error("解析通知内容失败:",e),null}});return X(()=>{h()}),{loading:T,logsData:l,detailDialogVisible:R,selectedLog:t,searchForm:d,pagination:u,sortParams:y,parsedNotificationContent:Y,handleSearch:F,handleReset:r,handleSizeChange:M,handleCurrentChange:w,handleSortChange:P,viewDetail:L,handleDetailDialogClose:N,formatDate:b,getStatusTagType:C,getNotificationTypeTagType:U,getTargetTagType:A,formatRecipients:p,formatRecipientInfo:E,formatWebhookInfo:B}}},ae={class:"notification-logs-container"},ne={class:"page-actions"},oe={class:"logs-table-container"},le={class:"pagination-container"},se={class:"notification-targets"},ie={key:0},re={class:"notification-content"},ce={key:0,class:"notification-content-parsed"},de={class:"content-label"},_e={class:"content-value"},ge={key:1,class:"notification-content-raw"},pe={class:"error-message"},fe={class:"dialog-footer"};function ue(T,l,R,t,d,u){const y=s("Search"),h=s("el-icon"),F=s("el-input"),r=s("el-col"),M=s("el-date-picker"),w=s("el-option"),P=s("el-select"),L=s("el-button"),N=s("el-row"),b=s("el-table-column"),C=s("el-tag"),U=s("el-table"),A=s("el-pagination"),p=s("el-form-item"),E=s("el-alert"),B=s("el-form"),Y=s("el-dialog"),a=Z("loading");return g(),S("div",ae,[c("div",ne,[n(N,{gutter:20,class:"filter-row"},{default:o(()=>[n(r,{span:6},{default:o(()=>[n(F,{modelValue:t.searchForm.taskName,"onUpdate:modelValue":l[0]||(l[0]=e=>t.searchForm.taskName=e),placeholder:"搜索任务名称",clearable:"",onClear:t.handleSearch,onKeyup:ee(t.handleSearch,["enter"])},{prefix:o(()=>[n(h,null,{default:o(()=>[n(y)]),_:1})]),_:1},8,["modelValue","onClear","onKeyup"])]),_:1}),n(r,{span:6},{default:o(()=>[n(M,{modelValue:t.searchForm.dateRange,"onUpdate:modelValue":l[1]||(l[1]=e=>t.searchForm.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",onChange:t.handleSearch},null,8,["modelValue","onChange"])]),_:1}),n(r,{span:6},{default:o(()=>[n(P,{modelValue:t.searchForm.status,"onUpdate:modelValue":l[2]||(l[2]=e=>t.searchForm.status=e),placeholder:"通知状态",clearable:"",onChange:t.handleSearch},{default:o(()=>[n(w,{label:"全部状态",value:""}),n(w,{label:"成功",value:"SUCCESS"}),n(w,{label:"失败",value:"FAILED"}),n(w,{label:"重试中",value:"RETRYING"})]),_:1},8,["modelValue","onChange"])]),_:1}),n(r,{span:6},{default:o(()=>[n(L,{type:"primary",onClick:t.handleSearch},{default:o(()=>[n(h,null,{default:o(()=>[n(y)]),_:1}),l[7]||(l[7]=f(" 搜索 ",-1))]),_:1,__:[7]},8,["onClick"]),n(L,{onClick:t.handleReset},{default:o(()=>l[8]||(l[8]=[f(" 重置 ",-1)])),_:1,__:[8]},8,["onClick"])]),_:1})]),_:1})]),c("div",oe,[$((g(),D(U,{data:t.logsData,"element-loading-text":"加载中...",stripe:"",style:{width:"100%"},onSortChange:t.handleSortChange},{default:o(()=>[n(b,{prop:"task_name",label:"任务名称","min-width":"150",sortable:"custom"}),n(b,{prop:"task_type_display",label:"任务类型","min-width":"100"},{default:o(({row:e})=>[n(C,{type:"info",size:"small"},{default:o(()=>[f(i(e.task_type_display),1)]),_:2},1024)]),_:1}),n(b,{prop:"notification_type_display",label:"通知类型","min-width":"120"},{default:o(({row:e})=>[n(C,{type:t.getNotificationTypeTagType(e.notification_type_display),size:"small"},{default:o(()=>[f(i(e.notification_type_display),1)]),_:2},1032,["type"])]),_:1}),n(b,{prop:"notification_target_display",label:"通知对象","min-width":"150"},{default:o(({row:e})=>[c("span",null,i(e.notification_target_display||"-"),1)]),_:1}),n(b,{prop:"created_at",label:"通知时间","min-width":"180",sortable:"custom"},{default:o(({row:e})=>[f(i(t.formatDate(e.created_at)),1)]),_:1}),n(b,{prop:"status_display",label:"状态","min-width":"100",sortable:"custom"},{default:o(({row:e})=>[n(C,{type:t.getStatusTagType(e.status_display),size:"small"},{default:o(()=>[f(i(e.status_display),1)]),_:2},1032,["type"])]),_:1}),n(b,{label:"操作",fixed:"right",width:"120"},{default:o(({row:e})=>[n(L,{type:"primary",link:"",size:"small",onClick:v=>t.viewDetail(e)},{default:o(()=>l[9]||(l[9]=[f(" 查看详情 ",-1)])),_:2,__:[9]},1032,["onClick"])]),_:1})]),_:1},8,["data","onSortChange"])),[[a,t.loading]]),c("div",le,[n(A,{"current-page":t.pagination.currentPage,"onUpdate:currentPage":l[3]||(l[3]=e=>t.pagination.currentPage=e),"page-size":t.pagination.pageSize,"onUpdate:pageSize":l[4]||(l[4]=e=>t.pagination.pageSize=e),"page-sizes":[10,20,50,100],total:t.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:t.handleSizeChange,onCurrentChange:t.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),n(Y,{modelValue:t.detailDialogVisible,"onUpdate:modelValue":l[6]||(l[6]=e=>t.detailDialogVisible=e),title:"通知详情",width:"600px","before-close":t.handleDetailDialogClose},{footer:o(()=>[c("span",fe,[n(L,{onClick:l[5]||(l[5]=e=>t.detailDialogVisible=!1)},{default:o(()=>l[10]||(l[10]=[f("关闭",-1)])),_:1,__:[10]})])]),default:o(()=>[t.selectedLog?(g(),D(B,{key:0,"label-position":"top",class:"notification-detail-form"},{default:o(()=>[n(N,{gutter:20},{default:o(()=>[n(r,{span:12},{default:o(()=>[n(p,{label:"任务名称"},{default:o(()=>[c("span",null,i(t.selectedLog.task_name),1)]),_:1})]),_:1}),n(r,{span:12},{default:o(()=>[n(p,{label:"任务类型"},{default:o(()=>[c("span",null,i(t.selectedLog.task_type_display),1)]),_:1})]),_:1}),n(r,{span:12},{default:o(()=>[n(p,{label:"通知类型"},{default:o(()=>[n(C,{type:t.getNotificationTypeTagType(t.selectedLog.notification_type_display)},{default:o(()=>[f(i(t.selectedLog.notification_type_display),1)]),_:1},8,["type"])]),_:1})]),_:1}),n(r,{span:12},{default:o(()=>[n(p,{label:"状态"},{default:o(()=>[n(C,{type:t.getStatusTagType(t.selectedLog.status_display)},{default:o(()=>[f(i(t.selectedLog.status_display),1)]),_:1},8,["type"])]),_:1})]),_:1}),n(r,{span:12},{default:o(()=>[n(p,{label:"通知时间"},{default:o(()=>[c("span",null,i(t.formatDate(t.selectedLog.created_at)),1)]),_:1})]),_:1}),n(r,{span:12},{default:o(()=>[n(p,{label:"发送时间"},{default:o(()=>[c("span",null,i(t.selectedLog.sent_at?t.formatDate(t.selectedLog.sent_at):"-"),1)]),_:1})]),_:1}),t.selectedLog.notification_target_display&&t.selectedLog.notification_target_display.length>0?(g(),D(r,{key:0,span:24},{default:o(()=>[n(p,{label:"通知对象"},{default:o(()=>[c("div",se,[(g(!0),S(q,null,G(t.selectedLog.notification_target_display,(e,v)=>(g(),D(C,{key:v,class:"target-tag",size:"small",type:t.getTargetTagType(e.type)},{default:o(()=>[f(i(e.display)+"（"+i(e.name)+"） ",1)]),_:2},1032,["type"]))),128)),!t.selectedLog.notification_target_display||t.selectedLog.notification_target_display.length===0?(g(),S("span",ie,"-")):V("",!0)])]),_:1})]),_:1})):V("",!0),n(r,{span:24},{default:o(()=>[n(p,{label:"通知内容"},{default:o(()=>[c("div",re,[t.parsedNotificationContent?(g(),S("div",ce,[(g(!0),S(q,null,G(t.parsedNotificationContent,(e,v)=>(g(),S("div",{class:"content-item",key:v},[c("span",de,i(e.label)+":",1),c("span",_e,i(e.value),1)]))),128))])):(g(),S("div",ge,[c("pre",null,i(t.selectedLog.notification_content||"-"),1)]))])]),_:1})]),_:1}),t.selectedLog.error_message?(g(),D(r,{key:1,span:24},{default:o(()=>[n(p,{label:"错误信息"},{default:o(()=>[c("div",pe,[n(E,{title:t.selectedLog.error_message,type:"error","show-icon":"",closable:!1},null,8,["title"])])]),_:1})]),_:1})):V("",!0)]),_:1})]),_:1})):V("",!0)]),_:1},8,["modelValue","before-close"])])}const ye=H(te,[["render",ue],["__scopeId","data-v-2940d892"]]);export{ye as default};
