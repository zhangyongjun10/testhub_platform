# TestHub 架构图文档

## 1. 系统整体架构

### 1.1 分层架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端展示层 (Presentation)                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Vue 3 + Vite + Element Plus                       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 测试用例  │ │ API测试  │ │ UI自动化 │ │ 需求分析  │ │ 数据中心  │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 报告中心  │ │ 定时任务  │ │ 项目管理  │ │ 智能助手  │ │ 系统设置  │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                         │ HTTPS/WSS
                                         ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API网关层 (API Gateway)                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     Nginx + Django REST Framework                    │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │   │
│  │  │  REST API      │  │  WebSocket     │  │  Static Files  │        │   │
│  │  │  /api/*        │  │  /ws/*         │  │  /static/*     │        │   │
│  │  └────────────────┘  └────────────────┘  └────────────────┘        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                         │
           ┌─────────────────────────────┼─────────────────────────────┐
           │                             │                             │
           ▼                             ▼                             ▼
┌──────────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐
│   业务服务层          │    │   AI服务层            │    │   自动化执行层         │
│  (Business Services)  │    │  (AI Services)       │    │  (Automation)        │
│  ┌────────────────┐  │    │  ┌────────────────┐  │    │  ┌────────────────┐  │
│  │ users          │  │    │  │ requirement   │  │    │  │ selenium       │  │
│  │ projects       │  │    │  │ analysis      │  │    │  │ playwright     │  │
│  │ testcases      │  │    │  │ assistant     │  │    │  │ browser-use    │  │
│  │ executions     │  │    │  │ (Dify AI)     │  │    │  │ airtest        │  │
│  │ reports        │  │    │  └────────────────┘  │    │  └────────────────┘  │
│  │ reviews        │  │    │  ┌────────────────┐  │    │  ┌────────────────┐  │
│  │ versions       │  │    │  │ LLM APIs      │  │    │  │ API Testing    │  │
│  └────────────────┘  │    │  │ (OpenAI/      │  │    │  │ Execution      │  │
│  ┌────────────────┐  │    │  │  DeepSeek/    │  │    │  └────────────────┘  │
│  │ api_testing    │  │    │  │  Qwen)        │  │    │                       │
│  │ ui_automation  │  │    │  └────────────────┘  │    │                       │
│  └────────────────┘  │    └──────────────────────┘    └──────────────────────┘
│  ┌────────────────┐  │
│  │ core           │  │
│  │ data_factory   │  │
│  └────────────────┘  │
└──────────────────────┘
                                         │
           ┌─────────────────────────────┼─────────────────────────────┐
           │                             │                             │
           ▼                             ▼                             ▼
┌──────────────────────┐    ┌──────────────────────┐    ┌──────────────────────┐
│   缓存层              │    │   消息队列层          │    │   数据持久层           │
│  (Cache Layer)        │    │  (Message Queue)     │    │  (Persistence)        │
│  ┌────────────────┐  │    │  ┌────────────────┐  │    │  ┌────────────────┐  │
│  │ Redis          │  │    │  │ Celery         │  │    │  │ MySQL Master   │  │
│  │ - Session      │  │    │  │ - Task Queue   │  │    │  │ - Primary      │  │
│  │ - Token        │  │    │  │ - Scheduler    │  │    │  └────────────────┘  │
│  │ - Cache        │  │    │  └────────────────┘  │    │  ┌────────────────┐  │
│  └────────────────┘  │    │  ┌────────────────┐  │    │  │ MySQL Slave    │  │
│                      │    │  │ Channels       │  │    │  │ - Replica     │  │
│                      │    │  │ - WebSocket    │  │    │  └────────────────┘  │
│                      │    │  │ - Realtime     │  │    │  ┌────────────────┐  │
│                      │    │  └────────────────┘  │    │  │ File Storage   │  │
│                      │    └──────────────────────┘    │  │ - Uploads      │  │
│                      │                                 │  │ - Reports      │  │
│                      │                                 │  └────────────────┘  │
└──────────────────────┘                                 └──────────────────────┘
```

---

## 2. 核心模块架构

### 2.1 测试用例管理模块

```
┌─────────────────────────────────────────────────────────────────────┐
│                        测试用例管理模块                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                        前端组件                               │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│  │  │ 用例列表  │ → │ 用例详情  │ → │ 用例编辑  │ → │ 步骤管理  │       │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│  │  │ 导入导出  │   │ 批量操作  │   │ 历史版本  │   │ 附件管理  │       │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │ API                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       后端服务层                              │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │   │
│  │  │ TestCaseView │  │ StepView     │  │ AttachmentView│      │   │
│  │  │ - CRUD       │  │ - CRUD       │  │ - Upload      │      │   │
│  │  │ - Search     │  │ - Reorder    │  │ - Download    │      │   │
│  │  │ - Batch      │  │ - Copy       │  │ - Delete      │      │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       数据模型层                              │   │
│  │  ┌─────────────────┐         ┌─────────────────┐            │   │
│  │  │   TestCase      │ 1    * │ TestCaseStep     │            │   │
│  │  │ - title         │────────│ - step_number    │            │   │
│  │  │ - priority      │         │ - action         │            │   │
│  │  │ - status        │         │ - expected       │            │   │
│  │  │ - test_type     │         └─────────────────┘            │   │
│  │  └─────────────────┘                                       │   │
│  │         │ 1                                                  │   │
│  │         │                                                    │   │
│  │         │ *          ┌─────────────────┐                    │   │
│  │         └──────────→ │  Project        │                    │   │
│  │                     │ - name           │                    │   │
│  │                     └─────────────────┘                    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 API测试模块

```
┌─────────────────────────────────────────────────────────────────────┐
│                         API测试模块                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                        数据模型关系                             │ │
│  │                                                               │ │
│  │         ┌──────────────┐                                       │ │
│  │         │ ApiProject   │                                       │ │
│  │         │ - name       │                                       │ │
│  │         │ - base_url   │                                       │ │
│  │         └──────┬───────┘                                       │ │
│  │                │                                              │ │
│  │         ┌──────┴───────┐                                       │ │
│  │         │ 1          * │                                       │ │
│  │         ▼             ▼                                        │ │
│  │   ┌──────────┐  ┌──────────┐  ┌──────────┐                    │ │
│  │   │ApiColl   │  │Envir     │  │TestSuite │                    │ │
│  │   │- name    │  │- name    │  │- name    │                    │ │
│  │   └────┬─────┘  └──────────┘  └────┬─────┘                    │ │
│  │        │                             │                         │ │
│  │        │ 1                           │ *                       │ │
│  │        │                             │                         │ │
│  │        │ *          ┌─────────┐      │                         │ │
│  │        └──────────→ │ApiRequest│←─────┘                         │ │
│  │                    │- method │                                 │ │
│  │                    │- url    │                                 │ │
│  │                    │- body   │                                 │ │
│  │                    └─────────┘                                 │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      执行流程                                 │   │
│  │                                                               │   │
│  │  请求构建 → 环境变量替换 → 前置脚本 → HTTP请求 → 后置脚本    │   │
│  │     ↓           ↓              ↓          ↓          ↓        │   │
│  │  模板数据    变量解析       JavaScript   httpx    JavaScript  │   │
│  │     ↓                                                    ↓     │   │
│  │  ┌─────────────────────────────────────────────────────────┐  │   │
│  │  │                     断言验证                            │  │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │  │   │
│  │  │  │状态码   │ │响应头   │ │JSON Path│ │响应时间  │      │  │   │
│  │  │  │断言     │ │断言     │ │断言     │ │断言     │      │  │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │  │   │
│  │  └─────────────────────────────────────────────────────────┘  │   │
│  │                              ↓                                 │   │
│  │                    ┌────────────────────┐                     │   │
│  │                    │   Allure Report    │                     │   │
│  │                    └────────────────────┘                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 UI自动化模块

```
┌─────────────────────────────────────────────────────────────────────┐
│                        UI自动化模块                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      元素管理体系                             │   │
│  │                                                               │   │
│  │  ┌──────────────┐      ┌─────────────────────────────┐       │   │
│  │  │  UiProject   │ 1   *│  Element                   │       │   │
│  │  │ - name       │─────│ - name                     │       │   │
│  │  │ - type       │      │ - element_type (INPUT/     │       │   │
│  │  └──────────────┘      │   BUTTON/DROPDOWN/etc)     │       │   │
│  │                        │ - page_name                │       │   │
│  │                        │ - locator_strategies       │       │   │
│  │                        │   (JSONField)              │       │   │
│  │                        │   [{                      │       │   │
│  │                        │     "type": "id",         │       │   │
│  │                        │     "value": "username",  │       │   │
│  │                        │     "priority": 1         │       │   │
│  │                        │   }]                      │       │   │
│  │                        └───────────┬─────────────┘       │   │
│  │                                    │                     │   │
│  │                                    │ *                   │   │
│  │                                    ▼                     │   │
│  │                        ┌─────────────────────┐           │   │
│  │                        │  ElementGroup       │           │   │
│  │                        │ - page_name         │           │   │
│  │                        └─────────────────────┘           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      测试脚本                                 │   │
│  │                                                               │   │
│  │  TestScript                                                   │   │
│  │  ├─ script_type: LINEAR / MODULAR / AI                       │   │
│  │  ├─ content: JSON / Python                                   │   │
│  │  └─ status: DRAFT / ACTIVE / ARCHIVED                        │   │
│  │                                                               │   │
│  │  执行模式:                                                     │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  │   │
│  │  │ Selenium模式   │  │ Playwright模式 │  │ AI智能模式     │  │   │
│  │  │ - WebDriver    │  │ - Browser API  │  │ - browser-use │  │   │
│  │  │ - 传统方案     │  │ - 现代方案     │  │ - LangChain   │  │   │
│  │  │ - 稳定         │  │ - 快速         │  │ - 自适应      │  │   │
│  │  └────────────────┘  └────────────────┘  └────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      定位策略优先级                           │   │
│  │                                                               │   │
│  │  Priority 1: ID                                               │   │
│  │  Priority 2: Name                                             │   │
│  │  Priority 3: Class Name                                       │   │
│  │  Priority 4: CSS Selector                                     │   │
│  │  Priority 5: XPath                                            │   │
│  │  Priority 6: Link Text                                        │   │
│  │  Priority 7: AI Vision (智能模式专用)                          │   │
│  │                                                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.4 AI需求分析模块

```
┌─────────────────────────────────────────────────────────────────────┐
│                      AI需求分析模块                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                        工作流程                               │   │
│  │                                                               │   │
│  │  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐         │   │
│  │  │文档上传│ → │文档解析│ → │AI分析 │ → │结构化 │ → │生成用例│  │   │
│  │  └────────┘   └────────┘   └────────┘   └────────┘         │   │
│  │     │            │            │            │            │    │   │
│  │     ▼            ▼            ▼            ▼            ▼    │   │
│  │  PDF/Word     分词/分段     LLM调用     业务需求     自动创建  │   │
│  │  TXT/MD      文本提取      prompt工程   JSON提取    TestCase │   │
│  │               OCR(可选)    智能分析     数据结构             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      AI服务集成                              │   │
│  │                                                               │   │
│  │  AIModelConfig                                                │   │
│  │  ├─ provider: deepseek / qwen / siliconflow / openai         │   │
│  │  ├─ api_key: ********                                        │   │
│  │  ├─ api_base: https://api.xxx.com                           │   │
│  │  ├─ model_name: deepseek-chat / qwen-max / gpt-4            │   │
│  │  ├─ role: testcase_writer / testcase_reviewer /             │   │
│  │  │         browser_use_text / browser_use_vision            │   │
│  │  └─ temperature: 0.7                                         │   │
│  │                                                               │   │
│  │  Prompt Templates:                                            │   │
│  │  ┌─────────────────────┐  ┌─────────────────────┐            │   │
│  │  │   tester.md         │  │   tester_pro.md     │            │   │
│  │  │   测试用例编写者     │  │   测试用例评审者     │            │   │
│  │  │   persona & format  │  │   review & improve  │            │   │
│  │  └─────────────────────┘  └─────────────────────┘            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      数据模型                                 │   │
│  │                                                               │   │
│  │  RequirementDocument 1─* RequirementAnalysis                  │   │
│  │  ├─ file_name          ├─ analysis_result (JSON)             │   │
│  │  ├─ file_type          ├─ structured_data (JSON)             │   │
│  │  ├─ file_size          └─ ai_model_used                      │   │
│  │  └─ upload_time                                               │   │
│  │         │                                                     │   │
│  │         │ 1                                                   │   │
│  │         ▼                                                     │   │
│  │  BusinessRequirement *─* TestCaseGeneration                  │   │
│  │  ├─ title             └─ generated_cases (JSON)              │   │
│  │  ├─ description                                                │   │
│  │  ├─ priority                                                   │   │
│  │  └─ acceptance_criteria                                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据流图

### 3.1 用户认证流程

```
┌──────────────┐
│    User      │
└──────┬───────┘
       │ 1. Login(username, password)
       ▼
┌──────────────────────────────┐
│   Frontend (Vue 3)           │
│  - user store.login()        │
│  - POST /api/auth/login/     │
└──────┬───────────────────────┘
       │ 2. POST request
       ▼
┌──────────────────────────────┐
│   Backend (Django)           │
│  - Validate credentials      │
│  - Generate JWT tokens       │
│  - Return: access + refresh  │
└──────┬───────────────────────┘
       │ 3. Response {access, refresh}
       ▼
┌──────────────────────────────┐
│   Frontend (Vue 3)           │
│  - Store tokens              │
│  - Set axios interceptor     │
│  - Redirect to dashboard     │
└──────┬───────────────────────┘
       │ 4. API requests with token
       ▼
┌──────────────────────────────┐
│   API Gateway                │
│  - Verify JWT signature      │
│  - Check token expiration    │
│  - Allow/Deny request        │
└──────────────────────────────┘
       │
       │ If expired
       ▼
┌──────────────────────────────┐
│   Auto Refresh Flow          │
│  - POST /api/auth/refresh/   │
│  - Get new access token      │
│  - Retry original request    │
└──────────────────────────────┘
```

### 3.2 API测试执行流程

```
┌──────────────┐
│    User      │
└──────┬───────┘
       │ 1. Click "Run Test"
       ▼
┌──────────────────────────────┐
│   Frontend                   │
│  - POST /api/api-testing/    │
│    run-test-suite/{id}/      │
└──────┬───────────────────────┘
       │ 2. Create execution task
       ▼
┌──────────────────────────────┐
│   Backend                    │
│  - Create Celery task        │
│  - Return task_id            │
└──────┬───────────────────────┘
       │ 3. Task queued
       ▼
┌──────────────────────────────┐
│   Celery Worker              │
│  ┌────────────────────────┐  │
│  │ For each request:      │  │
│  │  1. Load environment   │  │
│  │  2. Replace variables  │  │
│  │  3. Execute pre-script │  │
│  │  4. Send HTTP request  │  │
│  │  5. Execute post-script│  │
│  │  6. Run assertions     │  │
│  │  7. Save result        │  │
│  └────────────────────────┘  │
└──────┬───────────────────────┘
       │ 4. Save results to DB
       ▼
┌──────────────────────────────┐
│   Database                   │
│  - TestExecutionRecord       │
│  - RequestResult             │
│  - AssertionResult           │
└──────┬───────────────────────┘
       │ 5. Real-time update
       ▼
┌──────────────────────────────┐
│   Frontend (WebSocket)       │
│  - Receive progress updates  │
│  - Update UI in real-time    │
└──────────────────────────────┘
       │
       │ 6. Complete
       ▼
┌──────────────────────────────┐
│   Generate Allure Report     │
│  - Aggregate results         │
│  - Generate HTML report      │
│  - Notify user               │
└──────────────────────────────┘
```

### 3.3 AI需求分析流程

```
┌──────────────┐
│    User      │
└──────┬───────┘
       │ 1. Upload document
       ▼
┌──────────────────────────────┐
│   Frontend                   │
│  - File upload form          │
│  - POST /api/requirement-    │
│    analysis/upload/          │
└──────┬───────────────────────┘
       │ 2. Upload file
       ▼
┌──────────────────────────────┐
│   Backend                    │
│  - Save file to storage      │
│  - Create RequirementDoc     │
│  - Extract text (PDF/Word)   │
└──────┬───────────────────────┘
       │ 3. Extract text
       ▼
┌──────────────────────────────┐
│   Document Parser            │
│  - PDF: PyPDF2/pdfplumber    │
│  - Word: python-docx         │
│  - TXT: Direct read          │
│  - Output: Clean text        │
└──────┬───────────────────────┘
       │ 4. Trigger AI analysis
       ▼
┌──────────────────────────────┐
│   AI Service                 │
│  - Load prompt template      │
│  - Call LLM API              │
│  - (DeepSeek/Qwen/...)       │
└──────┬───────────────────────┘
       │ 5. LLM response
       ▼
┌──────────────────────────────┐
│   Process AI Response        │
│  - Parse structured output   │
│  - Extract:                  │
│    • Business requirements   │
│    • Test scenarios          │
│    • Test cases              │
└──────┬───────────────────────┘
       │ 6. Save analysis
       ▼
┌──────────────────────────────┐
│   Database                   │
│  - RequirementAnalysis       │
│  - BusinessRequirement       │
│  - TestCaseGeneration        │
└──────┬───────────────────────┘
       │ 7. User reviews
       ▼
┌──────────────┐
│    User      │
│  - Review    │
│  - Edit      │
│  - Approve   │
└──────┬───────┘
       │ 8. Create test cases
       ▼
┌──────────────────────────────┐
│   Create TestCases           │
│  - Generate TestCase objects │
│  - Link to project           │
│  - Notify user               │
└──────────────────────────────┘
```

---

## 4. 部署架构

### 4.1 生产环境部署

```
                                    ┌─────────────┐
                                    │   Internet  │
                                    └──────┬──────┘
                                           │
                              ┌────────────┴────────────┐
                              │                         │
                    ┌─────────▼─────────┐   ┌──────────▼──────────┐
                    │   DNS / CDN       │   │   Load Balancer     │
                    │   (Cloudflare)    │   │   (Nginx/HAProxy)   │
                    └───────────────────┘   └──────────┬──────────┘
                                                        │
                        ┌───────────────────────────────┴─────────────────┐
                        │                                               │
            ┌───────────▼───────────┐                   ┌──────────────▼─────────────┐
            │   Web Server 1        │                   │   Web Server 2            │
            │   ┌────────────────┐   │                   │   ┌────────────────┐      │
            │   │ Nginx          │   │                   │   │ Nginx          │      │
            │   │ - Vue static   │   │                   │   │ - Vue static   │      │
            │   │ - Reverse proxy│   │                   │   │ - Reverse proxy│      │
            │   └───────┬────────┘   │                   │   └───────┬────────┘      │
            │           │            │                   │           │               │
            │   ┌───────▼────────┐   │                   │   ┌───────▼────────┐      │
            │   │ Gunicorn       │   │                   │   │ Gunicorn       │      │
            │   │ - Django (x4)  │   │                   │   │ - Django (x4)  │      │
            │   └────────────────┘   │                   │   └────────────────┘      │
            └───────────────────────┘                   └───────────────────────────┘
                        │                                               │
                        └───────────────────────┬───────────────────────┘
                                                │
            ┌───────────────────────────────────┴───────────────────────────┐
            │                   Shared Services                             │
            │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
            │  │   MySQL      │  │   Redis      │  │   RabbitMQ   │       │
            │  │   Master     │  │   Cluster    │  │   (Celery)   │       │
            │  └──────┬───────┘  └──────────────┘  └──────┬───────┘       │
            │         │                                      │               │
            │  ┌──────▼───────┐                    ┌─────────▼─────────┐   │
            │  │   MySQL      │                    │   Celery Workers   │   │
            │  │   Slave      │                    │  - Task Executor   │   │
            │  │   (Read)     │                    │  - Scheduler       │   │
            │  └──────────────┘                    │  - Beat Worker     │   │
            │                                      └────────────────────┘   │
            └───────────────────────────────────────────────────────────────┘
                        │
                        │
            ┌───────────▼────────────┐
            │   External Services    │
            │  ┌──────────────────┐  │
            │  │ AI APIs           │  │
            │  │ - DeepSeek        │  │
            │  │ - Qwen            │  │
            │  │ - SiliconFlow     │  │
            │  └──────────────────┘  │
            │  ┌──────────────────┐  │
            │  │ Storage (OSS)    │  │
            │  │ - Uploads        │  │
            │  │ - Reports        │  │
            │  └──────────────────┘  │
            └───────────────────────┘
```

### 4.2 网络架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        DMZ (Demilitarized Zone)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  Firewall    │  │  Load        │  │  WAF         │         │
│  │  (External)  │→ │  Balancer    │→ │  (Web App    │         │
│  └──────────────┘  └──────────────┘  │   Firewall)  │         │
│                                     └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Application Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  Web Server  │  │  Web Server  │  │  Web Server  │         │
│  │  (Nginx)     │  │  (Nginx)     │  │  (Nginx)     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│         │                 │                 │                 │
│  ┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐         │
│  │  Django App  │  │  Django App  │  │  Django App  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Data Layer (Private Network)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  MySQL       │  │  Redis       │  │  RabbitMQ    │         │
│  │  Master      │  │  Cluster     │  │  (Celery)    │         │
│  └──────┬───────┘  └──────────────┘  └──────────────┘         │
│         │                                                             │
│  ┌──────▼───────┐                                                      │
│  │  MySQL       │                                                      │
│  │  Slave       │                                                      │
│  └──────────────┘                                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 安全架构

### 5.1 认证授权流程

```
┌──────────────┐
│    Client    │
└──────┬───────┘
       │ 1. Request without token
       ▼
┌──────────────────┐
│   API Gateway    │
│  ┌────────────┐  │
│  │  Auth      │  │
│  │  Filter    │  │
│  └─────┬──────┘  │
└────────┼─────────┘
         │ No token found
         ▼
┌──────────────────┐
│  Return 401      │
│  Unauthorized    │
└──────────────────┘

       OR (with token)

┌──────────────┐
│    Client    │
└──────┬───────┘
       │ 2. Request with Authorization: Bearer <token>
       ▼
┌──────────────────┐
│   API Gateway    │
│  ┌────────────┐  │
│  │  JWT       │  │
│  │  Validator │  │
│  └─────┬──────┘  │
└────────┼─────────┘
         │ Validate
         ▼
┌──────────────────┐     ┌──────────────┐
│  Valid Token     │────→│  Allow       │
│  - Check sig     │     │  Request     │
│  - Check exp     │     └──────────────┘
│  - Check user    │
└──────────────────┘
         │
         │ OR Invalid
         ▼
┌──────────────────┐
│  Return 401/403  │
└──────────────────┘
```

### 5.2 数据加密

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据加密策略                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 传输层加密:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  HTTPS/TLS 1.3                                          │   │
│  │  - SSL Certificate                                      │   │
│  │  - End-to-end encryption                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│ 存储加密:                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Password: BCrypt (cost=12)                             │   │
│  │  ┌──────────────────────────────────────────┐           │   │
│  │  │  Plain → BCrypt Hash → Store            │           │   │
│  │  │  "password123" → "$2b$12$..."          │           │   │
│  │  └──────────────────────────────────────────┘           │   │
│  │                                                          │   │
│  │  API Keys: AES-256-GCM                                  │   │
│  │  ┌──────────────────────────────────────────┐           │   │
│  │  │  Plain → Encrypt → Store                 │           │   │
│  │  │  "sk-123456" → "encrypted_base64"       │           │   │
│  │  └──────────────────────────────────────────┘           │   │
│  │                                                          │   │
│  │  Files: At rest encryption (optional)                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│ Token安全:                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Access Token (Short-lived: 30min)                      │   │
│  │  Refresh Token (Long-lived: 7days, httpOnly, secure)    │   │
│  │  Token Blacklist (Redis)                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 扩展性架构

### 6.1 插件系统设计

```
┌─────────────────────────────────────────────────────────────────┐
│                       TestHub Core                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  User Mgmt   │  │  Project     │  │  TestCase    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ▼                ▼                ▼
┌────────────────┐ ┌────────────────┐ ┌────────────────┐
│ Plugin Manager │ │ Hook System    │ │ Event Bus      │
│                │ │                │ │                │
│ - Load         │ │ - before_test  │ │ - test_created │
│ - Unload       │ │ - after_test   │ │ - test_updated │
│ - Register     │ │ - on_error     │ │ - test_deleted │
└────────────────┘ └────────────────┘ └────────────────┘
         │
         │ Available Plugins
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Plugin Ecosystem                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Notification │  │   Report     │  │   Auth       │         │
│  │ - Email      │  │ - Custom     │  │ - LDAP       │         │
│  │ - Slack     │  │ - PDF        │  │ - SAML       │         │
│  │ - DingTalk  │  │ - Excel      │  │ - OAuth      │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │    CI/CD     │  │  Integration │  │  Storage     │         │
│  │ - Jenkins    │  │ - JIRA       │  │ - S3         │         │
│  │ - GitLab CI  │  │ - GitHub     │  │ - OSS        │         │
│  │ - GitHub     │  │ - GitLab     │  │ - MinIO      │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 附录：技术选型对比

### A.1 Web框架对比

| 特性 | Django | Flask | FastAPI |
|------|--------|-------|---------|
| ORM | ✅ 内置 | ❌ 需扩展 | ❌ 需扩展 |
| Admin | ✅ 强大 | ❌ 需扩展 | ❌ 需扩展 |
| 认证 | ✅ 完善 | ⚠️ 基础 | ⚠️ 基础 |
| 异步 | ⚠️ 有限 | ✅ 支持 | ✅ 原生 |
| 生态 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| 学习曲线 | 中 | 低 | 中 |

**选择Django原因：** 企业级项目需要完整的ORM、强大的Admin后台、完善的认证系统

### A.2 前端框架对比

| 特性 | Vue 3 | React | Angular |
|------|-------|-------|---------|
| 学习曲线 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 性能 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 生态 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 组件库 | Element Plus | Material-UI | Material |
| 状态管理 | Pinia | Redux/MobX | NgRx |

**选择Vue 3原因：** 团队熟悉、Element Plus组件库完善、上手快、开发效率高

### A.3 测试框架对比

| 框架 | 语言 | 优势 | 劣势 |
|------|------|------|------|
| Selenium | 多语言 | 生态成熟、文档全 | 速度慢、API复杂 |
| Playwright | 多语言 | 现代化、快速、API友好 | 相对较新 |
| Playwright | 多语言 | 速度快、Python友好 | 移动端支持弱 |
| Cypress | JS | 开发者体验好 | 仅支持JS |

**选择Selenium + Playwright：** Selenium稳定、Playwright现代，双引擎支持

---

**文档版本：** v1.0
**最后更新：** 2026-02-28
**维护团队：** TestHub 架构组
